{% extends "base.html" %}
{% block title %}講師ダッシュボード | 塾講師サイト{% endblock %}
{% block head_extra %}
<style>
  .dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .dashboard-header {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
  }
  
  .dashboard-title {
    color: #333;
    margin-bottom: 10px;
    font-size: 24px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .stat-label {
    color: #666;
    font-size: 14px;
    margin-bottom: 5px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
  }
  
  .functions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .function-link {
    display: block;
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    text-decoration: none;
    color: #333;
    transition: all 0.3s ease;
    text-align: center;
  }
  
  .function-link:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-decoration: none;
    color: #333;
  }
  
  .function-icon {
    font-size: 32px;
    color: #4361ee;
    margin-bottom: 10px;
  }
  
  .function-title {
    font-weight: 600;
    margin-bottom: 5px;
  }
  
  .function-desc {
    font-size: 12px;
    color: #666;
  }
  
  .students-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }
  
  .students-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .students-title {
    font-size: 20px;
    color: #333;
    margin: 0;
  }
  
  .search-input {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 200px;
  }
  
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .tab {
    padding: 8px 16px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  
  .tab:hover {
    background: #e9ecef;
  }
  
  .tab.active {
    background: #4361ee;
    color: white;
    border-color: #4361ee;
  }
  
  .students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
  }
  
  .student-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
  }
  
  .student-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .student-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
  }
  
  .student-grade {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
  }
  
  .student-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 4px;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
  }
  
  .btn-primary {
    background: #4361ee;
    color: white;
  }
  
  .btn-primary:hover {
    background: #3a0ca3;
    color: white;
    text-decoration: none;
  }
  
  .btn-secondary {
    background: #6c757d;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #545b62;
    color: white;
    text-decoration: none;
  }
    --text-primary: #ffffff !important;
    --text-secondary: #b0b0c0 !important;
    --text-muted: #808090 !important;
    --glow-shadow: 0 0 20px !important;
    --holographic: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff) !important;
    --grid-pattern: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 255, 255, 0.03) 2px,
      rgba(0, 255, 255, 0.03) 4px
    ) !important;
  }
  
  /* ベースレイアウト - 近未来的な背景 */
  html {
    height: 100% !important;
    overflow: hidden !important;
  }
  
  body {
    background: var(--dark-bg) !important;
    font-family: 'Orbitron', 'Rajdhani', 'Inter', system-ui, sans-serif !important;
    color: var(--text-primary) !important;
    position: relative !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    min-height: 100vh !important;
  }
  
  body::before {
    content: '' !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: var(--grid-pattern) !important;
    pointer-events: none !important;
    z-index: 1 !important;
  }
  
  /* アニメーション背景パーティクル - 無効化（自動スクロール防止） */
  /*
  @keyframes float {
    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
  }
  
  .particle {
    position: fixed !important;
    width: 2px !important;
    height: 2px !important;
    background: var(--cyber-primary) !important;
    box-shadow: 0 0 10px var(--cyber-primary) !important;
    animation: float 20s infinite !important;
    z-index: 1 !important;
  }
  */
  
  /* ダッシュボードラッパー */
  .dashboard-wrapper {
    max-width: 1600px !important;
    margin: 0 auto !important;
    padding: 20px !important;
    position: relative !important;
    z-index: 1000 !important;
    background: transparent !important;
    width: 100% !important;
    height: 100vh !important;
    overflow-y: auto !important; /* スクロール可能に設定 */
    display: block !important;
    visibility: visible !important;
  }
  
  /* 近未来的なヘッダー */
  .dashboard-header {
    background: linear-gradient(135deg, var(--glass-bg) 0%, rgba(0, 255, 255, 0.1) 100%) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid var(--glass-border) !important;
    border-radius: 20px !important;
    padding: 30px !important;
    margin-bottom: 30px !important;
    position: relative !important;
    overflow: hidden !important;
    color: var(--text-primary) !important;
  }
  
  .dashboard-header::before {
    content: '' !important;
    position: absolute !important;
    top: -2px !important;
    left: -2px !important;
    right: -2px !important;
    bottom: -2px !important;
    background: var(--holographic) !important;
    border-radius: 20px !important;
    opacity: 0.5 !important;
    z-index: -1 !important;
    /* animation: holographicShift 3s ease-in-out infinite !important; /* 無効化（自動スクロール防止） */
  }
  
  /* 無効化（自動スクロール防止）: holographicShift animation
  @keyframes holographicShift {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.7; }
  }
  */
  
  .gradient-title {
    font-size: 36px !important;
    font-weight: 700 !important;
    background: linear-gradient(90deg, var(--cyber-primary), var(--cyber-secondary), var(--cyber-primary)) !important;
    background-size: 200% auto !important;
    background-clip: text !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    /* animation: shimmer 3s linear infinite !important; /* 無効化（自動スクロール防止） */
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    margin: 0 0 10px 0 !important;
    text-transform: uppercase !important;
    letter-spacing: 2px !important;
  }
  
  /* 無効化（自動スクロール防止）: shimmer animation
  @keyframes shimmer {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }
  */
  
  .gradient-icon {
    color: var(--cyber-primary) !important;
    filter: drop-shadow(0 0 10px var(--cyber-primary)) !important;
  }
  
  .welcome-message {
    color: var(--text-secondary) !important;
    font-size: 16px !important;
    letter-spacing: 0.5px !important;
  }
  
  /* 統計カード - ホログラフィック効果 */
  .stats-overview {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
    gap: 20px !important;
    margin-bottom: 40px !important;
  }
  
  .stat-card {
    background: var(--glass-bg) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid var(--glass-border) !important;
    border-radius: 15px !important;
    padding: 25px !important;
    position: relative !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
  }
  
  .stat-card::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 100% !important;
    background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 255, 0.1) 100%) !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
  }
  
  /* 無効化（自動スクロール防止）: stat-card hover effects
  .stat-card:hover::before {
    opacity: 1 !important;
  }
  
  .stat-card:hover {
    transform: translateY(-5px) !important;
    border-color: var(--cyber-primary) !important;
    box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3) !important;
  }
  */
  
  .stat-icon {
    width: 60px !important;
    height: 60px !important;
    border-radius: 15px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 24px !important;
    margin-bottom: 15px !important;
    position: relative !important;
  }
  
  .stat-card.primary .stat-icon {
    background: linear-gradient(135deg, var(--cyber-primary), var(--neon-blue)) !important;
    box-shadow: var(--glow-shadow) rgba(0, 255, 255, 0.5) !important;
  }
  
  .stat-card.warning .stat-icon {
    background: linear-gradient(135deg, var(--cyber-accent), var(--neon-green)) !important;
    box-shadow: var(--glow-shadow) rgba(255, 255, 0, 0.5) !important;
  }
  
  .stat-card.success .stat-icon {
    background: linear-gradient(135deg, var(--neon-green), var(--cyber-primary)) !important;
    box-shadow: var(--glow-shadow) rgba(0, 255, 136, 0.5) !important;
  }
  
  .stat-card.info .stat-icon {
    background: linear-gradient(135deg, var(--neon-pink), var(--cyber-secondary)) !important;
    box-shadow: var(--glow-shadow) rgba(255, 0, 255, 0.5) !important;
  }
  
  .stat-label {
    font-size: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    color: var(--text-secondary) !important;
    margin-bottom: 5px !important;
  }
  
  .stat-value {
    font-size: 32px !important;
    font-weight: 700 !important;
    color: var(--text-primary) !important;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
    margin-bottom: 10px !important;
  }
  
  .stat-trend {
    font-size: 13px !important;
    font-weight: 500 !important;
    padding: 5px 10px !important;
    border-radius: 20px !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 5px !important;
  }
  
  .trend-up {
    background: rgba(0, 255, 136, 0.2) !important;
    color: var(--neon-green) !important;
    border: 1px solid rgba(0, 255, 136, 0.3) !important;
  }
  
  .trend-down {
    background: rgba(255, 0, 128, 0.2) !important;
    color: var(--neon-pink) !important;
    border: 1px solid rgba(255, 0, 128, 0.3) !important;
  }
  
  /* タブナビゲーション - ネオンスタイル */
  .grade-tabs-container, .day-tabs-container {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
  }
  
  .grade-tabs, .day-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .grade-tab, .day-tab {
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }
  
  .grade-tab::before, .day-tab::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: radial-gradient(circle, var(--cyber-primary) 0%, transparent 70%);
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
  }
  
  /* 無効化（自動スクロール防止）: grade-tab and day-tab hover effects
  .grade-tab:hover::before, .day-tab:hover::before {
    width: 100px;
    height: 100px;
  }
  
  .grade-tab:hover, .day-tab:hover {
    color: var(--text-primary);
    transform: translateY(-2px);
  }
  */
  
  .grade-tab.active, .day-tab.active {
    background: linear-gradient(135deg, var(--cyber-primary), var(--neon-blue));
    color: var(--dark-bg);
    font-weight: 600;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    border: none;
  }
  
  .day-tab.today {
    background: linear-gradient(135deg, var(--cyber-accent), var(--neon-green));
    color: var(--dark-bg);
    box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
  }
  
  /* メインコンテンツエリア */
  .main-content-area {
    background: var(--glass-bg) !important;
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border) !important;
    border-radius: 20px !important;
    padding: 30px !important;
    margin-bottom: 30px !important;
    color: var(--text-primary) !important;
    display: block !important;
    visibility: visible !important;
    position: relative !important;
    z-index: 100 !important;
    width: 100% !important;
    min-height: auto !important;
  }
  
  .students-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 30px !important;
    padding-bottom: 20px !important;
    border-bottom: 1px solid var(--glass-border) !important;
  }
  
  .students-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  /* 検索機能 - ネオンスタイル */
  .search-filter {
    position: relative;
    width: 100%;
    max-width: 400px;
  }
  
  .search-input {
    width: 100%;
    padding: 12px 20px 12px 45px;
    border-radius: 25px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.3s ease;
  }
  
  .search-input:focus {
    border-color: var(--cyber-primary);
    box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(0, 255, 255, 0.1);
    outline: none;
  }
  
  .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--cyber-primary);
  }
  
  /* 生徒カード - 3D効果とホログラム */
  .student-list {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
    gap: 25px !important;
    margin-bottom: 30px;
  }
  
  .student-card {
    background: var(--glass-bg) !important;
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border) !important;
    border-radius: 15px !important;
    padding: 25px !important;
    transition: all 0.3s ease !important;
    position: relative;
    overflow: hidden;
    transform-style: preserve-3d;
    perspective: 1000px;
    color: var(--text-primary) !important;
  }
  
  .student-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg at 50% 50%,
      transparent 0deg,
      var(--cyber-primary) 60deg,
      transparent 120deg
    );
    /* animation: rotate 10s linear infinite; /* 無効化（自動スクロール防止） */
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  /* 回転アニメーション - 無効化（自動スクロール防止）
  @keyframes rotate {
    100% { transform: rotate(360deg); }
  }
  */
  
  /* 無効化（自動スクロール防止）: student-card hover effects
  .student-card:hover::before {
    opacity: 0.1;
  }
  
  .student-card:hover {
    transform: translateY(-5px) translateZ(20px);
    border-color: var(--cyber-primary);
    box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3);
  }
  */
  
  .student-card.class-day {
    border-color: var(--neon-green);
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, var(--glass-bg) 100%);
  }
  
  .student-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--glass-border);
  }
  
  .student-name {
    font-weight: 600;
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .student-grade {
    color: var(--cyber-primary);
    font-size: 13px;
    display: inline-block;
    padding: 4px 12px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 20px;
    margin-top: 8px;
  }
  
  /* ステータスインジケーター - ネオンエフェクト */
  .student-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    border: 1px solid var(--glass-border);
  }
  
  .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    position: relative;
  }
  
  .status-indicator.status-online {
    background: var(--neon-green);
    box-shadow: 0 0 10px var(--neon-green);
    /* animation: pulse-neon 2s infinite; /* 無効化（自動スクロール防止） */
  }
  
  .status-indicator.status-today {
    background: var(--cyber-accent);
    box-shadow: 0 0 10px var(--cyber-accent);
    /* animation: pulse-neon 2s infinite; /* 無効化（自動スクロール防止） */
  }
  
  .status-indicator.status-offline {
    background: var(--text-muted);
  }
  
  /* ステータスインジケーターのアニメーション無効化（自動スクロール防止）
  @keyframes pulse-neon {
    0% { box-shadow: 0 0 5px currentColor; }
    50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    100% { box-shadow: 0 0 5px currentColor; }
  }
  */
  
  /* アクションボタン - サイバーパンクスタイル */
  .student-actions {
    display: flex;
    gap: 15px;
    margin-top: auto;
    padding-top: 15px;
  }
  
  .student-action-btn {
    flex: 1;
    padding: 12px 15px;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .attendance-btn {
    background: linear-gradient(135deg, var(--cyber-primary), var(--neon-blue));
    color: var(--dark-bg);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
  }
  
  /* 無効化（自動スクロール防止）: attendance-btn hover effect
  .attendance-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 30px rgba(0, 255, 255, 0.5);
  }
  */
  
  .detail-btn {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    border: 1px solid var(--glass-border);
  }
  
  /* 無効化（自動スクロール防止）: detail-btn hover effect
  .detail-btn:hover {
    background: linear-gradient(135deg, var(--cyber-secondary), var(--neon-pink));
    color: var(--dark-bg);
    border: none;
    box-shadow: 0 5px 30px rgba(255, 0, 255, 0.5);
  }
  */
  
  /* グレード向上フィルター - 近未来UI */
  .grade-improvement-filters {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    position: relative;
  }
  
  .modern-filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    padding: 5px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    width: fit-content;
  }
  
  .filter-tab {
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
    background: transparent;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .filter-tab:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .filter-tab.active {
    background: linear-gradient(135deg, var(--cyber-primary), var(--neon-blue));
    color: var(--dark-bg);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  }
  
  /* フォーム要素 - 近未来スタイル */
  .modern-form-control {
    padding: 12px 15px;
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    transition: all 0.3s ease;
  }
  
  .modern-form-control:focus {
    border-color: var(--cyber-primary);
    box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
    outline: none;
  }
  
  /* パネル - ホログラフィック効果 */
  .activity-panel, .functions-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
  }
  
  .panel-header {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 25px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .panel-header-left {
    display: flex;
    align-items: center;
  }
  
  .panel-header-icon {
    margin-right: 10px;
    font-size: 24px;
    color: var(--cyber-primary);
    filter: drop-shadow(0 0 5px var(--cyber-primary));
  }
  
  /* テーマ切り替えボタン */
  .theme-toggle-btn {
    background: linear-gradient(135deg, var(--glass-bg), rgba(255, 255, 255, 0.1));
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--cyber-primary);
    position: relative;
    overflow: hidden;
  }
  
  .theme-toggle-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--cyber-primary), var(--neon-pink));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  /* 無効化（自動スクロール防止）: theme-toggle-btn hover effects
  .theme-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  }
  
  .theme-toggle-btn:hover::before {
    opacity: 0.1;
  }
  */
  
  .theme-toggle-btn i {
    position: relative;
    z-index: 1;
    font-size: 18px;
    transition: all 0.3s ease;
  }
  
  /* 無効化（自動スクロール防止）: theme-toggle-btn icon hover effect
  .theme-toggle-btn:hover i {
    color: white;
    filter: drop-shadow(0 0 5px currentColor);
  }
  */
  
  /* ダークモード時のスタイル */
  body.dark-mode .theme-toggle-btn i::before {
    content: '\f185'; /* sun icon */
  }
  
  /* ライトモード時の追加スタイル */
  body.light-mode {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
    color: #333 !important;
  }
  
  body.light-mode .dashboard-container {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
  }
  
  body.light-mode .header {
    background: rgba(255, 255, 255, 0.9) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .header h1 {
    color: #333 !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .panel {
    background: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .panel-header h2 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link {
    background: rgba(255, 255, 255, 0.7) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .quick-link:hover {
    background: rgba(255, 255, 255, 0.9) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .quick-link h3 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link p {
    color: #666 !important;
  }
  
  body.light-mode .quick-link .icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }
  
  body.light-mode .header {
    background: rgba(255, 255, 255, 0.9) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .header h1 {
    color: #333 !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .panel {
    background: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .panel-header h2 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link {
    background: rgba(255, 255, 255, 0.7) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .quick-link:hover {
    background: rgba(255, 255, 255, 0.9) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .quick-link h3 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link p {
    color: #666 !important;
  }
  
  body.light-mode .quick-link .icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }
</style>

<!-- パーティクル効果用のスクリプト -->
<script>
  // 既存のスタイルシートを無効化
  document.addEventListener('DOMContentLoaded', function() {
    console.log('近未来的テーマを適用中...');
    
    // 既存のスタイルシートを削除
    const styleSheets = document.querySelectorAll('link[rel="stylesheet"]');
    styleSheets.forEach(sheet => {
      if (sheet.href && (sheet.href.includes('style.css') || sheet.href.includes('modern-style.css'))) {
        console.log('既存スタイルシートを無効化:', sheet.href);
        sheet.disabled = true;
        sheet.remove();
      }
    });
    
    // bodyのクラスをすべて削除
    document.body.className = '';
    document.body.style.cssText = 'background: #0a0a0f !important; color: #ffffff !important; margin: 0 !important; padding: 0 !important; min-height: 100vh !important;';
    
    // 近未来テーマの確認を遅延実行
    setTimeout(() => {
      const futuristicTheme = document.querySelector('.futuristic-theme');
      const dashboardWrapper = document.querySelector('.dashboard-wrapper');
      
      if (futuristicTheme) {
        console.log('近未来的テーマが正常に適用されました');
        // 追加の初期化処理
        initializeThemeEffects();
      } else if (dashboardWrapper) {
        // クラスが不足している場合は手動で追加
        dashboardWrapper.classList.add('futuristic-theme');
        console.log('近未来的テーマクラスを手動で追加しました');
        initializeThemeEffects();
      } else {
        console.warn('ダッシュボード要素が見つかりません');
      }
    }, 100);
  });
  
  // テーマエフェクトの初期化
  function initializeThemeEffects() {
    // 動的CSSの追加
    addDynamicCSS();
    
    // コンテンツ要素の確認とデバッグ
    const dashboardWrapper = document.querySelector('.dashboard-wrapper');
    const mainContentArea = document.querySelector('.main-content-area');
    const dashboardHeader = document.querySelector('.dashboard-header');
    
    console.log('ダッシュボード要素の状態:');
    console.log('dashboard-wrapper:', dashboardWrapper ? '存在' : '不存在', dashboardWrapper);
    console.log('main-content-area:', mainContentArea ? '存在' : '不存在', mainContentArea);
    console.log('dashboard-header:', dashboardHeader ? '存在' : '不存在', dashboardHeader);
    
    if (dashboardWrapper) {
      const computedStyle = window.getComputedStyle(dashboardWrapper);
      console.log('dashboard-wrapper CSS:', {
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        opacity: computedStyle.opacity,
        zIndex: computedStyle.zIndex,
        position: computedStyle.position
      });
    }
    
    // グラデーション要素の確認
    const gradientElements = document.querySelectorAll('.gradient-title, .stat-card, .dashboard-header');
    if (gradientElements.length > 0) {
      console.log(`${gradientElements.length}個のテーマ要素が検出されました`);
    }
    
    // パーティクル効果の生成 - 無効化（自動スクロール防止）
    // createParticles();
  }
  
  // 動的CSS追加関数
  function addDynamicCSS() {
    const style = document.createElement('style');
    style.textContent = `
      @keyframes float {
        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
      }
      
      .particle {
        position: fixed !important;
        width: 2px !important;
        height: 2px !important;
        background: #00ffff !important;
        box-shadow: 0 0 10px #00ffff !important;
        /* animation: float 20s linear infinite !important; /* 無効化（自動スクロール防止） */
        z-index: 1 !important;
        pointer-events: none !important;
      }
      
      .futuristic-theme {
        background: #0a0a0f !important;
        color: #ffffff !important;
        min-height: 100vh !important;
      }
      
      /* 緊急コンテンツ表示修正 - 最高優先度 */
      body, html {
        background: #0a0a0f !important;
        color: #ffffff !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .container,
      body > .container,
      .main-content,
      body > .container > .main-content {
        display: block !important;
        visibility: visible !important;
        position: relative !important;
        opacity: 1 !important;
        z-index: auto !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        background: transparent !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* デバッグ用: 全ての主要コンテンツを確実に表示 */
      .dashboard-wrapper,
      .main-content-area,
      .dashboard-header,
      .stats-overview,
      .stat-card,
      .gradient-title,
      .welcome-message,
      .stat-label,
      .stat-value {
        display: block !important;
        visibility: visible !important;
        position: relative !important;
        z-index: auto !important;
        opacity: 1 !important;
        color: #ffffff !important;
      }
      
      /* テキストの確実な表示 */
      * {
        color: inherit !important;
      }
      
      .gradient-title {
        background: linear-gradient(90deg, #00ffff, #ff00ff, #00ffff) !important;
        background-clip: text !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
      }
    `;
    document.head.appendChild(style);
    console.log('動的CSSが追加されました');
    
    // 強制的に要素を表示する追加処理
    setTimeout(() => {
      const elements = document.querySelectorAll('.container, .main-content, .dashboard-wrapper, .main-content-area');
      elements.forEach(el => {
        if (el) {
          el.style.display = 'block';
          el.style.visibility = 'visible';
          el.style.opacity = '1';
          console.log('要素を強制表示:', el.className);
        }
      });
    }, 100);
  }
  
  // パーティクル生成 - 無効化（自動スクロール防止）
  function createParticles() {
    // パーティクル生成を無効化して自動スクロールを防止
    try {
      console.log('パーティクル効果は無効化されています（自動スクロール防止のため）');
      return;
    } catch (error) {
      console.error('パーティクル生成エラー:', error);
    }
  }
</script>
{% endblock %}

{% block content %}

<div class="dashboard-wrapper futuristic-theme">
  <div class="main-content-area">
    <!-- ダッシュボードヘッダー -->
    <div class="dashboard-header" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(0, 255, 255, 0.1) 100%) !important; backdrop-filter: blur(10px) !important;">
      <h2 class="gradient-title" style="background: linear-gradient(90deg, #00ffff, #ff00ff, #00ffff) !important; background-clip: text !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important;">
        <i class="fas fa-tachometer-alt gradient-icon" style="color: #00ffff !important;"></i>
        講師ダッシュボード
      </h2>
      <p class="welcome-message" style="color: #b0b0c0 !important;">こんにちは、{{ name }}先生。今日も生徒たちの成長をサポートしましょう。</p>
    </div>

    <!-- 統計概要 -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">登録生徒数</div>
          <div class="stat-value">{{ student_count }}</div>
          <div class="stat-trend trend-up">
            <span class="trend-icon">↗</span>
            <span>先月比 3人増</span>
          </div>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">今月の模試</div>
          <div class="stat-value">2</div>
          <div class="stat-trend">
            <span>次回：5/20</span>
          </div>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">出席率</div>
          <div class="stat-value">94%</div>
          <div class="stat-trend trend-up">
            <span class="trend-icon">↗</span>
            <span>先週比 2%増</span>
          </div>
        </div>
      </div>

      <div class="stat-card info">
        <div class="stat-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">新規登録</div>
          <div class="stat-value">3</div>
          <div class="stat-trend">
            <span>今月</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 成績向上フィルタ -->
    <div class="grade-improvement-filters">
      <div class="card-header">
        <h4 class="section-title">
          <i class="fas fa-filter"></i>
          成績向上フィルタ
        </h4>
      </div>
      <div class="card-content">
        <!-- フィルタタブ -->
        <div class="modern-filter-tabs">
          <div class="filter-tab active" data-filter="elementary">
            <i class="fas fa-child"></i>
            <span>小学生成績</span>
          </div>
          <div class="filter-tab" data-filter="middle">
            <i class="fas fa-graduation-cap"></i>
            <span>中学生内申</span>
          </div>
        </div>
        
        <!-- 小学生フィルタ -->
        <div id="elementary-filter" class="filter-panel active">
          <div class="modern-form-row">
            <div class="modern-form-group">
              <label class="modern-form-label">
                <i class="fas fa-calendar-alt"></i>
                開始月
              </label>
              <select id="elementary-start-month" class="modern-form-control">
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">
                <i class="fas fa-calendar-check"></i>
                終了月
              </label>
              <select id="elementary-end-month" class="modern-form-control">
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">科目</label>
              <select id="elementary-subject" class="modern-form-control">
                <option value="all">全科目</option>
                <option value="1">国語</option>
                <option value="2">算数</option>
                <option value="3">英語</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">最小向上点数</label>
              <select id="elementary-min-improvement" class="modern-form-control">
                <option value="0">全て表示</option>
                <option value="5">5点以上</option>
                <option value="10">10点以上</option>
                <option value="15">15点以上</option>
              </select>
            </div>
            <div class="modern-form-group">
              <button id="elementary-filter-btn" class="btn btn-primary">フィルタ適用</button>
            </div>
          </div>
        </div>
        
        <!-- 中学生フィルタ -->
        <div id="middle-filter" class="filter-panel">
          <div class="modern-form-row">
            <div class="modern-form-group">
              <label class="modern-form-label">開始年</label>
              <select id="middle-start-year" class="modern-form-control">
                <option value="1">1年</option>
                <option value="2">2年</option>
                <option value="3">3年</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">開始学期</label>
              <select id="middle-start-term" class="modern-form-control">
                <option value="1">1学期</option>
                <option value="2">2学期</option>
                <option value="3">3学期</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">終了年</label>
              <select id="middle-end-year" class="modern-form-control">
                <option value="1">1年</option>
                <option value="2">2年</option>
                <option value="3">3年</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">終了学期</label>
              <select id="middle-end-term" class="modern-form-control">
                <option value="1">1学期</option>
                <option value="2">2学期</option>
                <option value="3">3学期</option>
              </select>
            </div>
            <div class="modern-form-group">
              <label class="modern-form-label">科目</label>
              <select id="middle-subject" class="modern-form-control">
                <option value="all">全科目</option>
                <option value="1">国語</option>
                <option value="2">数学</option>
                <option value="3">英語</option>
                <option value="4">理科</option>
                <option value="5">社会</option>
                <option value="6">音楽</option>
                <option value="7">美術</option>
                <option value="8">保体</option>
                <option value="9">技家</option>
              </select>
            </div>
            <div class="modern-form-group">
              <button id="middle-filter-btn" class="btn btn-primary">フィルタ適用</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- グラフと分析 -->
    <div class="analytics-panel">
      <h4 class="analytics-title">学習状況分析</h4>
      <div class="charts-row">
        <div class="chart-container">
          <div class="chart-header">
            <h5 class="chart-title">学年別出席率</h5>
            <span class="chart-period">直近30日間</span>
          </div>
          <div class="chart-placeholder" style="flex-grow: 1; display: flex; justify-content: center; align-items: center; background: rgba(0, 255, 255, 0.05); border-radius: 10px; border: 1px solid rgba(0, 255, 255, 0.2);">
            <p style="color: var(--cyber-primary); font-size: 14px;">出席率グラフが表示されます</p>
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-header">
            <h5 class="chart-title">模試平均点推移</h5>
            <span class="chart-period">過去6回分</span>
          </div>
          <div class="chart-placeholder" style="flex-grow: 1; display: flex; justify-content: center; align-items: center; background: rgba(255, 0, 255, 0.05); border-radius: 10px; border: 1px solid rgba(255, 0, 255, 0.2);">
            <p style="color: var(--cyber-secondary); font-size: 14px;">模試スコアグラフが表示されます</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 生徒一覧 -->
    <div class="students-panel">
      <div class="students-header">
        <h4 class="students-title">学年別生徒管理</h4>
        <div style="display: flex; gap: 15px; align-items: center;">
          <button id="grade-schedule-btn" class="btn btn-outline-primary">学年別曜日設定</button>
          <div class="search-filter">
            <span class="search-icon">🔍</span>
            <input type="text" class="search-input" placeholder="生徒を検索..." id="student-search">
          </div>
        </div>
      </div>
      
      <div class="grade-tabs-container">
        <div class="grade-tabs">
          <div class="grade-tab active" data-grade="all">全学年</div>
          <div class="grade-tab" data-grade="elementary">小学生</div>
          <div class="grade-tab" data-grade="middle">中学生</div>
          <div class="grade-tab" data-grade="high">高校生</div>
          <div class="grade-tab" data-grade="unset">未設定</div>
          <!-- 小学生の学年 -->
          <div class="grade-tab elementary-grade" data-grade="elementary-1">小1</div>
          <div class="grade-tab elementary-grade" data-grade="elementary-2">小2</div>
          <div class="grade-tab elementary-grade" data-grade="elementary-3">小3</div>
          <div class="grade-tab elementary-grade" data-grade="elementary-4">小4</div>
          <div class="grade-tab elementary-grade" data-grade="elementary-5">小5</div>
          <div class="grade-tab elementary-grade" data-grade="elementary-6">小6</div>
          <!-- 中学生の学年 -->
          <div class="grade-tab middle-grade" data-grade="middle-1">中1</div>
          <div class="grade-tab middle-grade" data-grade="middle-2">中2</div>
          <div class="grade-tab middle-grade" data-grade="middle-3">中3</div>
          <!-- 高校生の学年 -->
          <div class="grade-tab high-grade" data-grade="high-1">高1</div>
          <div class="grade-tab high-grade" data-grade="high-2">高2</div>
          <div class="grade-tab high-grade" data-grade="high-3">高3</div>
        </div>
      </div>
      
      <!-- 曜日タブ -->
      <div class="day-tabs-container">
        <div class="day-tabs">
          <div class="day-tab active" data-day="all">全曜日</div>
          <div class="day-tab" data-day="0">日曜日</div>
          <div class="day-tab" data-day="1">月曜日</div>
          <div class="day-tab" data-day="2">火曜日</div>
          <div class="day-tab" data-day="3">水曜日</div>
          <div class="day-tab" data-day="4">木曜日</div>
          <div class="day-tab" data-day="5">金曜日</div>
          <div class="day-tab" data-day="6">土曜日</div>
          <div class="day-tab" data-day="today">本日</div>
        </div>
      </div>
      
      <div class="student-list students-grid" id="student-list">
        <!-- 生徒カードは動的に生成されます -->
      </div>
      
      <div class="attendance-footer">
        <button id="attendance-check-btn" class="btn btn-primary">一括出席確認</button>
      </div>
    </div>
  </div>
  
  <div class="side-panels">
    <!-- 最近の活動 -->
    <div class="activity-panel">
      <h4 class="panel-header">
        <span class="panel-header-icon">📋</span>
        最近の活動
      </h4>
      <ul class="activity-list">
        <li class="activity-item">
          <div class="activity-content">高校情報「横浜翠嵐高校」が更新されました</div>
          <div class="activity-date">2025-05-05 14:23</div>
        </li>
        <li class="activity-item">
          <div class="activity-content">新しいお知らせが登録されました：「6月の模試について」</div>
          <div class="activity-date">2025-05-03 09:15</div>
        </li>
        <li class="activity-item">
          <div class="activity-content">生徒「山田太郎」さんが成績を更新しました</div>
          <div class="activity-date">2025-05-01 16:30</div>
        </li>
      </ul>
    </div>
    
    <!-- 主な機能 -->
    <div class="functions-panel">
      <h4 class="panel-header">
        <span class="panel-header-icon">⚡</span>
        主な機能
        <button id="theme-toggle" class="theme-toggle-btn" aria-label="テーマ切り替え" title="ダークモード切り替え">
          <i class="fas fa-moon"></i>
        </button>
      </h4>
      <div class="quick-links">
        <a href="/myapp/index.cgi/teacher/points" class="quick-link" aria-label="ポイント管理">
          <div class="icon"><i class="fas fa-coins"></i></div>
          <div class="title">ポイント管理</div>
          <div class="description">生徒へのポイント付与・履歴管理</div>
        </a>
        
        <a href="/myapp/index.cgi/teacher/crane-game-credits" class="quick-link" aria-label="クレーンゲーム管理">
          <div class="icon"><i class="fas fa-gamepad"></i></div>
          <div class="title">クレーンゲーム</div>
          <div class="description">プレイ権の管理と設定</div>
        </a>
        
        <a href="/myapp/index.cgi/teacher/manual-score" class="quick-link" aria-label="小学生点数登録">
          <div class="icon"><i class="fas fa-edit"></i></div>
          <div class="title">小学生点数</div>
          <div class="description">外部テスト点数の登録</div>
        </a>
        
        <a href="/myapp/index.cgi/admin/fetch-high-schools" class="quick-link" aria-label="高校情報管理">
          <div class="icon"><i class="fas fa-school"></i></div>
          <div class="title">高校情報</div>
          <div class="description">高校データの取得・管理</div>
        </a>
        
        <a href="/myapp/index.cgi/teacher/attendance" class="quick-link" aria-label="出席管理">
          <div class="icon"><i class="fas fa-calendar-check"></i></div>
          <div class="title">出席管理</div>
          <div class="description">生徒の出席状況確認</div>
        </a>
        
        <a href="/myapp/index.cgi/teacher/homework" class="quick-link highlight" aria-label="宿題管理（おすすめ）">
          <div class="icon"><i class="fas fa-book-open"></i></div>
          <div class="title">宿題管理</div>
          <div class="description">小5・小6の宿題登録とチェック</div>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- 出席確認モーダル -->
<div id="attendance-modal" class="attendance-modal">
  <div class="attendance-modal-content">
    <span class="attendance-close">&times;</span>
    <h4>出席確認</h4>
    <div class="attendance-date">
      <label for="attendance-date-input">日付：</label>
      <input type="date" id="attendance-date-input" class="modern-form-control" value="">
    </div>

    <div class="attendance-list" id="attendance-list">
      <!-- 出席チェックリストが動的に生成されます -->
    </div>

    <div class="attendance-submit">
      <button id="attendance-submit-btn" class="btn btn-primary">出席情報を保存</button>
    </div>
  </div>
</div>

<!-- 学年別曜日設定モーダル -->
<div id="grade-schedule-modal" class="grade-schedule-modal">
  <div class="grade-schedule-modal-content">
    <span class="grade-schedule-close">&times;</span>
    <h4>学年別曜日設定</h4>
    <div class="alert alert-info" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: var(--text-primary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
      各学年の授業日として設定されている曜日にチェックを入れてください。これにより、生徒の出席管理が簡単になります。出席時に授業日であれば、自動的にポイントが付与されます。
    </div>

    <table class="schedule-table" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">学年</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">月</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">火</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">水</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">木</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">金</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">土</th>
          <th style="padding: 15px; background: rgba(0, 255, 255, 0.1); color: var(--cyber-primary); border: 1px solid var(--glass-border);">日</th>
        </tr>
      </thead>
      <tbody id="grade-schedule-tbody">
        <!-- 各学年の行 -->
        <tr data-grade="elementary-1">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小1</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="elementary-2">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小2</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="elementary-3">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小3</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="elementary-4">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小4</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="elementary-5">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小5</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="elementary-6">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">小6</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="middle-1">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">中1</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="middle-2">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">中2</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="middle-3">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">中3</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="high-1">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">高1</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="high-2">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">高2</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
        <tr data-grade="high-3">
          <td style="padding: 15px; border: 1px solid var(--glass-border); color: var(--text-primary);">高3</td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="1"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="2"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="3"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="4"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="5"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="6"></td>
          <td style="padding: 15px; border: 1px solid var(--glass-border); text-align: center;"><input type="checkbox" data-day="0"></td>
        </tr>
      </tbody>
    </table>

    <div class="grade-schedule-footer" style="margin-top: 25px; text-align: right;">
      <button id="grade-schedule-save-btn" class="btn btn-primary">設定を保存</button>
    </div>
  </div>
</div>

<!-- チェックボックスのスタイル追加 -->
<style>
  input[type="checkbox"] {
    appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid var(--glass-border);
    border-radius: 5px;
    background: transparent;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
  }
  
  input[type="checkbox"]:checked {
    background: var(--cyber-primary);
    border-color: var(--cyber-primary);
    box-shadow: 0 0 10px var(--cyber-primary);
  }
  
  input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--dark-bg);
    font-weight: bold;
  }
  
  /* サイドパネルのレイアウト調整 */
  .side-panels {
    display: flex;
    flex-direction: column;
    gap: 30px;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 20px;
  }
  
  @media (min-width: 1200px) {
    .side-panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
  }
  
  /* フォームレイアウト */
  .modern-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    align-items: end;
  }
  
  .modern-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .modern-form-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  /* 出席リストのスタイル */
  .attendance-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 25px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    border: 1px solid var(--glass-border);
  }
  
  .attendance-row {
    display: flex;
    align-items: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    border: 1px solid var(--glass-border);
  }
  
  /* 無効化（自動スクロール防止）: attendance-row hover effect
  .attendance-row:hover {
    background: rgba(0, 255, 255, 0.05);
    border-color: var(--cyber-primary);
  }
  */
  
  .attendance-student-name {
    flex: 1;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 15px;
  }
  
  .attendance-options {
    display: flex;
    gap: 20px;
  }
  
  .attendance-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
  }
  
  /* 無効化（自動スクロール防止）: attendance-option hover effect
  .attendance-option:hover {
    color: var(--text-primary);
  }
  */
  
  .attendance-option input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--glass-border);
    border-radius: 50%;
    margin-right: 8px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
  }
  
  .attendance-option input[type="radio"]:checked {
    border-color: var(--cyber-primary);
    box-shadow: 0 0 10px var(--cyber-primary);
  }
  
  .attendance-option input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--cyber-primary);
  }
  
  .point-hint {
    color: var(--neon-green);
    font-weight: bold;
    font-size: 12px;
    margin-left: 5px;
  }
</style>
{% endblock %}

{% block scripts %}
<!-- ダッシュボード初期化とエフェクト -->
<script>
// ダッシュボードの初期化
document.addEventListener('DOMContentLoaded', function() {
  // 既存のスタイルを強制的に無効化
  const existingStyles = document.querySelectorAll('link[href*="style.css"], link[href*="modern-style.css"]');
  existingStyles.forEach(link => {
    link.disabled = true;
    link.remove();
  });
  
  // ベーステンプレートの要素を確実に非表示
  const hideElements = document.querySelectorAll('body > header, body > nav, body > footer');
  hideElements.forEach(el => {
    if (el) {
      el.style.display = 'none';
      el.style.visibility = 'hidden';
      el.style.position = 'absolute';
      el.style.top = '-9999px';
      el.style.left = '-9999px';
      el.style.overflow = 'hidden';
      el.style.height = '0';
      el.style.opacity = '0';
    }
  });
  
  // パーティクル効果の生成 - 無効化（自動スクロール防止）
  // createParticles();
  
  // ネオン効果の初期化
  initNeonEffects();
});

// パーティクル効果の生成関数 - 無効化（自動スクロール防止）
function createParticles() {
  // パーティクル生成を無効化して自動スクロールを防止
  return;
}

// ネオン効果の初期化
function initNeonEffects() {
  const glowElements = document.querySelectorAll('.stat-card, .dashboard-header, .grade-tab, .day-tab');
  glowElements.forEach(el => {
    if (el) {
      el.style.transition = 'all 0.3s ease';
    }
  });
}

// 既存のJavaScriptコード
// Quick Linksのインタラクティブ効果
const quickLinks = document.querySelectorAll('.quick-link');

quickLinks.forEach(link => {
    // マウス追従3D効果 - 無効化（自動スクロール防止）
    /*
    link.addEventListener('mousemove', function(e) {
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        const rotateX = (y - centerY) / 10;
        const rotateY = (centerX - x) / 10;
        
        this.style.transform = `
            perspective(1000px) 
            rotateX(${rotateX}deg) 
            rotateY(${rotateY}deg) 
            translateZ(10px)
            scale(1.02)
        `;
    });
    
    link.addEventListener('mouseleave', function() {
        this.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateZ(0) scale(1)';
    });
    */
    
    // リップル効果
    link.addEventListener('click', function(e) {
        const ripple = document.createElement('div');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${x}px;
            top: ${y}px;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            transform: scale(0);
            /* animation: rippleEffect 0.6s linear; /* 無効化（自動スクロール防止） */
            pointer-events: none;
            z-index: 1000;
        `;
        
        this.style.position = 'relative';
        this.style.overflow = 'hidden';
        this.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    });
});

// スクロール視差効果 - 無効化（自動スクロール防止）
function handleScroll() {
    // 視差効果を無効化して自動スクロールを防止
    return;
}

// スクロールイベントリスナーを無効化
// let ticking = false;
// window.addEventListener('scroll', function() {
//     if (!ticking) {
//         requestAnimationFrame(function() {
//             handleScroll();
//             ticking = false;
//         });
//         ticking = true;
//     }
// });

// CSS keyframes for ripple effect - 無効化（自動スクロール防止）
const style = document.createElement('style');
style.textContent = `
    /* 無効化（自動スクロール防止）: rippleEffect animation
    @keyframes rippleEffect {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    */
`;
document.head.appendChild(style);
</script>
<script>
  // 生徒データを取得する関数 - ダミーデータを削除し、エラー処理を改善
  function fetchStudents(filters = {}) {
    // デフォルトのフィルター設定
    const defaultFilters = {
      grade: 'all',
      day: 'all'  // デフォルトで全曜日に設定
    };
    
    // デフォルト設定とマージ
    const mergedFilters = { ...defaultFilters, ...filters };
    
    // クエリパラメータを構築
    const queryParams = new URLSearchParams();
    for (const [key, value] of Object.entries(mergedFilters)) {
      if (value !== 'all') {
        queryParams.append(key, value);
      }
    }
    
    // APIエンドポイントのURL構築
    const apiUrl = `/myapp/index.cgi/api/teacher/students?${queryParams}`;
    
    console.log(`API呼び出し: ${apiUrl}`);
    
    // APIリクエストを実行
    return fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          if (response.status === 404) {
            // APIエンドポイントが見つからないエラー
            throw new Error('APIエンドポイントが見つかりません。サーバー設定を確認してください。');
          }
          throw new Error('生徒データの取得に失敗しました（ステータス: ' + response.status + '）');
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.students) {
          console.log('生徒データ取得成功:', data.students.length + '件');
          
          // 各生徒のデータを整形
          return data.students.map(student => {
            // 必要なプロパティの存在を確認
            if (student.grade_level === undefined || student.grade_level === null) {
              console.warn(`学年が設定されていない生徒: ${student.id} ${student.name}`);
            }
            if (!student.school_type) {
              console.warn(`学校種別が設定されていない生徒: ${student.id} ${student.name}`);
            }
            
            return {
              ...student,
              // 型変換を確実に行う
              grade_level: parseInt(student.grade_level || 0, 10) || 0,
              // 必須プロパティが確実に存在するように
              school_type: student.school_type || 'unset'
            };
          });
        } else {
          console.error('生徒データの形式が不正:', data);
          throw new Error('サーバーからの応答形式が正しくありません');
        }
      });
  }
  
  // 生徒リストを表示する関数
  function displayStudents(students) {
    const studentList = document.getElementById('student-list');
    if (!studentList) return;
    
    studentList.innerHTML = ''; // リストをクリア
    
    if (!students || students.length === 0) {
        studentList.innerHTML = '<div class="empty-message">生徒データがありません。</div>';
        return;
    }
    
    // 今日の曜日を取得
    const today = new Date();
    const currentDayOfWeek = today.getDay(); // 0:日曜、1:月曜...
    const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
    const currentDayName = dayNames[currentDayOfWeek];
    
    students.forEach(student => {
        const studentCard = document.createElement('div');
        studentCard.className = 'student-card';
        studentCard.dataset.id = student.id;
        studentCard.dataset.dayOfWeek = currentDayOfWeek;
        
        // 学年表示の生成
        let gradeDisplay = getGradeDisplay(student.grade_level, student.school_type);
        
        // ログイン状態に応じたステータス表示
        let statusClass = 'status-offline';
        let statusText = '未ログイン';
        
        if (student.hasLoggedInToday) {
            statusClass = 'status-online';
            statusText = '今日ログイン';
        } else if (student.lastLogin) {
            const daysSinceLogin = Math.floor((new Date() - new Date(student.lastLogin)) / (1000 * 60 * 60 * 24));
            if (daysSinceLogin < 3) {
                statusClass = 'status-today';
                statusText = `${daysSinceLogin}日前`;
            }
        }
        
        // 出席状態の表示
        let attendanceMarker = '';
        if (student.attendanceToday === 'present') {
            attendanceMarker = `
                <div class="attendance-marker">
                    <span class="present-indicator"></span>出席済み
                </div>
            `;
        } else if (student.attendanceToday === 'absent') {
            attendanceMarker = `
                <div class="attendance-marker">
                    <span class="absent-indicator"></span>欠席
                </div>
            `;
        }
        
        // 授業日チェック（シンプル版）
        const isClassDay = isScheduledClassDay(student, currentDayOfWeek);
        
        // 授業日の場合はカードにクラスを追加
        if (isClassDay) {
            studentCard.classList.add('class-day');
        }
        
        // 授業日表示を追加
        let classDayInfo = '';
        if (isClassDay) {
            classDayInfo = `<div class="class-day-info">本日(${currentDayName})は授業日です ✓</div>`;
        } else {
            classDayInfo = `<div class="class-day-info not-scheduled">本日(${currentDayName})は授業日ではありません</div>`;
        }
        
        // 生徒カードのHTMLを設定
        studentCard.innerHTML = `
            <div class="student-header">
                <div>
                    <div class="student-name">${student.name}</div>
                    <div class="student-grade">${gradeDisplay}</div>
                    ${classDayInfo}
                </div>
            </div>
            ${attendanceMarker}
            <div class="student-status">
                <span>
                    <span class="status-indicator ${statusClass}"></span>
                    ${statusText}
                </span>
            </div>
            <div class="student-actions">
                <button class="student-action-btn attendance-btn" data-id="${student.id}">出席確認</button>
                <button class="student-action-btn detail-btn student-login-btn" data-student-id="${student.id}">生徒としてログイン</button>
            </div>
        `;
        
        studentList.appendChild(studentCard);
    });
    
    // 出席確認ボタンのイベントリスナーを設定
    setupAttendanceButtonListeners();
  }
  
  // 生徒詳細ボタンのイベントリスナー
  function openStudentDetails(studentId) {
    // トークンを取得して新しいタブで開く
    fetch(`/myapp/index.cgi/teacher/student-access-token/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.open(data.access_url, '_blank');
            } else {
                alert('生徒アクセスの準備に失敗しました: ' + data.message);
            }
        })
        .catch(error => {
            console.error('生徒アクセストークン取得エラー:', error);
            alert('エラーが発生しました: ' + error.message);
        });
  }
  
  // 学年表示を生成する関数 - 学校タイプと学年レベルに応じた表示を返す
  function getGradeDisplay(gradeLevel, schoolType) {
    console.log(`getGradeDisplay呼び出し: gradeLevel=${gradeLevel}, schoolType=${schoolType}`);
    
    // 学校種別が未設定の場合
    if (!schoolType || schoolType === 'unset' || schoolType === '') {
      return '未設定';
    }
    
    // 学年が未設定か無効な場合
    if (gradeLevel === undefined || gradeLevel === null || gradeLevel === '' || isNaN(Number(gradeLevel))) {
      if (schoolType === 'elementary') return '小学生';
      if (schoolType === 'middle') return '中学生';
      if (schoolType === 'high') return '高校生';
      return '未設定';
    }
    
    // 数値型に変換して処理
    const grade = Number(gradeLevel);
    
    // 学校種類に応じて適切な学年表示を返す
    if (schoolType === 'elementary') {
      // 小学生: 1-6年生
      if (grade >= 1 && grade <= 6) {
        return `小${grade}年生`;
      }
      return `小学生(${grade})`;
    } else if (schoolType === 'middle') {
      // 中学生: 実際のデータベースでは7-9ではなく1-3で格納されている可能性が高い
      if (grade >= 7 && grade <= 9) {
        // 7-9の場合は中1-3に変換
        return `中${grade - 6}年生`;
      } else if (grade >= 1 && grade <= 3) {
        // 1-3の場合はそのまま中1-3として表示
        return `中${grade}年生`;
      } else {
        return `中学生(${grade})`;
      }
    } else if (schoolType === 'high') {
      // 高校生: 同様にデータベースでは1-3か10-12かを判断
      if (grade >= 10 && grade <= 12) {
        return `高${grade - 9}年生`;
      } else if (grade >= 1 && grade <= 3) {
        return `高${grade}年生`;
      } else {
        return `高校生(${grade})`;
      }
    }
    
    // デフォルト値
    return `${grade}年生`;
  }
  
  // 出席確認ボタンと生徒ログインボタンのイベントリスナーを設定する関数
  function setupAttendanceButtonListeners() {
    console.log('出席確認ボタンのイベントリスナーを設定中...');
    
    // 出席確認ボタンのイベントリスナー
    document.querySelectorAll('.attendance-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const studentId = this.dataset.id;
            console.log(`出席確認ボタンがクリックされました: 生徒ID = ${studentId}`);
            // 出席確認モーダルを表示
            showAttendanceModalForStudent(studentId);
        });
    });
    
    // 生徒としてログインボタンのイベントリスナー
    document.querySelectorAll('.student-login-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const studentId = this.dataset.studentId;
            console.log(`生徒ログインボタンがクリックされました: 生徒ID = ${studentId}`);
            // 新しいタブで生徒としてログイン
            window.open(`/myapp/index.cgi/teacher/login-as-student/${studentId}`, '_blank');
        });
    });
    
    console.log(`設定完了: 出席確認ボタン ${document.querySelectorAll('.attendance-btn').length}個, 生徒ログインボタン ${document.querySelectorAll('.student-login-btn').length}個`);
  }
  
  // 個別生徒の出席確認モーダル表示
  function showAttendanceModalForStudent(studentId) {
    console.log(`個別生徒の出席確認モーダル表示: 生徒ID = ${studentId}`);
    // 単一生徒のデータを取得
    fetch(`/myapp/index.cgi/api/teacher/students?student_id=${studentId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.students && data.students.length > 0) {
          const student = data.students[0];
          console.log('取得した生徒データ:', student);
          showAttendanceModal([student]);
        } else {
          console.error('生徒データが見つかりません:', data);
          alert('生徒情報の取得に失敗しました');
        }
      })
      .catch(error => {
        console.error('生徒情報取得エラー:', error);
        alert(error.message || '生徒情報の取得に失敗しました');
      });
  }
  
  // 出席確認モーダル表示
  function showAttendanceModal(students) {
    console.log('出席確認モーダル表示:', students);
    const modal = document.getElementById('attendance-modal');
    const attendanceList = document.getElementById('attendance-list');
    const dateInput = document.getElementById('attendance-date-input');
    
    if (!modal || !attendanceList || !dateInput) {
        console.error('モーダル要素が見つかりません');
        return;
    }
    
    // 日付フィールドに今日の日付をセット
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    dateInput.value = formattedDate;
    
    // リストをクリア
    attendanceList.innerHTML = '';
    
    if (!students || students.length === 0) {
        attendanceList.innerHTML = '<div class="empty-message">対象となる生徒データがありません。</div>';
        modal.style.display = 'block';
        return;
    }
    
    // 初期表示時の曜日
    const dayOfWeek = today.getDay(); // 0は日曜日
    
    // 出席リストを表示
    displayAttendanceList(students, dayOfWeek, today);
    
    // 日付選択時のイベントリスナーを追加 - 選択した日付の曜日を使用
    dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const selectedDayOfWeek = selectedDate.getDay(); // 0=日曜、1=月曜...
        console.log(`選択された日付: ${this.value}, 曜日: ${selectedDayOfWeek}`);
        
        // 選択した日付の曜日で出席リストを更新
        displayAttendanceList(students, selectedDayOfWeek, selectedDate);
    });
    
    // モーダルを表示
    modal.style.display = 'block';
  }
  
  // 出席リスト表示関数 - 曜日を引数に追加
  function displayAttendanceList(students, dayOfWeek, date) {
    const attendanceList = document.getElementById('attendance-list');
    attendanceList.innerHTML = '';
    
    if (!students || students.length === 0) {
        attendanceList.innerHTML = '<div class="empty-message">対象となる生徒データがありません。</div>';
        return;
    }
    
    // 曜日名の配列
    const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
    const formattedDayName = dayNames[dayOfWeek];
    
    // 日付フォーマット (YYYY-MM-DD)
    const formattedDate = date.toISOString().split('T')[0];
    
    students.forEach(student => {
        const row = document.createElement('div');
        row.className = 'attendance-row';
        row.dataset.id = student.id;
        
        // 学年表示の生成
        let gradeDisplay = getGradeDisplay(student.grade_level, student.school_type);
        
        // 成績向上情報を表示
        let improvementInfo = '';
        
        if (student.improvement > 0) {
          improvementInfo = `
            <div class="improvement-info">
              <span class="improvement-label">成績向上:</span>
              <span class="improvement-value positive">${student.improvement}点</span>
            </div>
          `;
        } else if (student.improvement < 0) {
          improvementInfo = `
            <div class="improvement-info">
              <span class="improvement-label">成績低下:</span>
              <span class="improvement-value negative">${student.improvement}点</span>
            </div>
          `;
        }
        
        // 授業日チェック - 選択された曜日を使用
        const isClassDay = isScheduledClassDay(student, dayOfWeek);
        
        // 授業日情報を行に保存（出席状態送信時に使用）
        row.dataset.isClassDay = isClassDay ? 'true' : 'false';
        
        // 授業日表示を追加
        let classDayInfo = '';
        if (isClassDay) {
            classDayInfo = `<div class="class-day-info">この日(${formattedDayName})は授業日です ✓</div>`;
        } else {
            classDayInfo = `<div class="class-day-info not-scheduled">この日(${formattedDayName})は授業日ではありません</div>`;
        }
        
        row.innerHTML = `
            <div class="attendance-student-name">
                ${student.name} (${gradeDisplay})
                ${classDayInfo}
            </div>
            <div class="attendance-options">
                <label class="attendance-option">
                    <input type="radio" name="attendance-${student.id}" value="present" ${student.attendanceToday === 'present' ? 'checked' : ''}>
                    出席 ${isClassDay ? '<span class="point-hint">(+10ポイント)</span>' : ''}
                </label>
                <label class="attendance-option">
                    <input type="radio" name="attendance-${student.id}" value="absent" ${student.attendanceToday === 'absent' ? 'checked' : ''}>
                    欠席
                </label>
                <label class="attendance-option">
                    <input type="radio" name="attendance-${student.id}" value="late" ${student.attendanceToday === 'late' ? 'checked' : ''}>
                    遅刻
                </label>
                <label class="attendance-option">
                    <input type="radio" name="attendance-${student.id}" value="none" ${!student.attendanceToday ? 'checked' : ''}>
                    未設定
                </label>
            </div>
        `;
        
        attendanceList.appendChild(row);
    });
  }
  
  // 授業日チェック関数（シンプル版）
  function isScheduledClassDay(student, dayOfWeek) {
    // 生徒の通塾曜日情報がない場合は常にfalseを返す
    if (!student.attendance_days) return false;
    
    // attendance_daysは "0,2,5" のような文字列
    const attendanceDays = student.attendance_days.split(',').map(day => parseInt(day, 10));
    
    // 指定された曜日が通塾曜日に含まれているかどうかをチェック
    return attendanceDays.includes(dayOfWeek);
  }
  
  // スケジュール取得関数 - class_schedule_masterテーブルと連携
  async function getClassSchedule() {
    try {
      // キャッシュがあれば使用
      const cached = localStorage.getItem('class_schedule');
      if (cached) {
        return JSON.parse(cached);
      }
      
      // APIから取得
      const response = await fetch('/myapp/index.cgi/api/teacher/class-schedule');
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.schedule) {
          localStorage.setItem('class_schedule', JSON.stringify(data.schedule));
          return data.schedule;
        }
      }
      
      throw new Error('スケジュールの取得に失敗しました');
    } catch (e) {
      console.error('授業日スケジュール取得エラー:', e);
      
      // APIがない場合や初回の場合、デフォルト設定を返す
      // 実際のAPIが整備されるまでのテスト用
      const defaultSchedule = [];
      
      // 小学生（小1-小6）：月・水曜授業
      for (let grade = 1; grade <= 6; grade++) {
        defaultSchedule.push({ grade_level: grade, school_type: 'elementary', day_of_week: 1 }); // 月曜日
        defaultSchedule.push({ grade_level: grade, school_type: 'elementary', day_of_week: 3 }); // 水曜日
      }
      
      // 中学生（中1-中3）：火・金曜授業
      for (let grade = 1; grade <= 3; grade++) {
        defaultSchedule.push({ grade_level: grade, school_type: 'middle', day_of_week: 2 }); // 火曜日
        defaultSchedule.push({ grade_level: grade, school_type: 'middle', day_of_week: 5 }); // 金曜日
      }
      
      // 高校生（高1-高3）：木・土曜授業
      for (let grade = 1; grade <= 3; grade++) {
        defaultSchedule.push({ grade_level: grade, school_type: 'high', day_of_week: 4 }); // 木曜日
        defaultSchedule.push({ grade_level: grade, school_type: 'high', day_of_week: 6 }); // 土曜日
      }
      
      // テスト用のデフォルト設定をキャッシュに保存
      localStorage.setItem('class_schedule', JSON.stringify(defaultSchedule));
      return defaultSchedule;
    }
  }
  
  // 学年別曜日設定を読み込む関数
  function loadGradeSchedule() {
    getClassSchedule().then(schedule => {
      // 既存の設定をチェックボックスに反映
      schedule.forEach(item => {
        // 学年と学校種別からテーブルの行を特定
        let gradeKey;
        
        if (item.school_type === 'elementary') {
          gradeKey = `elementary-${item.grade_level}`;
        } else if (item.school_type === 'middle') {
          // 中学生: 1-3または7-9に対応
          const grade = item.grade_level;
          if (grade >= 7 && grade <= 9) {
            gradeKey = `middle-${grade - 6}`;
          } else {
            gradeKey = `middle-${grade}`;
          }
        } else if (item.school_type === 'high') {
          // 高校生: 1-3または10-12に対応
          const grade = item.grade_level;
          if (grade >= 10 && grade <= 12) {
            gradeKey = `high-${grade - 9}`;
          } else {
            gradeKey = `high-${grade}`;
          }
        } else {
          return; // 不明な学校種別はスキップ
        }
        
        const row = document.querySelector(`tr[data-grade="${gradeKey}"]`);
        if (!row) return;
        
        // 曜日のチェックボックスにチェックを入れる
        const checkbox = row.querySelector(`input[data-day="${item.day_of_week}"]`);
        if (checkbox) checkbox.checked = true;
      });
    }).catch(error => {
      console.error('曜日設定の読み込みエラー:', error);
      // エラー時はデフォルト設定を適用
      setDefaultSchedule();
    });
  }
  
  // サンプルの曜日設定を適用
  function setDefaultSchedule() {
    // 小学生は月・水曜日
    for (let i = 1; i <= 6; i++) {
      const row = document.querySelector(`tr[data-grade="elementary-${i}"]`);
      if (row) {
        row.querySelector('input[data-day="1"]').checked = true; // 月曜日
        row.querySelector('input[data-day="3"]').checked = true; // 水曜日
      }
    }
    
    // 中学生は火・金曜日
    for (let i = 1; i <= 3; i++) {
      const row = document.querySelector(`tr[data-grade="middle-${i}"]`);
      if (row) {
        row.querySelector('input[data-day="2"]').checked = true; // 火曜日
        row.querySelector('input[data-day="5"]').checked = true; // 金曜日
      }
    }
    
    // 高校生は木・土曜日
    for (let i = 1; i <= 3; i++) {
      const row = document.querySelector(`tr[data-grade="high-${i}"]`);
      if (row) {
        row.querySelector('input[data-day="4"]').checked = true; // 木曜日
        row.querySelector('input[data-day="6"]').checked = true; // 土曜日
      }
    }
  }
  
  // 学年別曜日設定を保存する関数 - class_schedule_masterテーブルと連携
  function saveGradeSchedule() {
    const scheduleData = [];
    
    // 各学年の設定を収集
    document.querySelectorAll('#grade-schedule-tbody tr').forEach(row => {
      const gradeKey = row.dataset.grade;
      if (!gradeKey) return;
      
      // 学校種別と学年レベルを抽出
      let schoolType, gradeLevel;
      if (gradeKey.startsWith('elementary-')) {
        schoolType = 'elementary';
        gradeLevel = parseInt(gradeKey.split('-')[1]);
      } else if (gradeKey.startsWith('middle-')) {
        schoolType = 'middle';
        gradeLevel = parseInt(gradeKey.split('-')[1]);
      } else if (gradeKey.startsWith('high-')) {
        schoolType = 'high';
        gradeLevel = parseInt(gradeKey.split('-')[1]);
      } else {
        return;
      }
      
      // 曜日設定を収集
      row.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        const dayOfWeek = parseInt(checkbox.dataset.day);
        
        scheduleData.push({
          grade_level: gradeLevel,
          school_type: schoolType,
          day_of_week: dayOfWeek
        });
      });
    });
    
    // APIに送信
    fetch('/myapp/index.cgi/api/teacher/class-schedule', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ schedule: scheduleData })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('学年別曜日設定を保存しました');
        document.getElementById('grade-schedule-modal').style.display = 'none';
        // ローカルストレージにキャッシュ
        localStorage.setItem('class_schedule', JSON.stringify(scheduleData));
      } else {
        alert('設定の保存に失敗しました: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error saving grade schedule:', error);
      // テスト環境用にローカルストレージに保存
      localStorage.setItem('class_schedule', JSON.stringify(scheduleData));
      alert('設定を保存しました（テストモード）');
      document.getElementById('grade-schedule-modal').style.display = 'none';
    });
  }
  
  // 出席情報を保存する関数
  function saveAttendanceRecords(attendanceData) {
    console.log('出席情報を保存します:', attendanceData);
    return fetch('/myapp/index.cgi/api/teacher/attendance', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ attendance_records: attendanceData })
    })
    .then(response => response.json())
    .then(data => {
      console.log('出席情報保存結果:', data);
      if (data.success) {
        return data;
      } else {
        throw new Error(data.message || '出席記録の保存に失敗しました');
      }
    });
  }
  
  // 学年と曜日でフィルタリングした生徒リストを表示
  function updateStudentDisplay(grade, day) {
    // API リクエスト用のフィルターを構築
    const filters = {};
    
    // 学年フィルター処理
    if (grade && grade !== 'all') {
      // 特殊な学年形式の処理（例：elementary-1 → elementary + 1）
      if (grade.includes('-')) {
        const [schoolType, gradeNum] = grade.split('-');
        filters.school_type = schoolType;
        filters.grade_level = gradeNum;
      } else {
        filters.grade = grade;
      }
    }
    
    // 曜日フィルター処理
    if (day && day !== 'all') {
      filters.day = day;
    }
    
    console.log('フィルター設定:', filters);  // デバッグ用
    
    // ローディング表示
    const studentList = document.getElementById('student-list');
    if (studentList) {
      studentList.innerHTML = '<div class="loading-message">生徒データを読み込み中...</div>';
    }
    
    // 生徒データ取得
    fetchStudents(filters)
      .then(students => {
        console.log(`${grade}/${day}のフィルターで生徒データを取得: ${students.length}件`, students);
        displayStudents(students);
      })
      .catch(error => {
        console.error('生徒データ取得エラー:', error);
        // エラーメッセージを表示
        if (studentList) {
          studentList.innerHTML = `
            <div class="empty-message error-message">
              <p><strong>データ取得エラー:</strong> ${error.message}</p>
              <p>以下をご確認ください:</p>
              <ul>
                <li>サーバーが正常に動作しているか</li>
                <li>APIエンドポイントが正しく設定されているか</li>
                <li>ネットワーク接続に問題がないか</li>
              </ul>
            </div>
          `;
        }
      });
  }

  // 成績向上フィルタのイベント設定
  function setupImprovementFilter() {
    // フィルタパネルの切り替え処理
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // アクティブタブを切り替え
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // パネルの切り替え
        const filterType = this.dataset.filter;
        document.querySelectorAll('.filter-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(`${filterType}-filter`).classList.add('active');
      });
    });
    
    // 小学生フィルター適用ボタン
    document.getElementById('elementary-filter-btn').addEventListener('click', function() {
      const startMonth = document.getElementById('elementary-start-month').value;
      const endMonth = document.getElementById('elementary-end-month').value;
      const subject = document.getElementById('elementary-subject').value;
      const minImprovement = document.getElementById('elementary-min-improvement').value;
      
      fetchStudentsWithImprovedGrades('elementary', {
        start_month: startMonth,
        end_month: endMonth,
        subject: subject,
        min_improvement: minImprovement
      });
    });
    
    // 中学生フィルター適用ボタン
    document.getElementById('middle-filter-btn').addEventListener('click', function() {
      const startYear = document.getElementById('middle-start-year').value;
      const startTerm = document.getElementById('middle-start-term').value;
      const endYear = document.getElementById('middle-end-year').value;
      const endTerm = document.getElementById('middle-end-term').value;
      const subject = document.getElementById('middle-subject').value;
      
      fetchStudentsWithImprovedGrades('middle', {
        start_year: startYear,
        start_term: startTerm,
        end_year: endYear,
        end_term: endTerm,
        subject: subject
      });
    });
  }

  // 成績向上生徒を取得する関数
  function fetchStudentsWithImprovedGrades(schoolType, filters) {
    const queryParams = new URLSearchParams();
    queryParams.append('type', schoolType);
    
    for (const [key, value] of Object.entries(filters)) {
      queryParams.append(key, value);
    }
    
    // APIエンドポイントのURL構築
    const apiUrl = `/myapp/index.cgi/api/teacher/improved-students?${queryParams}`;
    
    console.log(`成績向上生徒API呼び出し: ${apiUrl}`);
    
    // データ取得中の表示
    const studentList = document.getElementById('student-list');
    studentList.innerHTML = '<div class="loading-message">成績向上生徒のデータを取得中...</div>';
    
    // fetch APIでデータ取得
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('生徒データの取得に失敗しました');
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.students) {
          console.log('成績向上生徒データ取得成功:', data.students.length + '件');
          
          // 生徒リストを表示
          displayImprovedStudents(data.students, schoolType);
        } else {
          console.error('生徒データの形式が不正:', data);
          studentList.innerHTML = '<div class="empty-message">データの取得に失敗しました。</div>';
        }
      })
      .catch(error => {
        console.error('生徒データ取得エラー:', error);
        
        // APIがない場合のエラー表示
        studentList.innerHTML = `
          <div class="empty-message error-message">
            <p><strong>データ取得エラー:</strong> ${error.message}</p>
            <p>成績向上データのAPIエンドポイントに問題があります。管理者にご連絡ください。</p>
          </div>
        `;
      });
  }

  // 成績向上生徒の表示
  function displayImprovedStudents(students, schoolType) {
    const studentList = document.getElementById('student-list');
    studentList.innerHTML = ''; // リストをクリア
    
    if (!students || students.length === 0) {
      studentList.innerHTML = '<div class="empty-message">条件に一致する生徒はいません。</div>';
      return;
    }
    
    students.forEach(student => {
      const studentCard = document.createElement('div');
      studentCard.className = 'student-card improvement-card';
      studentCard.dataset.id = student.id;
      
      // 学年表示の生成
      let gradeDisplay = getGradeDisplay(student.grade_level, student.school_type);
      
      // 成績向上情報を表示
      let improvementInfo = '';
      
      if (schoolType === 'elementary') {
        improvementInfo = `
          <div class="improvement-info">
            <div class="improvement-subject">${student.subject_name}</div>
            <div class="improvement-scores">
              ${student.previous_month}月: ${student.previous_score}点 → ${student.current_month}月: ${student.current_score}点
            </div>
            <div class="improvement-diff ${student.improvement > 0 ? 'positive' : 'negative'}">
              ${student.improvement > 0 ? '+' : ''}${student.improvement}点
            </div>
          </div>
        `;
      } else {
        improvementInfo = `
          <div class="improvement-info">
            <div class="improvement-subject">${student.subject_name}</div>
            <div class="improvement-scores">
              ${student.previous_year}年${student.previous_term}学期: ${student.previous_point} → 
              ${student.current_year}年${student.current_term}学期: ${student.current_point}
            </div>
            <div class="improvement-diff ${student.improvement > 0 ? 'positive' : 'negative'}">
              ${student.improvement > 0 ? '+' : ''}${student.improvement}
            </div>
          </div>
        `;
      }
      
      // 付与ポイント計算
      let potentialPoints = 0;
      let improvementLevel = '';
      
      if (schoolType === 'elementary') {
        if (student.improvement >= 15) {
          potentialPoints = 50;
          improvementLevel = '大';
        } else if (student.improvement >= 10) {
          potentialPoints = 30;
          improvementLevel = '中';
        } else if (student.improvement >= 5) {
          potentialPoints = 20;
          improvementLevel = '小';
        }
      } else {
        if (student.improvement >= 2) {
          potentialPoints = 50;
          improvementLevel = '大';
        } else if (student.improvement >= 1) {
          potentialPoints = 30;
          improvementLevel = '中';
        }
      }
      
      // ポイント付与ボタン（5点以上または内申1以上の場合のみ表示）
      let awardButton = '';
      if (potentialPoints > 0) {
        awardButton = `
          <button class="award-points-btn" 
            data-student-id="${student.id}" 
            data-points="${potentialPoints}" 
            data-improvement="${student.improvement}"
            data-level="${improvementLevel}"
            data-subject="${student.subject_id}"
            data-subject-name="${student.subject_name}"
            data-type="${schoolType}">
            ${potentialPoints}ポイント付与 (${improvementLevel}幅向上)
          </button>
        `;
      }
      
      // 生徒カードのHTMLを設定
      studentCard.innerHTML = `
        <div class="student-header">
          <div>
            <div class="student-name">${student.name}</div>
            <div class="student-grade">${gradeDisplay}</div>
          </div>
          <div class="improvement-level improvement-level-${improvementLevel}">
            ${improvementLevel ? improvementLevel + '幅向上' : ''}
          </div>
        </div>
        ${improvementInfo}
        <div class="student-actions">
          ${awardButton}
          <button class="student-action-btn detail-btn student-login-btn" data-student-id="${student.id}">生徒としてログイン</button>
        </div>
      `;
      
      studentList.appendChild(studentCard);
    });
    
    // イベントリスナーを設定
    setupAttendanceButtonListeners();
    
    // ポイント付与ボタンのイベントリスナー
    document.querySelectorAll('.award-points-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const studentId = this.dataset.studentId;
        const points = this.dataset.points;
        const improvement = this.dataset.improvement;
        const level = this.dataset.level;
        const subject = this.dataset.subject;
        const subjectName = this.dataset.subjectName;
        const type = this.dataset.type;
        
        console.log(`ポイント付与ボタンがクリックされました: 生徒ID = ${studentId}, ポイント = ${points}, 向上レベル = ${level}`);
        
        // ポイント付与API呼び出し
        awardImprovementPoints(studentId, points, type, improvement, level, subject, subjectName, this);
      });
    });
    
    // 生徒ログインボタンのイベントリスナーも設定
    setupAttendanceButtonListeners();
  }
  
  // ポイント付与API呼び出し
  function awardImprovementPoints(studentId, points, type, improvement, level, subject, subjectName, button) {
    // ボタンを無効化
    button.disabled = true;
    button.textContent = '処理中...';
    
    // イベントタイプの決定
    let eventType;
    if (type === 'elementary') {
      eventType = `grade_improvement_${level.toLowerCase()}`;
    } else {
      eventType = `internal_point_improvement_${level.toLowerCase()}`;
    }
    
    // コメントの作成
    let comment;
    if (type === 'elementary') {
      comment = `成績向上ボーナス（${level}）: ${subjectName}が${improvement}点向上`;
    } else {
      comment = `内申点向上ボーナス（${level}）: ${subjectName}が${improvement}ポイント向上`;
    }
    
    // APIデータ
    const apiData = {
      student_id: studentId,
      points: points,
      event_type: eventType,
      comment: comment,
      subject_id: subject
    };
    
    // ポイント付与APIを呼び出す
    fetch('/myapp/index.cgi/api/teacher/award-improvement-points', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(apiData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 成功メッセージ
        alert(`${points}ポイントを付与しました！`);
        
        // ボタンを変更（無効化したまま）
        button.textContent = 'ポイント付与済み';
        button.style.backgroundColor = '#cccccc';
      } else {
        // エラーメッセージ
        alert(`エラー: ${data.message}`);
        
        // ボタンを元に戻す
        button.disabled = false;
        button.textContent = `${points}ポイント付与 (${level}幅向上)`;
      }
    })
    .catch(error => {
      console.error('ポイント付与エラー:', error);
      alert(`ポイント付与中にエラーが発生しました: ${error.message}`);
      
      // ボタンを元に戻す
      button.disabled = false;
      button.textContent = `${points}ポイント付与 (${level}幅向上)`;
    });
  }
  
  // 生徒検索機能
  function setupStudentSearch() {
    const searchInput = document.getElementById('student-search');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      console.log("検索クエリ:", query);
      
      // 生徒カードを全て取得
      const studentCards = document.querySelectorAll('.student-card');
      
      studentCards.forEach(card => {
        const name = card.querySelector('.student-name').textContent.toLowerCase();
        const grade = card.querySelector('.student-grade').textContent.toLowerCase();
        
        // 学年の簡易表記も考慮（例："小3"で"小3年生"も検索できるように）
        let isMatch = name.includes(query) || grade.includes(query);
        
        // 学年の特別パターンを検索
        const schoolGradePatterns = [
          // 小学生パターン（小1～小6）
          { pattern: /小(\d)/, display: "小$1年生" },
          // 中学生パターン（中1～中3）
          { pattern: /中(\d)/, display: "中$1年生" },
          // 高校生パターン（高1～高3）
          { pattern: /高(\d)/, display: "高$1年生" }
        ];
        
        // 特別パターンの検索
        schoolGradePatterns.forEach(pattern => {
          const match = query.match(pattern.pattern);
          if (match) {
            const expectedGrade = pattern.display.replace('$1', match[1]);
            console.log(`検索パターン検出: ${query} → ${expectedGrade}`);
            if (grade.includes(expectedGrade)) {
              isMatch = true;
            }
          }
        });
        
        // 検索結果に基づいて表示/非表示を切り替え
        if (isMatch) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
      
      // 表示されている生徒カードがない場合、「検索結果がありません」メッセージを表示
      const visibleCards = Array.from(document.querySelectorAll('.student-card')).filter(card => card.style.display !== 'none').length;
      const studentList = document.getElementById('student-list');
      const noResultsMessage = studentList.querySelector('.no-results-message');
      
      if (visibleCards === 0 && query) {
        if (!noResultsMessage) {
          const message = document.createElement('div');
          message.className = 'empty-message no-results-message';
          message.textContent = `"${query}" に一致する生徒が見つかりません`;
          studentList.appendChild(message);
        }
      } else if (noResultsMessage) {
        noResultsMessage.remove();
      }
    });
  }
  
  // 学年タブと曜日タブの切り替え処理を設定
  function setupTabs() {
    // 学年タブ処理
    const gradeTabs = document.querySelectorAll('.grade-tab');
    gradeTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // アクティブタブの切り替え
        gradeTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // 選択された学年の取得
        const grade = this.dataset.grade;
        console.log(`学年タブ選択: ${grade}`);
        
        // 現在選択されている曜日タブを取得
        const activeDay = document.querySelector('.day-tab.active');
        const day = activeDay ? activeDay.dataset.day : 'all';
        
        // 学年と曜日の両方でフィルタリング
        updateStudentDisplay(grade, day);
      });
    });
    
    // 曜日タブ処理
    const dayTabs = document.querySelectorAll('.day-tab');
    dayTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // アクティブタブの切り替え
        dayTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // 選択された曜日の取得
        const day = this.dataset.day;
        console.log(`曜日タブ選択: ${day}`);
        
        // 現在選択されている学年タブを取得
        const activeGrade = document.querySelector('.grade-tab.active');
        const grade = activeGrade ? activeGrade.dataset.grade : 'all';
        
        // 学年と曜日の両方でフィルタリング
        updateStudentDisplay(grade, day);
      });
    });
  }
  
  // ページロード時の処理
  document.addEventListener('DOMContentLoaded', function() {
    // 今日の曜日を反映
    const today = new Date();
    const currentDayOfWeek = today.getDay(); // 0:日曜、1:月曜...
    
    // 本日の曜日タブをハイライト
    const todayTab = document.querySelector(`.day-tab[data-day="${currentDayOfWeek}"]`);
    if (todayTab) {
        todayTab.classList.add('today');
    }
    
    // 初期生徒リスト表示（全生徒）
    updateStudentDisplay('all', 'all');
    
    // タブ処理設定
    setupTabs();
    
    // 学年タブの表示を初期化
    const elementaryGrades = document.querySelectorAll('.elementary-grade');
    const middleGrades = document.querySelectorAll('.middle-grade');
    const highGrades = document.querySelectorAll('.high-grade');

    // 初期状態では詳細学年タブを非表示
    elementaryGrades.forEach(tab => tab.style.display = 'none');
    middleGrades.forEach(tab => tab.style.display = 'none');
    highGrades.forEach(tab => tab.style.display = 'none');

    // 学校種タブのクリックイベント追加
    document.querySelector('.grade-tab[data-grade="elementary"]').addEventListener('click', function() {
        elementaryGrades.forEach(tab => tab.style.display = 'block');
        middleGrades.forEach(tab => tab.style.display = 'none');
        highGrades.forEach(tab => tab.style.display = 'none');
    });

    document.querySelector('.grade-tab[data-grade="middle"]').addEventListener('click', function() {
        elementaryGrades.forEach(tab => tab.style.display = 'none');
        middleGrades.forEach(tab => tab.style.display = 'block');
        highGrades.forEach(tab => tab.style.display = 'none');
    });

    document.querySelector('.grade-tab[data-grade="high"]').addEventListener('click', function() {
        elementaryGrades.forEach(tab => tab.style.display = 'none');
        middleGrades.forEach(tab => tab.style.display = 'none');
        highGrades.forEach(tab => tab.style.display = 'block');
    });

    document.querySelector('.grade-tab[data-grade="all"]').addEventListener('click', function() {
        elementaryGrades.forEach(tab => tab.style.display = 'none');
        middleGrades.forEach(tab => tab.style.display = 'none');
        highGrades.forEach(tab => tab.style.display = 'none');
    });
    
    // 生徒検索機能
    setupStudentSearch();

    // 成績向上フィルタ設定
    setupImprovementFilter();
    
    // 一括出席確認ボタン
    const attendanceCheckBtn = document.getElementById('attendance-check-btn');
    if (attendanceCheckBtn) {
        attendanceCheckBtn.addEventListener('click', function() {
            console.log('一括出席確認ボタンがクリックされました');
            
            // 現在表示されている生徒の学年と曜日
            const activeGradeTab = document.querySelector('.grade-tab.active');
            const activeDayTab = document.querySelector('.day-tab.active');
            
            const grade = activeGradeTab ? activeGradeTab.dataset.grade : 'all';
            const day = activeDayTab ? activeDayTab.dataset.day : 'all';
            
            console.log(`選択中の学年:${grade}, 曜日:${day}`);
            
            // 生徒データを取得してモーダル表示
            const filters = {};
            if (grade !== 'all') filters.grade = grade;
            if (day !== 'all') filters.day = day;
            
            fetchStudents(filters)
                .then(students => {
                    console.log(`出席確認用に${students.length}人の生徒データを取得しました`);
                    showAttendanceModal(students);
                })
                .catch(error => {
                    console.error('生徒データ取得エラー:', error);
                    alert('生徒データの取得に失敗しました: ' + error.message);
                });
        });
    }
    
    // 出席モーダルの閉じるボタン
    const attendanceClose = document.querySelector('.attendance-close');
    if (attendanceClose) {
        attendanceClose.addEventListener('click', function() {
            document.getElementById('attendance-modal').style.display = 'none';
        });
    }
    
    // 出席モーダルの送信ボタン処理
    const attendanceSubmitBtn = document.getElementById('attendance-submit-btn');
    if (attendanceSubmitBtn) {
        attendanceSubmitBtn.addEventListener('click', function() {
            console.log('出席情報を保存ボタンがクリックされました');
            
            const dateInput = document.getElementById('attendance-date-input').value;
            const attendanceData = [];
            
            document.querySelectorAll('.attendance-row').forEach(row => {
                const studentId = row.dataset.id;
                const isClassDay = row.dataset.isClassDay === 'true';
                const selectedRadio = row.querySelector(`input[name="attendance-${studentId}"]:checked`);
                const status = selectedRadio ? selectedRadio.value : null;
                
                console.log(`生徒ID:${studentId}, 状態:${status}, 授業日:${isClassDay}`);
                
                // 出席状態が設定されているものだけを送信
                if (status && status !== 'none') {
                    attendanceData.push({
                        student_id: studentId,
                        status: status,
                        date: dateInput,
                        award_points: status === 'present' && isClassDay  // 出席かつ授業日の場合のみポイント付与
                    });
                }
            });
            
            console.log('送信する出席データ:', attendanceData);
            
            // ボタンを無効化
            this.disabled = true;
            this.textContent = '保存中...';
            
            // 実際にAPIを呼び出して保存
            saveAttendanceRecords(attendanceData)
                .then(result => {
                    console.log('出席記録保存結果:', result);
                    
                    // ポイント付与メッセージがある場合は表示
                    if (result.awarded_points) {
                        let message = `出席情報を保存しました。`;
                        if (result.awarded_points_count) {
                            message += `${result.awarded_points_count}人の生徒に${result.awarded_points}ポイントが付与されました。`;
                        } else {
                            message += `各生徒に${result.awarded_points}ポイントが付与されました。`;
                        }
                        alert(message);
                    } else {
                        alert(result.message || '出席情報を保存しました');
                    }
                    
                    document.getElementById('attendance-modal').style.display = 'none';
                    
                    // 生徒リストを更新
                    const activeGradeTab = document.querySelector('.grade-tab.active');
                    const activeDayTab = document.querySelector('.day-tab.active');
                    
                    const grade = activeGradeTab ? activeGradeTab.dataset.grade : 'all';
                    const day = activeDayTab ? activeDayTab.dataset.day : 'all';
                    
                    updateStudentDisplay(grade, day);
                })
                .catch(error => {
                    console.error('Error saving attendance:', error);
                    alert('出席情報の保存中にエラーが発生しました: ' + error.message);
                })
                .finally(() => {
                    // ボタンを元に戻す
                    this.disabled = false;
                    this.textContent = '出席情報を保存';
                });
        });
    }
    
    // モーダル外クリックで閉じる
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('attendance-modal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
        
        const gradeScheduleModal = document.getElementById('grade-schedule-modal');
        if (event.target === gradeScheduleModal) {
            gradeScheduleModal.style.display = 'none';
        }
    });
    
    // 学年別曜日設定ボタン
    const gradeScheduleBtn = document.getElementById('grade-schedule-btn');
    if (gradeScheduleBtn) {
        gradeScheduleBtn.addEventListener('click', function() {
            // 学年別曜日設定モーダルを表示
            document.getElementById('grade-schedule-modal').style.display = 'block';
            // 設定データを読み込む
            loadGradeSchedule();
        });
    }
    
    // 学年別曜日設定モーダルの閉じるボタン
    const gradeScheduleClose = document.querySelector('.grade-schedule-close');
    if (gradeScheduleClose) {
        gradeScheduleClose.addEventListener('click', function() {
            document.getElementById('grade-schedule-modal').style.display = 'none';
        });
    }
    
    // 学年別曜日設定の保存ボタン
    const gradeScheduleSaveBtn = document.getElementById('grade-schedule-save-btn');
    if (gradeScheduleSaveBtn) {
        gradeScheduleSaveBtn.addEventListener('click', saveGradeSchedule);
    }
    
    // 初期状態では、小学生フィルターを表示
    document.querySelector('.filter-tab[data-filter="elementary"]').click();
    
    // フィルターの初期値を設定
    // 小学生：前月と今月で比較するように初期設定
    const currentMonth = today.getMonth() + 1; // 0-indexed -> 1-indexed
    const prevMonth = currentMonth == 1 ? 12 : currentMonth - 1;
    
    document.getElementById('elementary-start-month').value = prevMonth;
    document.getElementById('elementary-end-month').value = currentMonth;
    
    // 中学生：初期値を設定（例：同じ学年の前学期と今学期）
    // 現在の学期を推定（日本の一般的な学期区分）
    let currentTerm = 1;
    if (today.getMonth() >= 4 && today.getMonth() <= 8) { // 5月〜9月
        currentTerm = 1;
    } else if (today.getMonth() >= 9 && today.getMonth() <= 11) { // 10月〜12月
        currentTerm = 2;
    } else { // 1月〜4月
        currentTerm = 3;
    }
    
    const prevTerm = currentTerm === 1 ? 3 : currentTerm - 1;
    const yearForPrevTerm = prevTerm === 3 ? 2 : 3; // 3学期の場合は前の学年を選択
    
    document.getElementById('middle-start-year').value = yearForPrevTerm;
    document.getElementById('middle-start-term').value = prevTerm;
    document.getElementById('middle-end-year').value = 3;
    document.getElementById('middle-end-term').value = currentTerm;
});

// Quick Links Enhanced Interactions
document.addEventListener('DOMContentLoaded', function() {
    const quickLinks = document.querySelectorAll('.quick-link');
    
    // パララックス効果とマウス追従
    quickLinks.forEach((link, index) => {
        // 遅延アニメーション開始
        setTimeout(() => {
            link.style.opacity = '1';
            link.style.transform = 'translateY(0)';
        }, 100 * (index + 1));
        
        // マウス追従効果を無効化（自動スクロール防止）
        // link.addEventListener('mousemove', (e) => {
        //     if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            
        //     const rect = link.getBoundingClientRect();
        //     const centerX = rect.left + rect.width / 2;
        //     const centerY = rect.top + rect.height / 2;
            
        //     const deltaX = (e.clientX - centerX) / rect.width * 10;
        //     const deltaY = (e.clientY - centerY) / rect.height * 10;
            
        //     link.style.transform = `translateY(-8px) scale(1.02) rotateX(${-deltaY}deg) rotateY(${deltaX}deg)`;
        // });
        
        // link.addEventListener('mouseleave', () => {
        //     if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        //         link.style.transform = 'none';
        //     } else {
        //         link.style.transform = 'translateY(0) scale(1) rotateX(0deg) rotateY(0deg)';
        //     }
        // });
        
        // クリック時のフィードバック
        link.addEventListener('click', (e) => {
            // リップル効果
            const ripple = document.createElement('div');
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(0, 255, 255, 0.6)';
            ripple.style.transform = 'scale(0)';
            /* ripple.style.animation = 'ripple 0.6s linear'; /* 無効化（自動スクロール防止） */
            ripple.style.pointerEvents = 'none';
            
            const rect = link.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
            
            link.style.position = 'relative';
            link.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
        
        // キーボードアクセシビリティ
        link.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                link.click();
            }
        });
    });
    
    // スクロール時の視差効果を無効化（自動スクロール防止）
    // const observerOptions = {
    //     threshold: [0, 0.25, 0.5, 0.75, 1],
    //     rootMargin: '0px 0px -100px 0px'
    // };
    
    // const quickLinksObserver = new IntersectionObserver((entries) => {
    //     entries.forEach(entry => {
    //         if (entry.isIntersecting) {
    //             const ratio = entry.intersectionRatio;
    //             const element = entry.target;
                
    //             if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    //                 element.style.opacity = Math.max(0.3, ratio);
    //                 element.style.transform = `translateY(${(1 - ratio) * 20}px)`;
    //             }
    //         }
    //     });
    // }, observerOptions);
    
    // quickLinks.forEach(link => {
    //     quickLinksObserver.observe(link);
    // });
    
    // リップルアニメーション用CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .quick-link {
            overflow: hidden;
        }
        
        /* パフォーマンス最適化 */
        .quick-link {
            will-change: transform, opacity;
            transform: translateZ(0);
        }
        
        /* 高コントラストモード対応 */
        @media (prefers-contrast: high) {
            .quick-link {
                border: 2px solid currentColor;
            }
            
            .quick-link .icon {
                filter: none;
                color: currentColor;
            }
        }
        
        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            .quick-link {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
                border-color: rgba(255, 255, 255, 0.1);
            }
        }
        
        /* フォーカス表示の改善 */
        .quick-link:focus-visible {
            outline: 3px solid var(--cyber-primary);
            outline-offset: 2px;
        }
    `;
    document.head.appendChild(style);
    
    // パフォーマンス監視
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
            console.log('Quick Links enhanced interactions loaded');
        });
    }
    
    // エラーハンドリング
    window.addEventListener('error', (e) => {
        if (e.filename && e.filename.includes('teacher_dashboard')) {
            console.warn('Quick Links interaction error:', e.message);
        }
    });
    
    // テーマ切り替え機能
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    
    // 保存されたテーマの読み込み
    const savedTheme = localStorage.getItem('dashboardTheme') || 'dark';
    setTheme(savedTheme);
    
    // テーマ切り替えボタンのクリックイベント
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('dashboardTheme', newTheme);
        });
    }
    
    function setTheme(theme) {
        if (theme === 'light') {
            body.classList.add('light-mode');
            body.classList.remove('dark-mode');
            if (themeToggle) {
                themeToggle.querySelector('i').className = 'fas fa-sun';
                themeToggle.setAttribute('title', 'ダークモードに切り替え');
            }
        } else {
            body.classList.add('dark-mode');
            body.classList.remove('light-mode');
            if (themeToggle) {
                themeToggle.querySelector('i').className = 'fas fa-moon';
                themeToggle.setAttribute('title', 'ライトモードに切り替え');
            }
        }
    }
});
</script>

<style>
/* パネルヘッダー改善 */
.panel-header {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--glass-border);
  margin-bottom: 25px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.panel-header-left {
  display: flex;
  align-items: center;
}

.panel-header-icon {
  margin-right: 10px;
  font-size: 24px;
  color: var(--cyber-primary);
  filter: drop-shadow(0 0 5px var(--cyber-primary));
}

/* テーマ切り替えボタン */
.theme-toggle-btn {
  background: linear-gradient(135deg, var(--glass-bg), rgba(255, 255, 255, 0.1));
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--cyber-primary);
  position: relative;
  overflow: hidden;
}

.theme-toggle-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--cyber-primary), var(--neon-pink));
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* 無効化（自動スクロール防止）: theme-toggle-btn hover effects
.theme-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
}

.theme-toggle-btn:hover::before {
  opacity: 0.1;
}
*/

.theme-toggle-btn i {
  position: relative;
  z-index: 1;
  font-size: 18px;
  transition: all 0.3s ease;
}

/* 無効化（自動スクロール防止）: theme-toggle-btn i hover effects
.theme-toggle-btn:hover i {
  color: white;
  filter: drop-shadow(0 0 5px currentColor);
}
*/  /* ダークモード時のスタイル */
  body.dark-mode .theme-toggle-btn i::before {
    content: '\f185'; /* sun icon */
  }
  
  /* ライトモード時の追加スタイル */
  body.light-mode {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
    color: #333 !important;
  }
  
  body.light-mode .dashboard-container {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
  }
  
  body.light-mode .header {
    background: rgba(255, 255, 255, 0.9) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .header h1 {
    color: #333 !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .panel {
    background: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .panel-header h2 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link {
    background: rgba(255, 255, 255, 0.7) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
  }
  
  body.light-mode .quick-link:hover {
    background: rgba(255, 255, 255, 0.9) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
  }
  
  body.light-mode .quick-link h3 {
    color: #333 !important;
  }
  
  body.light-mode .quick-link p {
    color: #666 !important;
  }
  
  body.light-mode .quick-link .icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // テーマ切り替え機能
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    
    // 保存されたテーマの読み込み
    const savedTheme = localStorage.getItem('dashboardTheme') || 'dark';
    setTheme(savedTheme);
    
    // テーマ切り替えボタンのクリックイベント
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('dashboardTheme', newTheme);
        });
    }
    
    function setTheme(theme) {
        if (theme === 'light') {
            body.classList.add('light-mode');
            body.classList.remove('dark-mode');
            if (themeToggle) {
                themeToggle.querySelector('i').className = 'fas fa-sun';
                themeToggle.setAttribute('title', 'ダークモードに切り替え');
            }
        } else {
            body.classList.add('dark-mode');
            body.classList.remove('light-mode');
            if (themeToggle) {
                themeToggle.querySelector('i').className = 'fas fa-moon';
                themeToggle.setAttribute('title', 'ライトモードに切り替え');
            }
        }
    }
});
</script>
{% endblock %}