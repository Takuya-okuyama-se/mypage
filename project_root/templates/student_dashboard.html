{% extends "base.html" %}

{% block head_extra %}
<style>
  /* ãƒ¢ãƒ€ãƒ³ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
  .login-bonus-notification {
    background: linear-gradient(135deg, #d7f0fd, #e8f5fd);
    border-left: 4px solid var(--primary);
    animation: pulse-light 2s infinite;
  }
  
  @keyframes pulse-light {
    0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
    100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
  }
  
  /* ã‚¹ãƒãƒ›å¯¾å¿œã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
  #calendar {
    max-width: 900px;
    margin: 0 auto;
    background-color: white;
    padding: 10px;
    min-height: 480px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®èª¿æ•´ */
  @media screen and (max-width: 768px) {
    #calendar {
      padding: 5px;
      min-height: 400px;
      margin: 0 -10px; /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ */
      width: calc(100% + 20px); /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ */
      border-radius: 8px;
    }
    
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®èª¿æ•´ */
    .fc .fc-toolbar.fc-header-toolbar {
      flex-direction: column;
      gap: 8px;
      margin-bottom: 0.8em;
    }
    
    .fc .fc-toolbar-title {
      font-size: 1.2em;
      text-align: center;
      width: 100%;
      margin-bottom: 5px;
    }
    
    .fc-header-toolbar .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
      margin-bottom: 5px;
    }
    
    /* æ—¥ä»˜ã‚»ãƒ«ã®èª¿æ•´ */
    .fc .fc-daygrid-day {
      height: auto !important;
      min-height: 2em;
    }
    
    /* ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
    .fc-event-title {
      font-size: 0.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* æ—¥ä»˜ã®è¡¨ç¤ºã‚’å°ã•ã */
    .fc-daygrid-day-number {
      font-size: 0.9em;
      padding: 2px !important;
    }
    
    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¿æ•´ */
    .fc .fc-button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .fc-direction-ltr .fc-button-group > .fc-button {
      padding: 0.25em 0.55em;
      font-size: 0.9em;
    }
    
    /* ãŠçŸ¥ã‚‰ã›ã‚«ãƒ¼ãƒ‰ã®èª¿æ•´ */
    .notification-item {
      padding: 15px;
      margin-bottom: 12px;
    }
    
    /* å¿—æœ›æ ¡è¡¨ç¤ºã®æœ€é©åŒ– */
    .school-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .school-details {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    /* ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã®å¼·åŒ– */
    .bonus-content {
      flex-direction: column;
      text-align: center;
    }
    
    .bonus-icon {
      margin-right: 0;
      margin-bottom: 15px;
      font-size: 42px;
    }
    
    .bonus-link {
      width: 100%;
      text-align: center;
      padding: 10px;
    }
  }
  
  @media screen and (max-width: 480px) {
    /* å°å‹ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®è¿½åŠ èª¿æ•´ */
    #calendar {
      min-height: 350px;
    }
    
    .fc-toolbar-title {
      font-size: 1em !important;
    }
    
    .fc .fc-button {
      padding: 0.2em 0.5em;
      font-size: 0.85em;
    }
    
    .school-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .school-course {
      margin-left: 0;
      margin-top: 5px;
    }
    
    .school-name {
      font-size: 1em;
    }
  }
  
  /* å¿—æœ›æ ¡ã‚¹ã‚¿ã‚¤ãƒ« */
  .preference-list {
    margin-top: 10px;
  }
  
  .school-item {
    border-left: 4px solid #4285f4;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }
  
  .school-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }
  
  .school-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  
  .preference-order {
    background-color: #4285f4;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    margin-right: 8px;
    font-weight: bold;
  }
  
  .school-name {
    font-weight: bold;
    font-size: 1.1em;
  }
  
  .school-course {
    font-size: 0.9em;
    color: #666;
    margin-left: 5px;
  }
  
  .school-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
    margin-top: 8px;
    font-size: 0.9em;
  }
  
  .detail-label {
    color: #555;
  }
  
  .detail-value {
    font-weight: bold;
  }
  
  .point-difference {
    margin-top: 8px;
    padding: 5px;
    border-radius: 4px;
    font-weight: bold;
  }
  
  .point-difference.positive {
    background-color: #d4edda;
    color: #155724;
  }
  
  .point-difference.negative {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .login-bonus-notification {
    background-color: #e3f2fd;
    border-left: 5px solid #4285f4;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite alternate;
  }
  
  .bonus-content {
    display: flex;
    align-items: center;
  }
  
  .bonus-icon {
    font-size: 48px;
    margin-right: 20px;
    color: #4285f4;
  }
  
  .bonus-text h3 {
    color: #4285f4;
    margin-top: 0;
  }
  
  .bonus-points {
    font-size: 1.2em;
    font-weight: bold;
    color: #34a853;
  }
  
  .bonus-link {
    display: inline-block;
    background-color: #4285f4;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 5px;
  }
  
  .bonus-link:hover {
    background-color: #3367d6;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4); }
    100% { box-shadow: 0 0 0 10px rgba(66, 133, 244, 0); }
  }
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  .table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* ã‚¹ãƒãƒ›å‘ã‘ã®ãƒ†ãƒ¼ãƒ–ãƒ«èª¿æ•´ */
  @media screen and (max-width: 768px) {
    .data-table {
      min-width: 500px; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ãªã»ã©ååˆ†ãªå¹…ã‚’ç¢ºä¿ */
    }
    
    .data-table th,
    .data-table td {
      padding: 5px;
      font-size: 0.9em;
    }
  }
  
  /* åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
  .fc-header-toolbar .fc-toolbar-chunk {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }
  
  /* æ—¥ä»˜ã‚»ãƒ«ã®èª¿æ•´ */
  .fc .fc-daygrid-day {
    height: auto !important;
    min-height: 2em;
  }
  
  /* ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  .fc-event-title {
    font-size: 0.8em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* æ—¥ä»˜ã®è¡¨ç¤ºã‚’å°ã•ã */
  .fc-daygrid-day-number {
    font-size: 0.9em;
    padding: 2px !important;
  }
  
  /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¿æ•´ */
  .fc .fc-button-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
</style>
{% endblock %}

{% block content %}
{% if login_bonus %}
<div class="card login-bonus-notification">
  <div class="bonus-content">
    <div class="bonus-icon">ğŸ‰</div>
    <div class="bonus-text">
      <h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ç²å¾—ï¼</h3>
      <p>æœ¬æ—¥ã®ãƒ­ã‚°ã‚¤ãƒ³ã§ <span class="bonus-points">{{ login_bonus }}</span> ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ãŸï¼</p>
      <p><a href="/myapp/index.cgi/student/points" class="bonus-link">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’ç¢ºèªã™ã‚‹</a></p>
    </div>
  </div>
</div>
{% endif %}

<div class="card">
  {% if is_teacher_login or teacher_view %}
<div class="alert alert-info">
  <p>ã‚ãªãŸã¯ç¾åœ¨ã€è¬›å¸«ã¨ã—ã¦ç”Ÿå¾’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚</p>
  {% if is_teacher_login %}
  <a href="/myapp/index.cgi/student/return-to-teacher" class="btn btn-primary">è¬›å¸«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æˆ»ã‚‹</a>
  {% else %}
  {% set student_id = request.args.get('id') %}
  <a href="/myapp/index.cgi/teacher/dashboard" class="btn btn-primary">è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  {% endif %}
</div>
{% endif %}
  <h3><i class="fas fa-bell"></i> ãŠçŸ¥ã‚‰ã›</h3>
  {% if notifications %}
    <ul class="notification-list">
      {% for note in notifications %}
        <li class="notification-item">
          <div class="notification-date">{{ note.created_at }}</div>
          <div class="notification-content">
            <div class="notification-message">{{ note.message }}</div>
            <div class="notification-author">{{ note.teacher_name }}</div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
  {% endif %}
</div>

<div class="card">
  <h3>å¡¾ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.js"></script>
  <div id="calendar"></div>
  <script>
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã‚’å–å¾—
    var calendarEl = document.getElementById('calendar');
    
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    var checkFullCalendarInterval = setInterval(function() {
      if (typeof FullCalendar !== 'undefined') {
        clearInterval(checkFullCalendarInterval);
        console.log('FullCalendarãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        
        // ãƒ¢ãƒã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        var isMobile = window.innerWidth < 768;
        
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: isMobile ? 'listMonth' : 'dayGridMonth', // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
          locale: 'ja',
          firstDay: 1,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
          },
          buttonText: {
            today: 'ä»Šæ—¥',
            month: 'æœˆ',
            list: 'ãƒªã‚¹ãƒˆ'
          },
          height: isMobile ? 'auto' : 'auto',
          contentHeight: isMobile ? 'auto' : 'auto',
          aspectRatio: isMobile ? 1.2 : 1.35, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®èª¿æ•´
          fixedWeekCount: false,
          events: '/myapp/index.cgi/api/calendar-events',
          // ã‚¹ãƒãƒ›å‘ã‘ã«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
          eventDisplay: isMobile ? 'block' : 'auto',
          eventTimeFormat: {
            hour: 'numeric',
            minute: '2-digit',
            meridiem: false
          },
          // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®æœ€é©åŒ–
          eventMaxStack: isMobile ? 2 : 6,
          dayMaxEvents: isMobile ? 2 : true,
          // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚µã‚¤ã‚ºã«å¿œã˜ãŸãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚µã‚¤ã‚º
          windowResize: function(view) {
            var newIsMobile = window.innerWidth < 768;
            if (newIsMobile !== isMobile) {
              isMobile = newIsMobile;
              calendar.changeView(isMobile ? 'listMonth' : 'dayGridMonth');
              calendar.setOption('eventMaxStack', isMobile ? 2 : 6);
              calendar.setOption('dayMaxEvents', isMobile ? 2 : true);
            }
          },
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°æƒ…å ±
            var details = '';
            
            // æ—¥æ™‚è¡¨ç¤º
            if (info.event.allDay) {
              // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ
              var start = new Date(info.event.start);
              var options = { year: 'numeric', month: 'long', day: 'numeric' };
              var dateStr = start.toLocaleDateString('ja-JP', options);
              
              if (info.event.end) {
                var end = new Date(info.event.end);
                end.setDate(end.getDate() - 1);
                if (start.getTime() !== end.getTime()) {
                  dateStr += ' ã€œ ' + end.toLocaleDateString('ja-JP', options);
                }
              }
              
              details += 'æ—¥ä»˜: ' + dateStr;
            } else {
              // æ™‚é–“æŒ‡å®šã‚¤ãƒ™ãƒ³ãƒˆ
              var start = new Date(info.event.start);
              var dateTimeStr = start.toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric'
              });
              dateTimeStr += ' ' + start.toLocaleTimeString('ja-JP', {
                hour: '2-digit', minute: '2-digit'
              });
              
              if (info.event.end) {
                var end = new Date(info.event.end);
                if (start.toDateString() === end.toDateString()) {
                  // åŒã˜æ—¥ã®å ´åˆã¯æ™‚é–“ã ã‘è¡¨ç¤º
                  dateTimeStr += ' ã€œ ' + end.toLocaleTimeString('ja-JP', {
                    hour: '2-digit', minute: '2-digit'
                  });
                } else {
                  // ç•°ãªã‚‹æ—¥ã®å ´åˆã¯æ—¥ä»˜ã¨æ™‚é–“ã‚’è¡¨ç¤º
                  dateTimeStr += ' ã€œ ' + end.toLocaleDateString('ja-JP', {
                    year: 'numeric', month: 'long', day: 'numeric'
                  });
                  dateTimeStr += ' ' + end.toLocaleTimeString('ja-JP', {
                    hour: '2-digit', minute: '2-digit'
                  });
                }
              }
              
              details += 'æ—¥æ™‚: ' + dateTimeStr;
            }
            
            // å ´æ‰€æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
            if (info.event.extendedProps && info.event.extendedProps.location) {
              details += '\n\nå ´æ‰€: ' + info.event.extendedProps.location;
            }
            
            // èª¬æ˜æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
            if (info.event.extendedProps && info.event.extendedProps.description) {
              details += '\n\n' + info.event.extendedProps.description;
            }
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            alert(info.event.title + '\n\n' + details);
          }
        });
        
        calendar.render();
        console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
      }
    }, 100);
    
    // 10ç§’å¾Œã«ã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    setTimeout(function() {
      if (typeof FullCalendar === 'undefined') {
        clearInterval(checkFullCalendarInterval);
        console.error('FullCalendarãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        calendarEl.innerHTML = '<p style="color:red; padding:20px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
      }
    }, 10000);
  </script>
</div>

<!-- å°å­¦5ãƒ»6å¹´ç”Ÿå‘ã‘å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
{% if school_type == 'elementary' and grade_level in [5, 6] %}
<div class="card">
  <h3><i class="fas fa-calendar-check"></i> å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå°å­¦5ãƒ»6å¹´ç”Ÿå°‚ç”¨ï¼‰</h3>
  <p style="color: #666; margin-bottom: 20px;">
    ğŸ“š ã‚ãªãŸã®å®¿é¡Œã‚’ç¢ºèªã—ã¦ã€æå‡ºã—ã¾ã—ã‚‡ã†ï¼æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    <br><small style="color: #999;">â€»ã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ä¸Šã®å¡¾ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã¯åˆ¥ã®ã‚‚ã®ã§ã™</small>
  </p>
  
  <!-- å®¿é¡Œçµ±è¨ˆ -->
  <div class="homework-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="stat-card" style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="completed-count">0</div>
      <div style="color: #666; font-size: 14px;">ä»Šæœˆå®Œäº†</div>
    </div>
    <div class="stat-card" style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="pending-count">0</div>
      <div style="color: #666; font-size: 14px;">æœªå®Œäº†</div>
    </div>
    <div class="stat-card" style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #17a2b8;" id="points-earned">0</div>
      <div style="color: #666; font-size: 14px;">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</div>
    </div>
  </div>
  
  <!-- æœˆé¸æŠã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="homework-controls" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px;">
    <button id="prev-month" class="btn btn-outline-primary" style="padding: 8px 15px;">
      <i class="fas fa-chevron-left"></i> å‰æœˆ
    </button>
    <h4 id="current-month-year" style="margin: 0; color: #333;">2025å¹´5æœˆ</h4>
    <button id="next-month" class="btn btn-outline-primary" style="padding: 8px 15px;">
      æ¬¡æœˆ <i class="fas fa-chevron-right"></i>
    </button>
  </div>
  
  <!-- å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div id="homework-calendar" style="border: 1px solid #dee2e6; border-radius: 8px; background: white; min-height: 300px;">
    <div style="text-align: center; padding: 50px; color: #999;">
      <i class="fas fa-spinner fa-spin"></i> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...
    </div>
  </div>
  
  <!-- å®¿é¡Œãƒªã‚¹ãƒˆ -->
  <div style="margin-top: 20px;">
    <h4 style="color: #333; margin-bottom: 15px;">ä»Šæœˆã®å®¿é¡Œä¸€è¦§</h4>
    <div id="homework-list" style="max-height: 300px; overflow-y: auto;">
      <!-- å®¿é¡Œãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
    </div>
  </div>
</div>

<style>
/* å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.homework-calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #007bff; /* å¡¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã®åŒºåˆ¥ */
  box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.homework-day {
  background: white;
  min-height: 60px;
  padding: 8px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease;
}

.homework-calendar-cell {
  /* å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã‚»ãƒ«ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
  border: 1px solid transparent;
}

.homework-calendar-cell:hover {
  background: #f8f9fa;
  border-color: #007bff;
}

.homework-day:hover {
  background: #f8f9fa;
}

.homework-day.other-month {
  background: #f8f9fa;
  color: #999;
}

.homework-day.today {
  background: #e3f2fd;
  border: 2px solid #4285f4;
}

.day-number {
  font-weight: bold;
  margin-bottom: 4px;
}

.homework-indicator {
  position: absolute;
  bottom: 4px;
  right: 4px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #ffc107;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  color: white;
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.homework-indicator.completed {
  background: #28a745;
}

.homework-item {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
  transition: all 0.2s ease;
}

.homework-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.homework-item.completed {
  background: #e8f5e8;
  border-color: #28a745;
}

.homework-subject {
  font-weight: bold;
  color: #333;
  margin-bottom: 4px;
}

.homework-details {
  color: #666;
  font-size: 14px;
  margin-bottom: 8px;
}

.homework-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.btn-submit {
  background: #28a745;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.btn-submit:hover {
  background: #218838;
}

.btn-submit:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.homework-status {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 12px;
  background: #28a745;
  color: white;
}

@media screen and (max-width: 768px) {
  .homework-controls {
    flex-direction: column;
    gap: 10px;
  }
  
  .homework-stats {
    grid-template-columns: 1fr;
  }
  
  .homework-day {
    min-height: 50px;
    padding: 4px;
    font-size: 12px;
  }
}
</style>

<script>
// DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸‹éƒ¨ã§çµ±åˆå‡¦ç†ã•ã‚Œã‚‹

let currentHomeworkMonth = new Date().getMonth() + 1;
let currentHomeworkYear = new Date().getFullYear();

function initializeHomeworkCalendar() {
  console.log('å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™');
  
  // æœˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById('prev-month').addEventListener('click', function() {
    currentHomeworkMonth--;
    if (currentHomeworkMonth < 1) {
      currentHomeworkMonth = 12;
      currentHomeworkYear--;
    }
    loadHomeworkCalendar();
  });
  
  document.getElementById('next-month').addEventListener('click', function() {
    currentHomeworkMonth++;
    if (currentHomeworkMonth > 12) {
      currentHomeworkMonth = 1;
      currentHomeworkYear++;
    }
    loadHomeworkCalendar();
  });
  
  // åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿
  loadHomeworkCalendar();
}

function loadHomeworkCalendar() {
  console.log('ğŸ”„ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°é–‹å§‹');
  updateMonthDisplay();
  renderHomeworkCalendar();
  
  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’é †åºå®Ÿè¡Œã—ã€å®Œäº†å¾Œã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
  loadHomeworkData().then(() => {
    console.log('ğŸ“Š å®¿é¡Œãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ã€ãƒªã‚¹ãƒˆæ›´æ–°é–‹å§‹');
    loadHomeworkList();
    console.log('âœ… å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å®Œå…¨æ›´æ–°å®Œäº†');
  }).catch(error => {
    console.error('âŒ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒªã‚¹ãƒˆã¯æ›´æ–°ã‚’è©¦è¡Œ
    loadHomeworkList();
  });
}

function updateMonthDisplay() {
  const monthNames = [
    '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ',
    '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'
  ];
  document.getElementById('current-month-year').textContent = 
    `${currentHomeworkYear}å¹´${monthNames[currentHomeworkMonth - 1]}`;
}

function renderHomeworkCalendar() {
  const calendar = document.getElementById('homework-calendar');
  const today = new Date();
  const firstDay = new Date(currentHomeworkYear, currentHomeworkMonth - 1, 1);
  const lastDay = new Date(currentHomeworkYear, currentHomeworkMonth, 0);
  const daysInMonth = lastDay.getDate();
  const startDay = firstDay.getDay(); // 0 = Sunday
  
  let calendarHTML = `
    <div class="homework-calendar">
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">æ—¥</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">æœˆ</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">ç«</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">æ°´</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">æœ¨</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">é‡‘</div>
      <div style="background: #f8f9fa; padding: 8px; font-weight: bold; text-align: center;">åœŸ</div>
  `;
  
  // å‰æœˆã®æ—¥ä»˜ã‚’è¡¨ç¤º
  const prevMonth = new Date(currentHomeworkYear, currentHomeworkMonth - 2, 0);
  const prevMonthDays = prevMonth.getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    calendarHTML += `
      <div class="homework-day homework-calendar-cell other-month" data-homework-calendar="true">
        <div class="day-number">${day}</div>
      </div>
    `;
  }
  
  // ç¾åœ¨ã®æœˆã®æ—¥ä»˜ã‚’è¡¨ç¤º
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(currentHomeworkYear, currentHomeworkMonth - 1, day);
    const isToday = date.toDateString() === today.toDateString();
    const dateStr = `${currentHomeworkYear}-${String(currentHomeworkMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    calendarHTML += `
      <div class="homework-day homework-calendar-cell ${isToday ? 'today' : ''}" data-date="${dateStr}" data-homework-calendar="true">
        <div class="day-number">${day}</div>
      </div>
    `;
  }
  
  // æ¬¡æœˆã®æ—¥ä»˜ã‚’è¡¨ç¤º
  const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
  const remainingCells = totalCells - (startDay + daysInMonth);
  for (let day = 1; day <= remainingCells; day++) {
    calendarHTML += `
      <div class="homework-day homework-calendar-cell other-month" data-homework-calendar="true">
        <div class="day-number">${day}</div>
      </div>
    `;
  }
  
  calendarHTML += '</div>';
  calendar.innerHTML = calendarHTML;
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function buildApiParams(baseParams = {}) {
  const urlParams = new URLSearchParams(window.location.search);
  const teacherView = urlParams.get('teacher_view');
  const studentId = urlParams.get('id');
  
  const params = { ...baseParams };
  
  if (teacherView === 'true' && studentId) {
    params.teacher_view = 'true';
    params.id = studentId;
  }
  
  return new URLSearchParams(params).toString();
}

function loadHomeworkData() {
  console.log(`ğŸ” å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­: year=${currentHomeworkYear}, month=${currentHomeworkMonth}`);
  
  const baseParams = {
    year: currentHomeworkYear,
    month: currentHomeworkMonth
  };
  const queryString = buildApiParams(baseParams);
  const apiUrl = `/myapp/index.cgi/api/student/homework/calendar?${queryString}`;
  console.log(`ğŸ“¡ API URL: ${apiUrl}`);
  
  return fetch(apiUrl, {
    method: 'GET',
    credentials: 'same-origin', // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚ã‚‹
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  })
    .then(response => {
      console.log('ğŸ“¡ APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText, response.url);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã‹ãƒã‚§ãƒƒã‚¯
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('APIã‹ã‚‰JSONä»¥å¤–ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
      }
      
      return response.json();
    })
    .then(data => {
      console.log('ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
      if (data.success) {
        console.log(`âœ… å®¿é¡Œãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${data.homework.length}ä»¶`);
        displayHomeworkOnCalendar(data.homework);
        updateHomeworkStats(data.homework);
        return data.homework; // ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
      } else {
        console.error('âŒ å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', data.message);
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
        const calendar = document.getElementById('homework-calendar');
        if (calendar) {
          calendar.innerHTML = `<div style="text-align: center; padding: 50px; color: #dc3545;">
            <i class="fas fa-exclamation-triangle"></i><br>
            ${data.message || 'å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}
          </div>`;
        }
        throw new Error(data.message || 'å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('âŒ å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®fetchä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
      const calendar = document.getElementById('homework-calendar');
      if (calendar) {
        calendar.innerHTML = `<div style="text-align: center; padding: 50px; color: #dc3545;">
          <i class="fas fa-exclamation-triangle"></i><br>
          ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯APIã‚¨ãƒ©ãƒ¼<br>
          <small style="color: #666;">${error.message}</small>
        </div>`;
      }
      throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
    });
}

function displayHomeworkOnCalendar(homeworkList) {
  console.log('ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å®¿é¡Œã‚’è¡¨ç¤ºé–‹å§‹:', homeworkList?.length || 0, 'ä»¶');
  
  // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã®æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
  document.querySelectorAll('#homework-calendar .homework-indicator').forEach(indicator => {
    indicator.remove();
  });
  
  // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã®æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚‚ã‚¯ãƒªã‚¢ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
  document.querySelectorAll('#homework-calendar .homework-calendar-cell').forEach(dayCell => {
    // æ–°ã—ã„elementã‚’ä½œæˆã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newElement = dayCell.cloneNode(true);
    dayCell.parentNode.replaceChild(newElement, dayCell);
  });
  
  if (!homeworkList || homeworkList.length === 0) {
    console.log('ğŸ“ è¡¨ç¤ºã™ã‚‹å®¿é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºå®Œäº†');
    return;
  }
  
  // æ—¥ä»˜ã”ã¨ã«å®¿é¡Œã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const homeworkByDate = {};
  homeworkList.forEach(hw => {
    const date = hw.assigned_date;
    console.log(`ğŸ“š å®¿é¡Œ: ${date} - ${hw.subject} - ${hw.topic} - å®Œäº†:${hw.completed}`);
    if (!homeworkByDate[date]) {
      homeworkByDate[date] = [];
    }
    homeworkByDate[date].push(hw);
  });
  
  console.log('ğŸ“‹ æ—¥ä»˜åˆ¥å®¿é¡Œ:', homeworkByDate);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å®¿é¡Œã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
  Object.keys(homeworkByDate).forEach(date => {
    // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã®ã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨
    const dayCell = document.querySelector(`#homework-calendar .homework-calendar-cell[data-date="${date}"]`);
    console.log(`ğŸ” æ—¥ä»˜ ${date} ã®ã‚»ãƒ«æ¤œç´¢:`, dayCell ? 'è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    
    if (dayCell && dayCell.classList.contains('homework-day') && dayCell.getAttribute('data-homework-calendar') === 'true') {
      const homework = homeworkByDate[date];
      const completedCount = homework.filter(hw => hw.completed).length;
      const totalCount = homework.length;
      
      // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
      const existingIndicator = dayCell.querySelector('.homework-indicator');
      if (existingIndicator) {
        existingIndicator.remove();
      }
      
      const indicator = document.createElement('div');
      indicator.className = `homework-indicator ${completedCount === totalCount ? 'completed' : ''}`;
      indicator.title = `å®¿é¡Œ ${completedCount}/${totalCount} å®Œäº†`;
      indicator.innerHTML = `<span style="font-size: 10px;">${totalCount}</span>`;
      dayCell.appendChild(indicator);
      
      console.log(`âœ… ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¿½åŠ : ${date} - ${totalCount}ä»¶ (å®Œäº†:${completedCount})`);
      
      // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      dayCell.setAttribute('data-homework-date', date);
      
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
      const newDayCell = dayCell.cloneNode(true);
      dayCell.parentNode.replaceChild(newDayCell, dayCell);
      
      // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ–°ã—ã„ã‚»ãƒ«ã«å†è¿½åŠ 
      newDayCell.appendChild(indicator);
      
      // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆå®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ï¼‰
      newDayCell.addEventListener('click', function(e) {
        // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã§ã®ã‚¯ãƒªãƒƒã‚¯ã‹ã©ã†ã‹ã‚’ç¢ºèª
        if (e.target.closest('#homework-calendar') && 
            e.target.closest('.homework-calendar-cell')) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('ğŸ–±ï¸ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯:', date);
          showHomeworkDetail(date, homework);
        }
      }, { once: false, passive: false });
    } else {
      console.log(`âŒ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ ${date} ã®ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    }
  });
  
  console.log('âœ… å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºå®Œäº† - å…¨', Object.keys(homeworkByDate).length, 'æ—¥åˆ†å‡¦ç†');
}

function updateHomeworkStats(homeworkList) {
  const completed = homeworkList.filter(hw => hw.completed).length;
  const pending = homeworkList.filter(hw => !hw.completed).length;
  const points = homeworkList.filter(hw => hw.completed).reduce((sum, hw) => sum + (hw.points_awarded || 0), 0);
  
  document.getElementById('completed-count').textContent = completed;
  document.getElementById('pending-count').textContent = pending;
  document.getElementById('points-earned').textContent = points;
}

function loadHomeworkList() {
  console.log('ğŸ“‹ å®¿é¡Œãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
  
  const baseParams = { limit: 10 };
  const queryString = buildApiParams(baseParams);
  const apiUrl = `/myapp/index.cgi/api/student/homework/list?${queryString}`;
  
  fetch(apiUrl, {
    method: 'GET',
    credentials: 'same-origin',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  })
    .then(response => {
      console.log('ğŸ“‹ å®¿é¡Œãƒªã‚¹ãƒˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('APIã‹ã‚‰JSONä»¥å¤–ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
      }
      
      return response.json();
    })
    .then(data => {
      console.log('ğŸ“‹ å®¿é¡Œãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', data);
      if (data.success) {
        displayHomeworkList(data.homework);
      } else {
        console.error('å®¿é¡Œãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', data.message);
        const listContainer = document.getElementById('homework-list');
        if (listContainer) {
          listContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">
            <i class="fas fa-info-circle"></i><br>
            ${data.message || 'å®¿é¡Œãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}
          </div>`;
        }
      }
    })
    .catch(error => {
      console.error('âŒ å®¿é¡Œãƒªã‚¹ãƒˆå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
      const listContainer = document.getElementById('homework-list');
      if (listContainer) {
        listContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
          <i class="fas fa-exclamation-triangle"></i><br>
          ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯APIã‚¨ãƒ©ãƒ¼<br>
          <small style="color: #666;">${error.message}</small>
        </div>`;
      }
    });
}

function displayHomeworkList(homeworkList) {
  console.log('ğŸ“„ å®¿é¡Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤º:', homeworkList);
  const listContainer = document.getElementById('homework-list');
  
  if (!homeworkList || homeworkList.length === 0) {
    console.log('ğŸ“ è¡¨ç¤ºã™ã‚‹å®¿é¡Œãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
    listContainer.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #999;">
        <i class="fas fa-clipboard-list"></i>
        <p>å®¿é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</p>
      </div>
    `;
    return;
  }
  
  let listHTML = '';
  homeworkList.forEach(hw => {
    const isCompleted = hw.completed;
    listHTML += `
      <div class="homework-item ${isCompleted ? 'completed' : ''}">
        <div class="homework-subject">${hw.subject}</div>
        <div class="homework-details">
          ${hw.textbook} - ${hw.topic}
          ${hw.pages ? `(${hw.pages})` : ''}
          <br>
          <small>å‡ºé¡Œæ—¥: ${hw.assigned_date_formatted || hw.assigned_date}</small>
        </div>
        <div class="homework-actions">
          <div class="homework-status ${isCompleted ? 'completed' : 'pending'}">
            ${isCompleted ? 
              '<i class="fas fa-check-circle"></i> å®Œäº†æ¸ˆã¿' : 
              '<i class="fas fa-clock"></i> æœªå®Œäº†'
            }
          </div>
        </div>
      </div>
    `;
  });
  
  listContainer.innerHTML = listHTML;
}

function showHomeworkDetail(date, homeworkList) {
  let details = `${date}ã®å®¿é¡Œ:\n\n`;
  homeworkList.forEach((hw, index) => {
    details += `${index + 1}. ã€${hw.subject}ã€‘${hw.topic}\n`;
    details += `   æ•™æ: ${hw.textbook}`;
    if (hw.pages) details += ` (${hw.pages})`;
    details += `\n   çŠ¶æ…‹: ${hw.completed ? 'âœ… å®Œäº†æ¸ˆã¿' : 'â³ æœªå®Œäº†'}\n\n`;
  });
  alert(details);
}
</script>
{% endif %}

<div class="card">
  <h3>è‹±æ¤œ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>å›æ•°</th>
          <th>ç”³ã—è¾¼ã¿æœŸé–“</th>
          <th>ä¸€æ¬¡è©¦é¨“æ—¥ç¨‹</th>
          <th>äºŒæ¬¡è©¦é¨“æ—¥ç¨‹</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>ç¬¬1å›</td><td>2025å¹´3/24ï½5/7</td><td>2025å¹´6/1(æ—¥)</td><td>2025å¹´7/6(æ—¥)</td></tr>
        <tr><td>ç¬¬2å›</td><td>2025å¹´7/1ï½9/8</td><td>2025å¹´10/5(æ—¥)</td><td>2025å¹´11/9(æ—¥)</td></tr>
        <tr><td>ç¬¬3å›</td><td>2025å¹´10/31ï½12/15</td><td>2026å¹´1/25(æ—¥)</td><td>2026å¹´3/1(æ—¥)</td></tr>
      </tbody>
    </table>
  </div>
  <p><small>æœ€æ–°ã®è©³ç´°æƒ…å ±ã¯<a href="https://www.eiken.or.jp/eiken/schedule/" target="_blank">è‹±æ¤œå…¬å¼ã‚µã‚¤ãƒˆ</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</small></p>
</div>
{% endblock %}

{% block scripts %}
<!-- ãƒ¢ãƒ€ãƒ³ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
// å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
function loadPreferenceData() {
  // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  fetch('/myapp/index.cgi/api/student/preferences')
    .then(response => {
      if (!response.ok) {
        throw new Error('API response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.preferences && data.preferences.length > 0) {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è¡¨ç¤ºç”¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        addPreferenceSection(data.preferences);
      }
    })
    .catch(error => {
      console.error('Error loading preferences:', error);
    });
}

// å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addPreferenceSection(preferences) {
  try {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¾Œã«å¿—æœ›æ ¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    const calendarCard = document.querySelector('#calendar').closest('.card');
    if (!calendarCard) return;
    
    // æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
    const existingSection = document.getElementById('preference-section');
    if (existingSection) {
      existingSection.remove();
    }
    
    // æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    const preferencesSection = document.createElement('div');
    preferencesSection.id = 'preference-section';
    preferencesSection.className = 'card';
    preferencesSection.style.marginTop = '20px';
    
    // ã‚¿ã‚¤ãƒˆãƒ«
    const titleElement = document.createElement('h3');
    titleElement.textContent = 'å¿—æœ›æ ¡æƒ…å ±';
    preferencesSection.appendChild(titleElement);
    
    // å¿—æœ›æ ¡ãƒªã‚¹ãƒˆ
    const schoolList = document.createElement('div');
    schoolList.className = 'preference-list';
    
    // å„å¿—æœ›æ ¡ã®æƒ…å ±ã‚’è¡¨ç¤º
    preferences.forEach(school => {
      const schoolItem = document.createElement('div');
      schoolItem.className = 'school-item';
      schoolItem.style.padding = '10px';
      schoolItem.style.marginBottom = '10px';
      schoolItem.style.backgroundColor = '#f8f9fa';
      schoolItem.style.borderRadius = '5px';
      schoolItem.style.borderLeft = '4px solid #4285f4';
      
      // å­¦æ ¡åã¨é †ä½
      const schoolHeader = document.createElement('div');
      schoolHeader.style.fontWeight = 'bold';
      schoolHeader.style.fontSize = '1.1rem';
      schoolHeader.style.marginBottom = '5px';
      
      const orderSpan = document.createElement('span');
      orderSpan.style.backgroundColor = '#4285f4';
      orderSpan.style.color = 'white';
      orderSpan.style.borderRadius = '50%';
      orderSpan.style.width = '24px';
      orderSpan.style.height = '24px';
      orderSpan.style.display = 'inline-flex';
      orderSpan.style.justifyContent = 'center';
      orderSpan.style.alignItems = 'center';
      orderSpan.style.marginRight = '8px';
      orderSpan.style.fontWeight = 'bold';
      orderSpan.textContent = school.preference_order;
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = school.name;
      
      schoolHeader.appendChild(orderSpan);
      schoolHeader.appendChild(nameSpan);
      
      if (school.course_type) {
        const courseSpan = document.createElement('span');
        courseSpan.style.marginLeft = '5px';
        courseSpan.style.fontSize = '0.9rem';
        courseSpan.style.color = '#666';
        courseSpan.textContent = `(${school.course_type})`;
        schoolHeader.appendChild(courseSpan);
      }
      
      schoolItem.appendChild(schoolHeader);
      
      // å­¦æ ¡ã®è©³ç´°æƒ…å ±
      const detailsTable = document.createElement('table');
      detailsTable.style.width = '100%';
      detailsTable.style.marginTop = '5px';
      detailsTable.style.fontSize = '0.9rem';
      
      // å†…ç”³ç‚¹æƒ…å ±
      const pointRow = document.createElement('tr');
      
      const pointLabelCell = document.createElement('td');
      pointLabelCell.style.padding = '3px';
      pointLabelCell.style.width = '50%';
      pointLabelCell.textContent = 'æœ€ä½å¿…è¦å†…ç”³ç‚¹:';
      
      const pointValueCell = document.createElement('td');
      pointValueCell.style.padding = '3px';
      pointValueCell.style.fontWeight = 'bold';
      pointValueCell.textContent = school.min_required_points;
      
      pointRow.appendChild(pointLabelCell);
      pointRow.appendChild(pointValueCell);
      detailsTable.appendChild(pointRow);
      
      // å¹³å‡åˆæ ¼å†…ç”³ç‚¹æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.avg_accepted_points) {
        const avgRow = document.createElement('tr');
        
        const avgLabelCell = document.createElement('td');
        avgLabelCell.style.padding = '3px';
        avgLabelCell.textContent = 'å¹³å‡åˆæ ¼å†…ç”³ç‚¹:';
        
        const avgValueCell = document.createElement('td');
        avgValueCell.style.padding = '3px';
        avgValueCell.style.fontWeight = 'bold';
        avgValueCell.textContent = school.avg_accepted_points;
        
        avgRow.appendChild(avgLabelCell);
        avgRow.appendChild(avgValueCell);
        detailsTable.appendChild(avgRow);
      }
      
      // å€ç‡æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.competition_rate) {
        const rateRow = document.createElement('tr');
        
        const rateLabelCell = document.createElement('td');
        rateLabelCell.style.padding = '3px';
        rateLabelCell.textContent = 'å€ç‡:';
        
        const rateValueCell = document.createElement('td');
        rateValueCell.style.padding = '3px';
        rateValueCell.style.fontWeight = 'bold';
        rateValueCell.textContent = `${school.competition_rate}å€`;
        
        rateRow.appendChild(rateLabelCell);
        rateRow.appendChild(rateValueCell);
        detailsTable.appendChild(rateRow);
      }
      
      // åå·®å€¤æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.deviation_score) {
        const devRow = document.createElement('tr');
        
        const devLabelCell = document.createElement('td');
        devLabelCell.style.padding = '3px';
        devLabelCell.textContent = 'åå·®å€¤:';
        
        const devValueCell = document.createElement('td');
        devValueCell.style.padding = '3px';
        devValueCell.style.fontWeight = 'bold';
        devValueCell.textContent = school.deviation_score;
        
        devRow.appendChild(devLabelCell);
        devRow.appendChild(devValueCell);
        detailsTable.appendChild(devRow);
      }
      
      // éƒ¨æ´»å‹•æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.strong_club_activities) {
        const clubRow = document.createElement('tr');
        
        const clubLabelCell = document.createElement('td');
        clubLabelCell.style.padding = '3px';
        clubLabelCell.textContent = 'å¼·ã„éƒ¨æ´»:';
        
        const clubValueCell = document.createElement('td');
        clubValueCell.style.padding = '3px';
        clubValueCell.textContent = school.strong_club_activities;
        
        clubRow.appendChild(clubLabelCell);
        clubRow.appendChild(clubValueCell);
        detailsTable.appendChild(clubRow);
      }
      
      schoolItem.appendChild(detailsTable);
      
      // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
      const buttonDiv = document.createElement('div');
      buttonDiv.style.marginTop = '10px';
      buttonDiv.style.textAlign = 'right';
      
      const detailButton = document.createElement('a');
      detailButton.href = `/myapp/index.cgi/student/performance`;
      detailButton.className = 'btn btn-primary';
      detailButton.style.fontSize = '0.9rem';
      detailButton.style.padding = '4px 8px';
      detailButton.textContent = 'å†…ç”³ç‚¹ã¨æ¯”è¼ƒ';
      
      buttonDiv.appendChild(detailButton);
      schoolItem.appendChild(buttonDiv);
      
      schoolList.appendChild(schoolItem);
    });
    
    preferencesSection.appendChild(schoolList);
    
    // ãƒªãƒ³ã‚¯ã‚¨ãƒªã‚¢
    const linkDiv = document.createElement('div');
    linkDiv.style.marginTop = '10px';
    
    const profileLink = document.createElement('a');
    profileLink.href = '/myapp/index.cgi/student/profile';
    profileLink.style.fontSize = '0.9rem';
    profileLink.textContent = 'å¿—æœ›æ ¡ã®è¨­å®šãƒ»å¤‰æ›´ã¯ã“ã¡ã‚‰';
    
    linkDiv.appendChild(profileLink);
    preferencesSection.appendChild(linkDiv);
    
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
    calendarCard.parentNode.insertBefore(preferencesSection, calendarCard.nextSibling);
  } catch (error) {
    console.error('Error displaying preferences:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // å°å­¦5ãƒ»6å¹´ç”Ÿã®å ´åˆã®ã¿å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
  const schoolType = '{{ school_type }}';
  const gradeLevel = parseInt('{{ grade_level|default("0") }}');
  console.log(`ğŸ”§ åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯: schoolType=${schoolType}, gradeLevel=${gradeLevel}`);
  
  if (schoolType === 'elementary' && [5, 6].includes(gradeLevel)) {
    console.log('âœ… å°å­¦5ãƒ»6å¹´ç”Ÿã¨ã—ã¦å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™');
    
    // å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã®å­˜åœ¨ç¢ºèª
    const homeworkCalendar = document.getElementById('homework-calendar');
    if (homeworkCalendar) {
      console.log('ğŸ¯ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
      
      // å¡¾ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€ç‹¬ç«‹ã—ã¦åˆæœŸåŒ–
      setTimeout(() => {
        console.log('â° å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é…å»¶åˆæœŸåŒ–é–‹å§‹');
        initializeHomeworkCalendar();
      }, 100); // å¡¾ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–å¾Œã«å®Ÿè¡Œ
    } else {
      console.log('âŒ å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  } else {
    console.log('â„¹ï¸ å°å­¦5ãƒ»6å¹´ç”Ÿã§ã¯ãªã„ãŸã‚å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã›ã‚“');
  }
  
  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  loadPreferenceData();
  
  // ãƒ‡ãƒã‚¤ã‚¹æ€§èƒ½ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
  const isMobile = window.innerWidth <= 768;
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  function setupAnimations() {
    // è»½é‡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®è¨­å®š
    const lightAnimationDuration = isMobile ? '0.3s' : '0.5s';
    const staggerDelay = isMobile ? 50 : 100;
    const reducedAnimations = isMobile || prefersReducedMotion;
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      if (reducedAnimations && index > 3) {
        // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸Šéƒ¨ã®é‡è¦ãªè¦ç´ ã®ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        card.style.opacity = '1';
        return;
      }
      
      card.style.opacity = '0';
      card.style.transform = 'translateY(10px)';
      card.style.transition = `opacity ${lightAnimationDuration} ease, transform ${lightAnimationDuration} ease`;
      
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, staggerDelay * index);
    });
    
    // ãŠçŸ¥ã‚‰ã›é …ç›®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const notificationItems = document.querySelectorAll('.notification-item');
    notificationItems.forEach((item, index) => {
      if (reducedAnimations && index > 2) {
        item.style.opacity = '1';
        return;
      }
      
      item.style.opacity = '0';
      item.style.transform = isMobile ? 'translateY(5px)' : 'translateX(-10px)';
      item.style.transition = `all ${lightAnimationDuration} ease`;
      
      setTimeout(() => {
        item.style.opacity = '1';
        item.style.transform = 'translateY(0)';
      }, 200 + (staggerDelay * index));
    });
  }
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  setupAnimations();
});
</script>
{% endblock %}