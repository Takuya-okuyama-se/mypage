{% extends "base.html" %}

{% block title %}Ëã±Ë™ûÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É† - È´òÊ©üËÉΩÁâà{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .english-learning-container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header-title {
        color: #5a4fcf;
        text-align: center;
        margin-bottom: 20px;
        font-size: 2.5em;
    }

    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f0f8ff;
        border-radius: 10px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .user-profile {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .user-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .stats-btn, .settings-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .stats-btn:hover, .settings-btn:hover {
        background: #138496;
        transform: translateY(-2px);
    }

    .stage-info {
        text-align: center;
        margin-bottom: 30px;
    }

    .stage-selector {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stage-button {
        padding: 10px 15px;
        border: none;
        background: #f8f9fa;
        color: #495057;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .stage-button:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .stage-button.active {
        background: #5a4fcf;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(90, 79, 207, 0.3);
    }

    .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .tab-button {
        padding: 12px 24px;
        border: none;
        background: #e9ecef;
        color: #495057;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .tab-button.active {
        background: #28a745;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }    .problem-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: 1px solid #dee2e6;
        position: relative;
        overflow: hidden;
    }

    .problem-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #5a4fcf, #28a745, #007bff);
    }

    .problem-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .problem-number {
        font-weight: bold;
        color: #5a4fcf;
        font-size: 18px;
    }

    .problem-type {
        background: #5a4fcf;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
    }    .japanese-sentence {
        font-size: 22px;
        font-weight: 600;
        color: #2d3436;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
        border-radius: 12px;
        border-left: 6px solid #5a4fcf;
        border-right: 6px solid #28a745;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
    }    .japanese-sentence::after {
        content: 'üáØüáµ‚Üíüá∫üá∏';
        position: absolute;
        top: -10px;
        right: 15px;
        background: #5a4fcf;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: normal;
    }

    /* ÊâãÊõ∏„ÅçÊñáÊ≥ïÁ∑¥ÁøíÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-area {
        margin-bottom: 15px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }

    .input-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #666;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-label i {
        color: #5a4fcf;
    }

    .canvas-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: center;
    }

    .word-canvas-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 5px;
    }

    .word-canvas {
        border: 2px solid #5a4fcf;
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        touch-action: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .word-canvas:hover {
        border-color: #28a745;
        transform: scale(1.05);
    }

    .clear-button {
        margin-top: 8px;
        padding: 5px 12px;
        border: none;
        background: #dc3545;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .clear-button:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .recognition-area {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .recognized-words {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .hint i {
        color: #f39c12;
        font-size: 18px;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .word-canvas {
            width: 80px !important;
            height: 80px !important;
        }
        
        .canvas-container {
            justify-content: center;
        }
          .handwriting-area {
            padding: 15px;
        }
    }

    /* ÊâãÊõ∏„Åç„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-tab-content {
        display: none;
    }

    .handwriting-tab-content.active {
        display: block;
    }

    .handwriting-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
        flex-wrap: wrap;
    }

    .handwriting-tabs .tab-button {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
    }

    .handwriting-tabs .tab-button:hover {
        background: linear-gradient(135deg, #5a6268 0%, #3d4142 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .handwriting-tabs .tab-button.active {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(90, 79, 207, 0.3);
    }

    .handwriting-stage-selector {
        text-align: center;
        margin: 20px 0;
    }

    .handwriting-stage-selector .stage-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        margin: 0 3px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .handwriting-stage-selector .stage-button:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .handwriting-stage-selector .stage-button.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }.hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid #f39c12;
        color: #8b6914;
        font-weight: 500;
        position: relative;
        box-shadow: 0 3px 10px rgba(243, 156, 18, 0.2);
    }

    .hint::before {
        content: 'üí° „Éí„É≥„Éà';
        position: absolute;
        top: -12px;
        left: 15px;
        background: #f39c12;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }

    .handwriting-area {
        margin-bottom: 20px;
    }    .input-label {
        font-weight: 600;
        margin-bottom: 15px;
        color: #5a4fcf;
        font-size: 18px;
        text-align: center;
        display: block;
        background: linear-gradient(90deg, #5a4fcf, #28a745);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }.canvas-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        align-items: flex-start;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #5a4fcf;
        margin: 15px 0;
    }

    .canvas-container input {
        margin: 5px;
        padding: 15px 10px;
        border: 3px solid #5a4fcf;
        border-radius: 8px;
        font-size: 18px;
        text-align: center;
        min-width: 100px;
        background: #f8f9fa;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .canvas-container input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        background: white;
        transform: scale(1.05);
    }

    .canvas-container input:hover {
        border-color: #28a745;
        background: white;
    }

    .canvas-container input::placeholder {
        color: #6c757d;
        font-size: 14px;
    }    .submit-button, .score-button, .next-stage-button {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
    }

    .submit-button {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(90, 79, 207, 0.4);
    }

    .score-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .next-stage-button {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .submit-button:hover, .score-button:hover, .next-stage-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .submit-button::before, .score-button::before, .next-stage-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: width 0.6s, height 0.6s;
        transform: translate(-50%, -50%);
    }

    .submit-button:active::before, .score-button:active::before, .next-stage-button:active::before {
        width: 300px;
        height: 300px;
    }

    .answer-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid;
        background: #f8f9fa;
    }

    .answer-result.correct {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
    }

    .answer-result.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
    }

    .result-status {
        font-weight: bold;
        margin-top: 10px;
        font-size: 18px;
    }

    .score-display {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #2196f3;
        margin: 20px 0;
        text-align: center;
    }

    .score-display h3 {
        color: #1976d2;
        margin-bottom: 15px;
    }

    .score-display p {
        font-size: 18px;
        margin: 10px 0;
        font-weight: 500;
    }

    .vocabulary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }    .vocabulary-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 3px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .vocabulary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(90, 79, 207, 0.1), transparent);
        transition: left 0.5s;
    }

    .vocabulary-card:hover::before {
        left: 100%;
    }

    .vocabulary-card:hover {
        border-color: #5a4fcf;
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(90, 79, 207, 0.3);
    }

    .vocab-word {
        font-size: 24px;
        font-weight: bold;
        color: #5a4fcf;
        margin-bottom: 5px;
    }

    .vocab-pronunciation {
        font-size: 16px;
        color: #666;
        font-style: italic;
        margin-bottom: 10px;
    }

    .vocab-meaning {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .vocab-example {
        font-size: 14px;
        color: #666;
        font-style: italic;
        border-left: 3px solid #5a4fcf;
        padding-left: 10px;
        margin-bottom: 10px;
    }

    .vocab-audio-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        margin: 2px;
    }

    .vocab-audio-btn:hover {
        background: #218838;
    }

    .vocab-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .vocab-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }

    .vocab-btn:hover {
        background: #218838;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }

    #error-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: none;
    }

    .error-alert, .success-alert {
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }

    .error-alert {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .success-alert {
        background: #28a745;
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .english-learning-container {
            padding: 15px;
            margin: 10px;
        }

        .header-title {
            font-size: 2em;
        }

        .user-info {
            flex-direction: column;
            text-align: center;
        }

        .stage-selector {
            gap: 5px;
        }

        .stage-button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .tabs {
            gap: 5px;
        }

        .tab-button {
            padding: 10px 16px;
            font-size: 14px;
        }

        .vocabulary-list {
            grid-template-columns: 1fr;
        }
    }

    /* ÊâãÊõ∏„ÅçË™çË≠òÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
    .recognition-loading {
        color: #007bff;
        font-size: 14px;
        margin-left: 10px;
        animation: fadeInOut 1.5s infinite;
    }

    .recognition-loading i {
        margin-right: 5px;
    }

    @keyframes fadeInOut {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    /* ÊâãÊõ∏„ÅçÊñáÊ≥ïÁ∑¥ÁøíÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-area {
        margin-bottom: 15px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }

    .input-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #666;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-label i {
        color: #5a4fcf;
    }

    .canvas-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: center;
    }

    .word-canvas-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 5px;
    }

    .word-canvas {
        border: 2px solid #5a4fcf;
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        touch-action: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .word-canvas:hover {
        border-color: #28a745;
        transform: scale(1.05);
    }

    .clear-button {
        margin-top: 8px;
        padding: 5px 12px;
        border: none;
        background: #dc3545;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .clear-button:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .recognition-area {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .recognized-words {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .hint i {
        color: #f39c12;
        font-size: 18px;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .word-canvas {
            width: 80px !important;
            height: 80px !important;
        }
        
        .canvas-container {
            justify-content: center;
        }
          .handwriting-area {
            padding: 15px;
        }
    }

    /* ÊâãÊõ∏„Åç„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-tab-content {
        display: none;
    }

    .handwriting-tab-content.active {
        display: block;
    }

    .handwriting-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
        flex-wrap: wrap;
    }

    .handwriting-tabs .tab-button {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
    }

    .handwriting-tabs .tab-button:hover {
        background: linear-gradient(135deg, #5a6268 0%, #3d4142 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .handwriting-tabs .tab-button.active {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(90, 79, 207, 0.3);
    }

    .handwriting-stage-selector {
        text-align: center;
        margin: 20px 0;
    }

    .handwriting-stage-selector .stage-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        margin: 0 3px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .handwriting-stage-selector .stage-button:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .handwriting-stage-selector .stage-button.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }.hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid #f39c12;
        color: #8b6914;
        font-weight: 500;
        position: relative;
        box-shadow: 0 3px 10px rgba(243, 156, 18, 0.2);
    }

    .hint::before {
        content: 'üí° „Éí„É≥„Éà';
        position: absolute;
        top: -12px;
        left: 15px;
        background: #f39c12;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }

    .handwriting-area {
        margin-bottom: 20px;
    }    .input-label {
        font-weight: 600;
        margin-bottom: 15px;
        color: #5a4fcf;
        font-size: 18px;
        text-align: center;
        display: block;
        background: linear-gradient(90deg, #5a4fcf, #28a745);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }.canvas-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        align-items: flex-start;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #5a4fcf;
        margin: 15px 0;
    }

    .canvas-container input {
        margin: 5px;
        padding: 15px 10px;
        border: 3px solid #5a4fcf;
        border-radius: 8px;
        font-size: 18px;
        text-align: center;
        min-width: 100px;
        background: #f8f9fa;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .canvas-container input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        background: white;
        transform: scale(1.05);
    }

    .canvas-container input:hover {
        border-color: #28a745;
        background: white;
    }

    .canvas-container input::placeholder {
        color: #6c757d;
        font-size: 14px;
    }    .submit-button, .score-button, .next-stage-button {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
    }

    .submit-button {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(90, 79, 207, 0.4);
    }

    .score-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .next-stage-button {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .submit-button:hover, .score-button:hover, .next-stage-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .submit-button::before, .score-button::before, .next-stage-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: width 0.6s, height 0.6s;
        transform: translate(-50%, -50%);
    }

    .submit-button:active::before, .score-button:active::before, .next-stage-button:active::before {
        width: 300px;
        height: 300px;
    }

    .answer-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid;
        background: #f8f9fa;
    }

    .answer-result.correct {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
    }

    .answer-result.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
    }

    .result-status {
        font-weight: bold;
        margin-top: 10px;
        font-size: 18px;
    }

    .score-display {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #2196f3;
        margin: 20px 0;
        text-align: center;
    }

    .score-display h3 {
        color: #1976d2;
        margin-bottom: 15px;
    }

    .score-display p {
        font-size: 18px;
        margin: 10px 0;
        font-weight: 500;
    }

    .vocabulary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }    .vocabulary-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 3px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .vocabulary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(90, 79, 207, 0.1), transparent);
        transition: left 0.5s;
    }

    .vocabulary-card:hover::before {
        left: 100%;
    }

    .vocabulary-card:hover {
        border-color: #5a4fcf;
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(90, 79, 207, 0.3);
    }

    .vocab-word {
        font-size: 24px;
        font-weight: bold;
        color: #5a4fcf;
        margin-bottom: 5px;
    }

    .vocab-pronunciation {
        font-size: 16px;
        color: #666;
        font-style: italic;
        margin-bottom: 10px;
    }

    .vocab-meaning {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .vocab-example {
        font-size: 14px;
        color: #666;
        font-style: italic;
        border-left: 3px solid #5a4fcf;
        padding-left: 10px;
        margin-bottom: 10px;
    }

    .vocab-audio-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        margin: 2px;
    }

    .vocab-audio-btn:hover {
        background: #218838;
    }

    .vocab-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .vocab-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }

    .vocab-btn:hover {
        background: #218838;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }

    #error-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: none;
    }

    .error-alert, .success-alert {
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }

    .error-alert {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .success-alert {
        background: #28a745;
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .english-learning-container {
            padding: 15px;
            margin: 10px;
        }

        .header-title {
            font-size: 2em;
        }

        .user-info {
            flex-direction: column;
            text-align: center;
        }

        .stage-selector {
            gap: 5px;
        }

        .stage-button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .tabs {
            gap: 5px;
        }

        .tab-button {
            padding: 10px 16px;
            font-size: 14px;
        }

        .vocabulary-list {
            grid-template-columns: 1fr;
        }
    }

    /* ÊâãÊõ∏„ÅçË™çË≠òÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
    .recognition-loading {
        color: #007bff;
        font-size: 14px;
        margin-left: 10px;
        animation: fadeInOut 1.5s infinite;
    }

    .recognition-loading i {
        margin-right: 5px;
    }

    @keyframes fadeInOut {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    /* ÊâãÊõ∏„ÅçÊñáÊ≥ïÁ∑¥ÁøíÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-area {
        margin-bottom: 15px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }

    .input-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #666;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-label i {
        color: #5a4fcf;
    }

    .canvas-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: center;
    }

    .word-canvas-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 5px;
    }

    .word-canvas {
        border: 2px solid #5a4fcf;
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        touch-action: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .word-canvas:hover {
        border-color: #28a745;
        transform: scale(1.05);
    }

    .clear-button {
        margin-top: 8px;
        padding: 5px 12px;
        border: none;
        background: #dc3545;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .clear-button:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .recognition-area {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .recognized-words {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .hint i {
        color: #f39c12;
        font-size: 18px;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .word-canvas {
            width: 80px !important;
            height: 80px !important;
        }
        
        .canvas-container {
            justify-content: center;
        }
          .handwriting-area {
            padding: 15px;
        }
    }

    /* ÊâãÊõ∏„Åç„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-tab-content {
        display: none;
    }

    .handwriting-tab-content.active {
        display: block;
    }

    .handwriting-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
        flex-wrap: wrap;
    }

    .handwriting-tabs .tab-button {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
    }

    .handwriting-tabs .tab-button:hover {
        background: linear-gradient(135deg, #5a6268 0%, #3d4142 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .handwriting-tabs .tab-button.active {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(90, 79, 207, 0.3);
    }

    .handwriting-stage-selector {
        text-align: center;
        margin: 20px 0;
    }

    .handwriting-stage-selector .stage-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        margin: 0 3px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .handwriting-stage-selector .stage-button:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .handwriting-stage-selector .stage-button.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }.hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid #f39c12;
        color: #8b6914;
        font-weight: 500;
        position: relative;
        box-shadow: 0 3px 10px rgba(243, 156, 18, 0.2);
    }

    .hint::before {
        content: 'üí° „Éí„É≥„Éà';
        position: absolute;
        top: -12px;
        left: 15px;
        background: #f39c12;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }

    .handwriting-area {
        margin-bottom: 20px;
    }    .input-label {
        font-weight: 600;
        margin-bottom: 15px;
        color: #5a4fcf;
        font-size: 18px;
        text-align: center;
        display: block;
        background: linear-gradient(90deg, #5a4fcf, #28a745);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }.canvas-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        align-items: flex-start;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #5a4fcf;
        margin: 15px 0;
    }

    .canvas-container input {
        margin: 5px;
        padding: 15px 10px;
        border: 3px solid #5a4fcf;
        border-radius: 8px;
        font-size: 18px;
        text-align: center;
        min-width: 100px;
        background: #f8f9fa;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .canvas-container input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        background: white;
        transform: scale(1.05);
    }

    .canvas-container input:hover {
        border-color: #28a745;
        background: white;
    }

    .canvas-container input::placeholder {
        color: #6c757d;
        font-size: 14px;
    }    .submit-button, .score-button, .next-stage-button {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
    }

    .submit-button {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(90, 79, 207, 0.4);
    }

    .score-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .next-stage-button {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .submit-button:hover, .score-button:hover, .next-stage-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .submit-button::before, .score-button::before, .next-stage-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: width 0.6s, height 0.6s;
        transform: translate(-50%, -50%);
    }

    .submit-button:active::before, .score-button:active::before, .next-stage-button:active::before {
        width: 300px;
        height: 300px;
    }

    .answer-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid;
        background: #f8f9fa;
    }

    .answer-result.correct {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
    }

    .answer-result.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
    }

    .result-status {
        font-weight: bold;
        margin-top: 10px;
        font-size: 18px;
    }

    .score-display {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #2196f3;
        margin: 20px 0;
        text-align: center;
    }

    .score-display h3 {
        color: #1976d2;
        margin-bottom: 15px;
    }

    .score-display p {
        font-size: 18px;
        margin: 10px 0;
        font-weight: 500;
    }

    .vocabulary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }    .vocabulary-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 3px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .vocabulary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(90, 79, 207, 0.1), transparent);
        transition: left 0.5s;
    }

    .vocabulary-card:hover::before {
        left: 100%;
    }

    .vocabulary-card:hover {
        border-color: #5a4fcf;
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(90, 79, 207, 0.3);
    }

    .vocab-word {
        font-size: 24px;
        font-weight: bold;
        color: #5a4fcf;
        margin-bottom: 5px;
    }

    .vocab-pronunciation {
        font-size: 16px;
        color: #666;
        font-style: italic;
        margin-bottom: 10px;
    }

    .vocab-meaning {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .vocab-example {
        font-size: 14px;
        color: #666;
        font-style: italic;
        border-left: 3px solid #5a4fcf;
        padding-left: 10px;
        margin-bottom: 10px;
    }

    .vocab-audio-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        margin: 2px;
    }

    .vocab-audio-btn:hover {
        background: #218838;
    }

    .vocab-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .vocab-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }

    .vocab-btn:hover {
        background: #218838;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }

    #error-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: none;
    }

    .error-alert, .success-alert {
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }

    .error-alert {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .success-alert {
        background: #28a745;
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .english-learning-container {
            padding: 15px;
            margin: 10px;
        }

        .header-title {
            font-size: 2em;
        }

        .user-info {
            flex-direction: column;
            text-align: center;
        }

        .stage-selector {
            gap: 5px;
        }

        .stage-button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .tabs {
            gap: 5px;
        }

        .tab-button {
            padding: 10px 16px;
            font-size: 14px;
        }

        .vocabulary-list {
            grid-template-columns: 1fr;
        }
    }

    /* ÊâãÊõ∏„ÅçË™çË≠òÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
    .recognition-loading {
        color: #007bff;
        font-size: 14px;
        margin-left: 10px;
        animation: fadeInOut 1.5s infinite;
    }

    .recognition-loading i {
        margin-right: 5px;
    }

    @keyframes fadeInOut {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    /* ÊâãÊõ∏„ÅçÊñáÊ≥ïÁ∑¥ÁøíÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-area {
        margin-bottom: 15px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 
    }

    .input-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #666;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-label i {
        color: #5a4fcf;
    }

    .canvas-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: center;
    }

    .word-canvas-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 5px;
    }

    .word-canvas {
        border: 2px solid #5a4fcf;
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        touch-action: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .word-canvas:hover {
        border-color: #28a745;
        transform: scale(1.05);
    }

    .clear-button {
        margin-top: 8px;
        padding: 5px 12px;
        border: none;
        background: #dc3545;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .clear-button:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .recognition-area {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .recognized-words {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .recognized-word {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: #e7f3ff;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 13px;
        color: #0056b3;
        font-weight: 500;
    }

    .hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .hint i {
        color: #f39c12;
        font-size: 18px;
    }

    .handwriting-submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .handwriting-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .handwriting-submit-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .word-canvas {
            width: 80px !important;
            height: 80px !important;
        }
        
        .canvas-container {
            justify-content: center;
        }
          .handwriting-area {
            padding: 15px;
        }
    }

    /* ÊâãÊõ∏„Åç„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .handwriting-tab-content {
        display: none;
    }

    .handwriting-tab-content.active {
        display: block;
    }

    .handwriting-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
        flex-wrap: wrap;
    }

    .handwriting-tabs .tab-button {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
    }

    .handwriting-tabs .tab-button:hover {
        background: linear-gradient(135deg, #5a6268 0%, #3d4142 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .handwriting-tabs .tab-button.active {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(90, 79, 207, 0.3);
    }

    .handwriting-stage-selector {
        text-align: center;
        margin: 20px 0;
    }

    .handwriting-stage-selector .stage-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        margin: 0 3px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .handwriting-stage-selector .stage-button:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .handwriting-stage-selector .stage-button.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }.hint {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid #f39c12;
        color: #8b6914;
        font-weight: 500;
        position: relative;
        box-shadow: 0 3px 10px rgba(243, 156, 18, 0.2);
    }

    .hint::before {
        content: 'üí° „Éí„É≥„Éà';
        position: absolute;
        top: -12px;
        left: 15px;
        background: #f39c12;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }

    .handwriting-area {
        margin-bottom: 20px;
    }    .input-label {
        font-weight: 600;
        margin-bottom: 15px;
        color: #5a4fcf;
        font-size: 18px;
        text-align: center;
        display: block;
        background: linear-gradient(90deg, #5a4fcf, #28a745);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }.canvas-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        align-items: flex-start;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #5a4fcf;
        margin: 15px 0;
    }

    .canvas-container input {
        margin: 5px;
        padding: 15px 10px;
        border: 3px solid #5a4fcf;
        border-radius: 8px;
        font-size: 18px;
        text-align: center;
        min-width: 100px;
        background: #f8f9fa;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .canvas-container input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        background: white;
        transform: scale(1.05);
    }

    .canvas-container input:hover {
        border-color: #28a745;
        background: white;
    }

    .canvas-container input::placeholder {
        color: #6c757d;
        font-size: 14px;
    }    .submit-button, .score-button, .next-stage-button {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
    }

    .submit-button {
        background: linear-gradient(135deg, #5a4fcf 0%, #4834d4 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(90, 79, 207, 0.4);
    }

    .score-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .next-stage-button {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .submit-button:hover, .score-button:hover, .next-stage-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .submit-button::before, .score-button::before, .next-stage-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: width 0.6s, height 0.6s;
        transform: translate(-50%, -50%);
    }

    .submit-button:active::before, .score-button:active::before, .next-stage-button:active::before {
        width: 300px;
        height: 300px;
    }

    .answer-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid;
        background: #f8f9fa;
    }

    .answer-result.correct {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
    }

    .answer-result.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
    }

    .result-status {
        font-weight: bold;
        margin-top: 10px;
        font-size: 18px;
    }

    .score-display {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #2196f3;
        margin: 20px 0;
        text-align: center;
    }

    .score-display h3 {
        color: #1976d2;
        margin-bottom: 15px;
    }

    .score-display p {
        font-size: 18px;
        margin: 10px 0;
        font-weight: 500;
    }

    .vocabulary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }    .vocabulary-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 3px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .vocabulary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(90, 79, 207, 0.1), transparent);
        transition: left 0.5s;
    }

    .vocabulary-card:hover::before {
        left: 100%;
    }

    .vocabulary-card:hover {
        border-color: #5a4fcf;
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(90, 79, 207, 0.3);
    }

    .vocab-word {
        font-size: 24px;
        font-weight: bold;
        color: #5a4fcf;
        margin-bottom: 5px;
    }

    .vocab-pronunciation {
        font-size: 16px;
        color: #666;
        font-style: italic;
        margin-bottom: 10px;
    }

    .vocab-meaning {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .vocab-example {
        font-size: 14px;
        color: #666;
        font-style: italic;
        border-left: 3px solid #5a4fcf;
        padding-left: 10px;
        margin-bottom: 10px;
    }

    .vocab-audio-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        margin: 2px;
    }

    .vocab-audio-btn:hover {
        background: #218838;
    }

    .vocab-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .vocab-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }

    .vocab-btn:hover {
        background: #218838;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }

    #error-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: none;
    }

    .error-alert, .success-alert {
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }

    .error-alert {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .success-alert {
        background: #28a745;
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .english-learning-container {
            padding: 15px;
            margin: 10px;
        }

        .header-title {
            font-size: 2em;
        }

        .user-info {
            flex-direction: column;
            text-align: center;
        }

        .stage-selector {
            gap: 5px;
        }

        .stage-button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .tabs {
            gap: 5px;
        }

        .tab-button {
            padding: 10px 16px;
            font-size: 14px;
        }        .vocabulary-list {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="english-learning-container">
    <h1 class="header-title">
        <i class="fas fa-book-open"></i>
        Ëã±Ë™ûÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É† - È´òÊ©üËÉΩÁâà
    </h1>
    
    <div class="user-info">
        <div class="user-profile">
            <span class="user-name">{{ name or '„É¶„Éº„Ç∂„Éº' }}„Åï„Çì</span>
            <span class="user-points">ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà: <strong>{{ current_points or 0 }}</strong></span>
        </div>
        <div class="user-controls">
            <button class="stats-btn" onclick="showStatistics()">
                <i class="fas fa-chart-bar"></i> Áµ±Ë®à
            </button>
            <button class="settings-btn" onclick="showSettings()">
                <i class="fas fa-cog"></i> Ë®≠ÂÆö
            </button>
        </div>
    </div>
    
    <div class="learning-sections">
        <div class="section-card" id="vocabulary-section">
            <h2><i class="fas fa-spell-check"></i> Ë™ûÂΩôÁ∑¥Áøí</h2>
            <p>Ëã±ÂçòË™û„ÇíË¶ö„Åà„Å¶Ë™ûÂΩôÂäõ„ÇíÂêë‰∏ä„Åï„Åõ„Çà„ÅÜÔºÅ</p>
            <button class="start-btn" onclick="startVocabularyPractice()">
                <i class="fas fa-play"></i> ÈñãÂßã
            </button>
        </div>
        
        <div class="section-card" id="grammar-section">
            <h2><i class="fas fa-pen"></i> ÊñáÊ≥ïÁ∑¥Áøí</h2>
            <p>ÊñáÊ≥ïÂïèÈ°å„ÇíËß£„ÅÑ„Å¶Ëã±Ë™ûÂäõ„Çí„Ç¢„ÉÉ„ÉóÔºÅ</p>
            <button class="start-btn" onclick="startGrammarPractice()">
                <i class="fas fa-play"></i> ÈñãÂßã
            </button>
        </div>
        
        <div class="section-card" id="writing-section">
            <h2><i class="fas fa-edit"></i> ÊâãÊõ∏„ÅçÁ∑¥Áøí</h2>
            <p>ÊâãÊõ∏„Åç„ÅßËã±Ë™û„ÇíÁ∑¥Áøí„Åó„Çà„ÅÜÔºÅ</p>
            <button class="start-btn" onclick="startWritingPractice()">
                <i class="fas fa-play"></i> ÈñãÂßã
            </button>
        </div>
    </div>
    
    <div id="practice-area" class="practice-area" style="display: none;">
        <!-- Á∑¥Áøí„Ç®„É™„Ç¢„ÅÆÂÜÖÂÆπ„ÅØ JavaScript „ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
    </div>
    
    <div id="error-message" class="error-message" style="display: none;">
        <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let currentUser = "{{ name or 'Unknown' }}";
    let currentPoints = parseInt('{{ current_points|default("0") }}') || 0;    // Èü≥Â£∞ÂêàÊàê„ÅÆË®≠ÂÆö
    let speechSynthesis = window.speechSynthesis;
    let englishVoice = null;// ÊâãÊõ∏„ÅçÊñáÂ≠óË™çË≠òÔºàGoogle Cloud Vision APIÔºâ
    async function recognizeHandwriting(type, problemIndex, wordIndex) {
        const key = `${type}-${problemIndex}-${wordIndex}`;
        const canvas = document.getElementById(`${type}-canvas-${problemIndex}-${wordIndex}`);
        
        if (!canvas) return;
        
        // Ë™çË≠ò‰∏≠„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        const recognitionDiv = document.getElementById(`${type}-recognition-${problemIndex}`);
        if (recognitionDiv) {
            const loadingSpan = document.createElement('span');
            loadingSpan.className = 'recognition-loading';
            loadingSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ë™çË≠ò‰∏≠...';
            recognitionDiv.appendChild(loadingSpan);
        }
        
        try {
            // „Ç≠„É£„É≥„Éê„Çπ„ÇíÁîªÂÉè„Éá„Éº„Çø„Å´Â§âÊèõ
            const imageData = canvas.toDataURL('image/png');
            
            // API„Å´ÈÄÅ‰ø°
            const response = await fetch('/api/english/recognize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: imageData
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                if (result.text && result.text.trim()) {
                    handwritingData[key].recognized = result.text.toLowerCase().trim();
                    console.log(`Ë™çË≠òÊàêÂäü: ${result.text} (‰ø°È†ºÂ∫¶: ${result.confidence || 'N/A'})`);                } else {
                    handwritingData[key].recognized = '';
                    console.log('ÊñáÂ≠ó„ÇíË™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } else {
                console.error('Ë™çË≠òAPI „Ç®„É©„Éº:', result.message || response.status);
                handwritingData[key].recognized = '';
                
                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                if (response.status === 401) {
                    showError('Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    setTimeout(() => window.location.reload(), 2000);
                } else if (response.status === 504) {
                    showError('Ë™çË≠òÂá¶ÁêÜ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (response.status === 503) {
                    showError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åß„Åô„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    showError('ÊñáÂ≠óË™çË≠ò„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            }
        } catch (error) {
            console.error('ÊâãÊõ∏„ÅçË™çË≠ò„Ç®„É©„Éº:', error);
            handwritingData[key].recognized = '';
            showError('Ë™çË≠òÂá¶ÁêÜ„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
        } finally {
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÇíÂâäÈô§
            if (recognitionDiv) {
                const loadingSpan = recognitionDiv.querySelector('.recognition-loading');
                if (loadingSpan) {
                    loadingSpan.remove();
                }
            }
        }
        
        updateHandwritingRecognition(type, problemIndex);
    }

    // ÊâãÊõ∏„ÅçË™çË≠òÁµêÊûú„ÅÆÊõ¥Êñ∞
    function updateHandwritingRecognition(type, problemIndex) {
        const recognitionDiv = document.getElementById(`${type}-recognition-${problemIndex}`);
        if (!recognitionDiv) return;
        
        const problems = handwritingStageProblems[currentHandwritingStage][type];
        if (!problems || !problems[problemIndex]) return;
        
        const wordCount = problems[problemIndex].answer.length;
        
        const recognizedWords = [];
        for (let i = 0; i < wordCount; i++) {
            const key = `${type}-${problemIndex}-${i}`;
            if (handwritingData[key] && handwritingData[key].recognized) {
                recognizedWords.push(handwritingData[key].recognized);
            }
        }
        
        recognitionDiv.innerHTML = recognizedWords.map(word => 
            `<span class="recognized-word">${word}</span>`
        ).join('');
    }

    // ÊâãÊõ∏„ÅçÂõûÁ≠î„ÅÆÈÄÅ‰ø°
    function submitHandwritingAnswer(type, problemIndex) {
        const problems = handwritingStageProblems[currentHandwritingStage][type];
        if (!problems || !problems[problemIndex]) return;
        
        const wordCount = problems[problemIndex].answer.length;
        
        const answer = [];
        for (let i = 0; i < wordCount; i++) {
            const key = `${type}-${problemIndex}-${i}`;
            answer.push(handwritingData[key]?.recognized || '');
        }
        
        handwritingUserAnswers[type][problemIndex] = answer;
        
        const answerDiv = document.getElementById(`${type}-answer-${problemIndex}`);
        answerDiv.style.display = 'block';
        answerDiv.innerHTML = `
            <strong>ÊèêÂá∫„Åó„ÅüÂõûÁ≠îÔºö</strong> ${answer.join(' ')}
        `;
        
        showSuccess('ÂõûÁ≠î„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ');
    }
    window.submitHandwritingAnswer = submitHandwritingAnswer;

    // ÊâãÊõ∏„ÅçÊé°ÁÇπÊ©üËÉΩ
    function calculateHandwritingScore(type) {
        const problems = handwritingStageProblems[currentHandwritingStage][type];
        if (!problems) return;
        
        let correct = 0;
        const total = problems.length;
        let feedback = '';
        
        problems.forEach((problem, index) => {
            const userAnswer = handwritingUserAnswers[type][index] || [];
            const isCorrect = JSON.stringify(userAnswer) === JSON.stringify(problem.answer);
            
            if (isCorrect) {
                correct++;
                feedback += `<div class="correct-answer">ÂïèÈ°å ${index + 1}: ‚úì Ê≠£Ëß£ÔºÅ</div>`;
            } else {
                feedback += `<div class="incorrect-answer">
                    ÂïèÈ°å ${index + 1}: ‚úó ‰∏çÊ≠£Ëß£<br>
                    „ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î: ${userAnswer.join(' ')}<br>
                    Ê≠£Ëß£: ${problem.answer.join(' ')}
                </div>`;
            }
        });
        
        const resultDiv = document.getElementById(`${type}-result`);
        if (resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="score-display">${correct} / ${total}</div>
                <div class="feedback">
                    ${correct === total ? 'ÂÖ®ÂïèÊ≠£Ëß£ÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åß„ÅôÔºÅ' : 
                      correct >= total * 0.7 ? '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ' : 
                      '„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âæ©Áøí„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ'}
                </div>
                ${feedback}
            `;
            
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        showSuccess(`Êé°ÁÇπÂÆå‰∫Ü: ${correct}/${total}ÂïèÊ≠£Ëß£`);    }
    window.calculateHandwritingScore = calculateHandwritingScore;

    // APIÊé•Á∂ö„ÉÜ„Çπ„ÉàÊ©üËÉΩ
    async function testVisionAPI() {
        console.log('Google Cloud Vision APIÊé•Á∂ö„ÉÜ„Çπ„Éà„ÇíÈñãÂßã...');
        
        // „ÉÜ„Çπ„ÉàÁî®„ÅÆÂ∞è„Åï„Å™„Ç≠„É£„É≥„Éê„Çπ„Çí‰ΩúÊàê
        const testCanvas = document.createElement('canvas');
        testCanvas.width = 100;
        testCanvas.height = 100;
        const ctx = testCanvas.getContext('2d');
        
        // Á∞°Âçò„Å™„ÄåI„Äç„ÅÆÊñáÂ≠ó„ÇíÊèèÁîª
        ctx.fillStyle = '#000';
        ctx.fillRect(45, 20, 10, 60);
        ctx.fillRect(35, 20, 30, 8);
        ctx.fillRect(35, 72, 30, 8);
        
        try {
            const imageData = testCanvas.toDataURL('image/png');
            const response = await fetch('/api/english/recognize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: imageData
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                console.log('‚úÖ Vision APIÊé•Á∂öÊàêÂäü:', result);
                showSuccess('ÊâãÊõ∏„ÅçË™çË≠òAPI„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô');
                return true;
            } else {
                console.error('‚ùå Vision APIÊé•Á∂öÂ§±Êïó:', result);
                showError('ÊâãÊõ∏„ÅçË™çË≠òAPI„ÅÆÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô');
                return false;
            }
        } catch (error) {
            console.error('‚ùå Vision API„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
            showError('ÊâãÊõ∏„ÅçË™çË≠òAPI„ÅÆ„ÉÜ„Çπ„Éà„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            return false;
        }
    }
    window.testVisionAPI = testVisionAPI;

    // ÊâãÊõ∏„ÅçÂïèÈ°å„Éá„Éº„ÇøÁîüÊàêÔºà„Çπ„ÉÜ„Éº„Ç∏2-7Ôºâ
    (function generateHandwritingStages() {
        for (let stage = 2; stage <= 7; stage++) {
            handwritingStageProblems[stage] = {
                'handwriting-basic': [
                    {
                        type: 'beÂãïË©û„ÉªËÇØÂÆöÊñá',
                        japanese: stage === 2 ? 'ÂΩº„Çâ„ÅØÂèãÈÅî„Åß„Åô„ÄÇ' : 
                                 stage === 3 ? 'ÁßÅ„ÅØÂπ∏„Åõ„Åß„Åô„ÄÇ' :
                                 stage === 4 ? '„Åì„Çå„ÅØÊú¨„Åß„Åô„ÄÇ' :
                                 stage === 5 ? 'ÂΩºÂ•≥„ÅØË¶™Âàá„Åß„Åô„ÄÇ' :
                                 stage === 6 ? 'ÁßÅ„Åü„Å°„ÅØÊó•Êú¨‰∫∫„Åß„Åô„ÄÇ' :
                                 '„Åù„Çå„ÅØÂ§ß„Åç„ÅÑ„Åß„Åô„ÄÇ',
                        answer: stage === 2 ? ['They', 'are', 'friends', '.'] :
                               stage === 3 ? ['I', 'am', 'happy', '.'] :
                               stage === 4 ? ['This', 'is', 'a', 'book', '.'] :
                               stage === 5 ? ['She', 'is', 'kind', '.'] :
                               stage === 6 ? ['We', 'are', 'Japanese', '.'] :
                               ['It', 'is', 'big', '.'],
                        hint: 'beÂãïË©ûÔºàam/is/areÔºâ„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                    },
                    {
                        type: 'beÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                        japanese: stage === 2 ? 'ÁßÅ„ÅØÂøô„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 3 ? '„Åù„Çå„ÅØÈ´ò„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 4 ? 'ÂΩº„Çâ„ÅØÂ≠¶Áîü„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 5 ? 'ÁßÅ„ÅØÁñ≤„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 6 ? '„Åì„Çå„ÅØÊñ∞„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ' :
                                 'ÂΩºÂ•≥„ÅØÁúãË≠∑Â∏´„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                        answer: stage === 2 ? ['I', 'am', 'not', 'busy', '.'] :
                               stage === 3 ? ['It', 'is', 'not', 'expensive', '.'] :
                               stage === 4 ? ['They', 'are', 'not', 'students', '.'] :
                               stage === 5 ? ['I', 'am', 'not', 'tired', '.'] :
                               stage === 6 ? ['This', 'is', 'not', 'new', '.'] :
                               ['She', 'is', 'not', 'a', 'nurse', '.'],
                        hint: 'beÂãïË©û„ÅÆÂê¶ÂÆöÊñá„ÅØ„ÄåbeÂãïË©û + not„Äç„ÅÆÂΩ¢„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'beÂãïË©û„ÉªÁñëÂïèÊñá',
                        japanese: stage === 2 ? '„ÅÇ„Å™„Åü„ÅØÊ∫ñÂÇô„Åå„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü' :
                                 stage === 3 ? '„Åì„Çå„ÅØ„ÅÇ„Å™„Åü„ÅÆ„Éö„É≥„Åß„Åô„ÅãÔºü' :
                                 stage === 4 ? 'ÂΩº„Çâ„ÅØÂÆ∂„Å´„ÅÑ„Åæ„Åô„ÅãÔºü' :
                                 stage === 5 ? '„Åù„Çå„ÅØÈõ£„Åó„ÅÑ„Åß„Åô„ÅãÔºü' :
                                 stage === 6 ? '„ÅÇ„Å™„Åü„ÅØÂ§ß‰∏àÂ§´„Åß„Åô„ÅãÔºü' :
                                 'ÂΩº„ÅØÂøô„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['Are', 'you', 'ready', '?'] :
                               stage === 3 ? ['Is', 'this', 'your', 'pen', '?'] :
                               stage === 4 ? ['Are', 'they', 'at', 'home', '?'] :
                               stage === 5 ? ['Is', 'it', 'difficult', '?'] :
                               stage === 6 ? ['Are', 'you', 'OK', '?'] :
                               ['Is', 'he', 'busy', '?'],
                        hint: 'beÂãïË©û„ÅÆÁñëÂïèÊñá„ÅØ„ÄåbeÂãïË©û + ‰∏ªË™û„Äç„ÅÆÈ†ÜÁï™„Åß„Åô„ÄÇ'
                    },
                    {
                        type: '‰∏ÄËà¨ÂãïË©û„ÉªËÇØÂÆöÊñá',
                        japanese: stage === 2 ? 'ÂΩºÂ•≥„ÅØÊú¨„ÇíË™≠„Åø„Åæ„Åô„ÄÇ' :
                                 stage === 3 ? 'ÁßÅ„Åü„Å°„ÅØ„ÉÜ„Éã„Çπ„Çí„Åó„Åæ„Åô„ÄÇ' :
                                 stage === 4 ? 'ÂΩº„ÅØÊó©„ÅèËµ∑„Åç„Åæ„Åô„ÄÇ' :
                                 stage === 5 ? 'ÁßÅ„ÅØÁä¨„ÇíÈ£º„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ' :
                                 stage === 6 ? 'ÂΩºÂ•≥„ÅØÊñôÁêÜ„Çí‰Ωú„Çä„Åæ„Åô„ÄÇ' :
                                 'ÂΩº„Çâ„ÅØËã±Ë™û„ÇíË©±„Åó„Åæ„Åô„ÄÇ',
                        answer: stage === 2 ? ['She', 'reads', 'books', '.'] :
                               stage === 3 ? ['We', 'play', 'tennis', '.'] :
                               stage === 4 ? ['He', 'gets', 'up', 'early', '.'] :
                               stage === 5 ? ['I', 'have', 'a', 'dog', '.'] :
                               stage === 6 ? ['She', 'cooks', 'food', '.'] :
                               ['They', 'speak', 'English', '.'],
                        hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÁèæÂú®ÂΩ¢„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                    },
                    {
                        type: '‰∏ÄËà¨ÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                        japanese: stage === 2 ? 'ÁßÅ„ÅØ„ÉÜ„É¨„Éì„ÇíË¶ã„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 3 ? 'ÂΩºÂ•≥„ÅØËÇâ„ÇíÈ£ü„Åπ„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 4 ? 'ÂΩº„Çâ„ÅØÂÆøÈ°å„Çí„Åó„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 5 ? 'ÁßÅ„ÅØËªä„ÇíÈÅãËª¢„Åó„Åæ„Åõ„Çì„ÄÇ' :
                                 stage === 6 ? 'ÂΩº„ÅØÊ∞¥Ê≥≥„Çí„Åó„Åæ„Åõ„Çì„ÄÇ' :
                                 'ÁßÅ„Åü„Å°„ÅØ„Ç≥„Éº„Éí„Éº„ÇíÈ£≤„Åø„Åæ„Åõ„Çì„ÄÇ',
                        answer: stage === 2 ? ['I', 'do', 'not', 'watch', 'TV', '.'] :
                               stage === 3 ? ['She', 'does', 'not', 'eat', 'meat', '.'] :
                               stage === 4 ? ['They', 'do', 'not', 'do', 'homework', '.'] :
                               stage === 5 ? ['I', 'do', 'not', 'drive', 'a', 'car', '.'] :
                               stage === 6 ? ['He', 'does', 'not', 'swim', '.'] :
                               ['We', 'do', 'not', 'drink', 'coffee', '.'],
                        hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÂê¶ÂÆöÊñá„ÅØ„Äådo/does + not + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                    },
                    {
                        type: '‰∏ÄËà¨ÂãïË©û„ÉªÁñëÂïèÊñá',
                        japanese: stage === 2 ? 'ÂΩº„ÅØ„ÇÆ„Çø„Éº„ÇíÂºæ„Åç„Åæ„Åô„ÅãÔºü' :
                                 stage === 3 ? '„ÅÇ„Å™„Åü„ÅØÊúùÈ£ü„ÇíÈ£ü„Åπ„Åæ„Åô„ÅãÔºü' :
                                 stage === 4 ? 'ÂΩºÂ•≥„ÅØÊó•Êú¨Ë™û„ÇíË©±„Åó„Åæ„Åô„ÅãÔºü' :
                                 stage === 5 ? 'ÂΩº„Çâ„ÅØÈáéÁêÉ„Çí„Åó„Åæ„Åô„ÅãÔºü' :
                                 stage === 6 ? '„ÅÇ„Å™„Åü„ÅØÊú¨„ÇíË™≠„Åø„Åæ„Åô„ÅãÔºü' :
                                 'ÂΩº„ÅØÊñôÁêÜ„Çí„Åó„Åæ„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['Does', 'he', 'play', 'the', 'guitar', '?'] :
                               stage === 3 ? ['Do', 'you', 'eat', 'breakfast', '?'] :
                               stage === 4 ? ['Does', 'she', 'speak', 'Japanese', '?'] :
                               stage === 5 ? ['Do', 'they', 'play', 'baseball', '?'] :
                               stage === 6 ? ['Do', 'you', 'read', 'books', '?'] :
                               ['Does', 'he', 'cook', '?'],
                        hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÁñëÂïèÊñá„ÅØ„ÄåDo/Does + ‰∏ªË™û + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                    }
                ],
                'handwriting-question': [
                    {
                        type: 'ÁñëÂïèË©û„ÉªWhat',
                        japanese: stage === 2 ? '„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ‰Ωï„Åß„Åô„ÅãÔºü' :
                                 stage === 3 ? '‰ΩïÊôÇ„Åß„Åô„ÅãÔºü' :
                                 stage === 4 ? '‰Ωï„ÇíÈ£ü„Åπ„Åæ„Åó„Åü„ÅãÔºü' :
                                 stage === 5 ? 'Ë∂£Âë≥„ÅØ‰Ωï„Åß„Åô„ÅãÔºü' :
                                 stage === 6 ? '‰ΩïËâ≤„ÅåÂ•Ω„Åç„Åß„Åô„ÅãÔºü' :
                                 '‰Ωï„ÇíÂãâÂº∑„Åó„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['What', 'is', 'your', 'name', '?'] :
                               stage === 3 ? ['What', 'time', 'is', 'it', '?'] :
                               stage === 4 ? ['What', 'did', 'you', 'eat', '?'] :
                               stage === 5 ? ['What', 'is', 'your', 'hobby', '?'] :
                               stage === 6 ? ['What', 'color', 'do', 'you', 'like', '?'] :
                               ['What', 'are', 'you', 'studying', '?'],
                        hint: 'What„ÅØ„Äå‰Ωï„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'ÁñëÂïèË©û„ÉªWhere',
                        japanese: stage === 2 ? 'ÈßÖ„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü' :
                                 stage === 3 ? '„Å©„Åì„ÅßÁîü„Åæ„Çå„Åæ„Åó„Åü„ÅãÔºü' :
                                 stage === 4 ? 'Êú¨„ÅØ„Å©„Åì„Å´„ÅÇ„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 5 ? '„Å©„Åì„ÅßÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü' :
                                 stage === 6 ? '„Å©„Åì„Å´Ë°å„Åç„Åü„ÅÑ„Åß„Åô„ÅãÔºü' :
                                 '„Ç´„ÇÆ„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['Where', 'is', 'the', 'station', '?'] :
                               stage === 3 ? ['Where', 'were', 'you', 'born', '?'] :
                               stage === 4 ? ['Where', 'is', 'the', 'book', '?'] :
                               stage === 5 ? ['Where', 'do', 'you', 'work', '?'] :
                               stage === 6 ? ['Where', 'do', 'you', 'want', 'to', 'go', '?'] :
                               ['Where', 'is', 'the', 'key', '?'],
                        hint: 'Where„ÅØ„Äå„Å©„Åì„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'ÁñëÂïèË©û„ÉªWhen',
                        japanese: stage === 2 ? '„ÅÑ„Å§Â∏∞„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 3 ? 'Ë™ïÁîüÊó•„ÅØ„ÅÑ„Å§„Åß„Åô„ÅãÔºü' :
                                 stage === 4 ? '„ÅÑ„Å§‰ºö„ÅÑ„Åæ„Åó„Çá„ÅÜ„ÅãÔºü' :
                                 stage === 5 ? '„ÅÑ„Å§Âßã„Åæ„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 6 ? '„ÅÑ„Å§ÂãâÂº∑„Åó„Åæ„Åô„ÅãÔºü' :
                                 '„ÅÑ„Å§ÂØù„Åæ„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['When', 'will', 'you', 'go', 'home', '?'] :
                               stage === 3 ? ['When', 'is', 'your', 'birthday', '?'] :
                               stage === 4 ? ['When', 'shall', 'we', 'meet', '?'] :
                               stage === 5 ? ['When', 'does', 'it', 'start', '?'] :
                               stage === 6 ? ['When', 'do', 'you', 'study', '?'] :
                               ['When', 'do', 'you', 'sleep', '?'],
                        hint: 'When„ÅØ„Äå„ÅÑ„Å§„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'ÁñëÂïèË©û„ÉªWho',
                        japanese: stage === 2 ? 'Ë™∞„ÅåÊù•„Åæ„Åó„Åü„ÅãÔºü' :
                                 stage === 3 ? '„ÅÇ„Çå„ÅØË™∞„Åß„Åô„ÅãÔºü' :
                                 stage === 4 ? 'Ë™∞„Å®Ë°å„Åç„Åæ„Åô„ÅãÔºü' :
                                 stage === 5 ? 'Ë™∞„ÅåÊïô„Åà„Å¶„Åè„Çå„Åæ„Åó„Åü„ÅãÔºü' :
                                 stage === 6 ? 'Ë™∞„ÅåÂ•Ω„Åç„Åß„Åô„ÅãÔºü' :
                                 'Ë™∞„ÅåÊñôÁêÜ„Çí„Åó„Åæ„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['Who', 'came', '?'] :
                               stage === 3 ? ['Who', 'is', 'that', '?'] :
                               stage === 4 ? ['Who', 'will', 'you', 'go', 'with', '?'] :
                               stage === 5 ? ['Who', 'told', 'you', '?'] :
                               stage === 6 ? ['Who', 'do', 'you', 'like', '?'] :
                               ['Who', 'cooks', '?'],
                        hint: 'Who„ÅØ„ÄåË™∞„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'ÁñëÂïèË©û„ÉªWhy',
                        japanese: stage === 2 ? '„Å™„ÅúÈÅÖ„Çå„Åü„ÅÆ„Åß„Åô„ÅãÔºü' :
                                 stage === 3 ? '„Å™„ÅúÊó•Êú¨„Å´Êù•„Åæ„Åó„Åü„ÅãÔºü' :
                                 stage === 4 ? '„Å™„Åú„Åù„Çå„ÅåÂ•Ω„Åç„Åß„Åô„ÅãÔºü' :
                                 stage === 5 ? '„Å™„ÅúÂãâÂº∑„Åó„Åæ„Åô„ÅãÔºü' :
                                 stage === 6 ? '„Å™„ÅúÊ≥£„ÅÑ„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åô„ÅãÔºü' :
                                 '„Å™„Åú„Åì„Åì„Å´„ÅÑ„Çã„ÅÆ„Åß„Åô„ÅãÔºü',
                        answer: stage === 2 ? ['Why', 'were', 'you', 'late', '?'] :
                               stage === 3 ? ['Why', 'did', 'you', 'come', 'to', 'Japan', '?'] :
                               stage === 4 ? ['Why', 'do', 'you', 'like', 'it', '?'] :
                               stage === 5 ? ['Why', 'do', 'you', 'study', '?'] :
                               stage === 6 ? ['Why', 'are', 'you', 'crying', '?'] :
                               ['Why', 'are', 'you', 'here', '?'],
                        hint: 'Why„ÅØ„Äå„Å™„Åú„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    },
                    {
                        type: 'ÁñëÂïèË©û„ÉªHow',
                        japanese: stage === 2 ? '„Å©„ÅÆ„Åè„Çâ„ÅÑÊôÇÈñì„Åå„Åã„Åã„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 3 ? 'ÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü' :
                                 stage === 4 ? '„Å©„ÅÜ„ÇÑ„Å£„Å¶‰Ωú„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 5 ? '„ÅÑ„Åè„Å§„ÅÇ„Çä„Åæ„Åô„ÅãÔºü' :
                                 stage === 6 ? '„Å©„ÅÆ„Åè„Çâ„ÅÑÈÅ†„ÅÑ„Åß„Åô„ÅãÔºü' :
                                 '„Å©„ÅÜ„Åß„Åó„Åü„ÅãÔºü',
                        answer: stage === 2 ? ['How', 'long', 'does', 'it', 'take', '?'] :
                               stage === 3 ? ['How', 'are', 'you', '?'] :
                               stage === 4 ? ['How', 'do', 'you', 'make', 'it', '?'] :
                               stage === 5 ? ['How', 'many', 'are', 'there', '?'] :
                               stage === 6 ? ['How', 'far', 'is', 'it', '?'] :
                               ['How', 'was', 'it', '?'],
                        hint: 'How„ÅØ„Äå„Å©„ÅÆ„Çà„ÅÜ„Å´„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                    }
                ]
            };
        }
    })();// Êé°ÁÇπÊ©üËÉΩÔºà„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©Ôºâ
    function calculateScore(type) {
        calculateScoreWithApi(type);
    }

    // calculateScoreÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÊòéÁ§∫ÁöÑ„Å´ËøΩÂä†
    window.calculateScore = calculateScore;

    // Èü≥Â£∞ÂêàÊàêÊ©üËÉΩ
    function speakText(text, rate = 0.8) {
        if ('speechSynthesis' in window && text) {
            try {
                speechSynthesis.cancel(); // Êó¢Â≠ò„ÅÆÈü≥Â£∞„ÇíÂÅúÊ≠¢
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Èü≥Â£∞ÂêàÊàê„Ç®„É©„Éº:', error);
            }
        }
    }

    function speakTextSlow(text) {
        speakText(text, 0.5);
    }    // ÂÖ®ÂçòË™ûÈü≥Â£∞ÂÜçÁîüÔºà„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©Ôºâ
    function playAllVocabulary() {
        const words = stageVocabulary[currentStage] || [];
        if (words.length === 0) {
            showError('„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å´„ÅØÂçòË™û„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        let index = 0;
        function playNext() {
            if (index < words.length) {
                speakText(words[index].word);
                index++;
                setTimeout(playNext, 2000);
            }
        }
        playNext();
    }
    window.playAllVocabulary = playAllVocabulary;

    // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Êõ¥Êñ∞
    function updateUserInfo() {
        const studentNameElement = document.getElementById('student-name-display');
        const currentPointsElement = document.getElementById('current-points');
        
        if (studentNameElement) {
            studentNameElement.textContent = currentUser || 'Unknown';
        }
        
        if (currentPointsElement) {
            currentPointsElement.textContent = currentPoints;
        }
    }

    // „Çπ„ÉÜ„Éº„Ç∏„Åî„Å®„ÅÆÂïèÈ°å„Éá„Éº„Çø
    const stageProblems = {
        1: {
            basic: [
                {
                    type: 'beÂãïË©û„ÉªËÇØÂÆöÊñá',
                    japanese: 'ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô„ÄÇ',
                    answer: ['I', 'am', 'a', 'student', '.'],
                    hint: 'beÂãïË©ûÔºàam/is/areÔºâ„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ‰∏ªË™û„ÅåI„ÅÆÂ†¥Âêà„ÅØam„Åß„Åô„ÄÇ'
                },
                {
                    type: 'beÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÂΩº„ÅØÂåªËÄÖ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['He', 'is', 'not', 'a', 'doctor', '.'],
                    hint: 'beÂãïË©û„ÅÆÂê¶ÂÆöÊñá„ÅØ„ÄåbeÂãïË©û + not„Äç„ÅÆÂΩ¢„Åß„Åô„ÄÇ'
                },
                {
                    type: 'beÂãïË©û„ÉªÁñëÂïèÊñá',
                    japanese: '„ÅÇ„Å™„Åü„ÅØÂøô„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
                    answer: ['Are', 'you', 'busy', '?'],
                    hint: 'beÂãïË©û„ÅÆÁñëÂïèÊñá„ÅØ„ÄåbeÂãïË©û + ‰∏ªË™û„Äç„ÅÆÈ†ÜÁï™„Åß„Åô„ÄÇ'
                },
                {
                    type: 'beÂãïË©û„ÉªËÇØÂÆöÊñá',
                    japanese: 'ÂΩºÂ•≥„ÅØÂÖàÁîü„Åß„Åô„ÄÇ',
                    answer: ['She', 'is', 'a', 'teacher', '.'],
                    hint: '‰∏ªË™û„ÅåShe/He/It„ÅÆÂ†¥Âêà„ÅØis„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'beÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÁßÅ„Åü„Å°„ÅØÊó•Êú¨‰∫∫„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['We', 'are', 'not', 'Japanese', '.'],
                    hint: '‰∏ªË™û„ÅåWe/You/They„ÅÆÂ†¥Âêà„ÅØare„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'beÂãïË©û„ÉªÁñëÂïèÊñá',
                    japanese: 'ÂΩº„ÅØË¶™Âàá„Åß„Åô„ÅãÔºü',
                    answer: ['Is', 'he', 'kind', '?'],
                    hint: '‰∏â‰∫∫Áß∞ÂçòÊï∞„ÅÆÁñëÂïèÊñá„ÅØ„ÄåIs + ‰∏ªË™û„Äç„Åã„ÇâÂßã„Åæ„Çä„Åæ„Åô„ÄÇ'
                }
            ],
            question: [
                {
                    type: 'ÁñëÂïèË©û„ÉªWhat',
                    japanese: '„Åì„Çå„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    answer: ['What', 'is', 'this', '?'],
                    hint: 'What„ÅØ„Äå‰Ωï„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWho',
                    japanese: '„ÅÇ„ÅÆ‰∫∫„ÅØË™∞„Åß„Åô„ÅãÔºü',
                    answer: ['Who', 'is', 'that', 'person', '?'],
                    hint: 'Who„ÅØ„ÄåË™∞„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhat',
                    japanese: '„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    answer: ['What', 'is', 'your', 'name', '?'],
                    hint: '„Äå„ÅÇ„Å™„Åü„ÅÆ„Äç„ÅØyour„ÅßË°®Áèæ„Åó„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWho',
                    japanese: 'ÂΩºÂ•≥„ÅØË™∞„Åß„Åô„ÅãÔºü',
                    answer: ['Who', 'is', 'she', '?'],
                    hint: 'Who„ÅÆÂæå„Å´beÂãïË©û„Å®‰∏ªË™û„ÅåÁ∂ö„Åç„Åæ„Åô„ÄÇ'
                }
            ]
        },
        2: {
            basic: [
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÁèæÂú®ÂΩ¢',
                    japanese: 'ÁßÅ„ÅØÊØéÊó•Ëã±Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ',
                    answer: ['I', 'study', 'English', 'every', 'day', '.'],
                    hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÁèæÂú®ÂΩ¢„Åß„Åô„ÄÇ‰∏ªË™û„ÅåI/you/we/they„ÅÆÂ†¥Âêà„ÅØÂãïË©û„ÅÆÂéüÂΩ¢„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                },
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÂΩº„ÅØÈáéÁêÉ„Çí„Åó„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['He', 'does', 'not', 'play', 'baseball', '.'],
                    hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÂê¶ÂÆöÊñá„ÅØ„Äådo/does + not + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÁñëÂïèÊñá',
                    japanese: '„ÅÇ„Å™„Åü„ÅØÈü≥Ê•Ω„ÅåÂ•Ω„Åç„Åß„Åô„ÅãÔºü',
                    answer: ['Do', 'you', 'like', 'music', '?'],
                    hint: '‰∏ÄËà¨ÂãïË©û„ÅÆÁñëÂïèÊñá„ÅØ„ÄåDo/Does + ‰∏ªË™û + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÁèæÂú®ÂΩ¢',
                    japanese: 'ÂΩºÂ•≥„ÅØÊØéÊúù„Ç≥„Éº„Éí„Éº„ÇíÈ£≤„Åø„Åæ„Åô„ÄÇ',
                    answer: ['She', 'drinks', 'coffee', 'every', 'morning', '.'],
                    hint: '‰∏â‰∫∫Áß∞ÂçòÊï∞„ÅÆÂ†¥Âêà„ÄÅÂãïË©û„Å´s„Åæ„Åü„ÅØes„Çí„Å§„Åë„Åæ„Åô„ÄÇ'
                },
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÁßÅ„ÅØËÇâ„ÇíÈ£ü„Åπ„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['I', 'do', 'not', 'eat', 'meat', '.'],
                    hint: 'I/you/we/they„ÅÆÂê¶ÂÆöÊñá„ÅØ„Äådo not + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: '‰∏ÄËà¨ÂãïË©û„ÉªÁñëÂïèÊñá',
                    japanese: 'ÂΩº„ÅØÊú¨„ÇíË™≠„Åø„Åæ„Åô„ÅãÔºü',
                    answer: ['Does', 'he', 'read', 'books', '?'],
                    hint: '‰∏â‰∫∫Áß∞ÂçòÊï∞„ÅÆÁñëÂïèÊñá„ÅØ„ÄåDoes + ‰∏ªË™û + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                }
            ],
            question: [
                {
                    type: 'ÁñëÂïèË©û„ÉªWhere',
                    japanese: '„ÅÇ„Å™„Åü„ÅØ„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÅãÔºü',
                    answer: ['Where', 'do', 'you', 'live', '?'],
                    hint: 'Where„ÅØ„Äå„Å©„Åì„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhen',
                    japanese: '„ÅÑ„Å§Â≠¶Ê†°„Å´Ë°å„Åç„Åæ„Åô„ÅãÔºü',
                    answer: ['When', 'do', 'you', 'go', 'to', 'school', '?'],
                    hint: 'When„ÅØ„Äå„ÅÑ„Å§„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhere',
                    japanese: 'ÂΩº„ÅØ„Å©„Åì„ÅßÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü',
                    answer: ['Where', 'does', 'he', 'work', '?'],
                    hint: '‰∏â‰∫∫Áß∞ÂçòÊï∞„Åß„ÅØ„ÄåWhere does + ‰∏ªË™û + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhen',
                    japanese: 'ÂΩºÂ•≥„ÅØ„ÅÑ„Å§„ÉÜ„Éã„Çπ„Çí„Åó„Åæ„Åô„ÅãÔºü',
                    answer: ['When', 'does', 'she', 'play', 'tennis', '?'],
                    hint: 'When„ÅÆÂæå„ÅØdoes„Çí‰Ωø„Å£„Å¶ÁñëÂïèÊñá„Çí‰Ωú„Çä„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhat',
                    japanese: '„ÅÇ„Å™„Åü„ÅØ‰Ωï„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÅãÔºü',
                    answer: ['What', 'do', 'you', 'study', '?'],
                    hint: '„Äå‰Ωï„Çí„Äç„ÅØwhat„ÅßË°®Áèæ„Åó„ÄÅdo„Çí‰Ωø„Å£„Å¶ÁñëÂïèÊñá„Çí‰Ωú„Çä„Åæ„Åô„ÄÇ'
                }
            ]
        },
        3: {
            basic: [
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªËÇØÂÆöÊñá',
                    japanese: 'ÂΩº„ÅØ‰ªä„ÉÜ„É¨„Éì„ÇíË¶ã„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                    answer: ['He', 'is', 'watching', 'TV', 'now', '.'],
                    hint: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÅØ„ÄåbeÂãïË©û + ÂãïË©û„ÅÆingÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÁßÅ„ÅØ‰ªäÂãâÂº∑„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['I', 'am', 'not', 'studying', 'now', '.'],
                    hint: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÅÆÂê¶ÂÆöÊñá„ÅØ„ÄåbeÂãïË©û + not + ÂãïË©û„ÅÆingÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªÁñëÂïèÊñá',
                    japanese: '„ÅÇ„Å™„Åü„ÅØ‰ªä‰Ωï„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü',
                    answer: ['What', 'are', 'you', 'doing', 'now', '?'],
                    hint: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÅÆÁñëÂïèÊñá„ÅØ„ÄåbeÂãïË©û + ‰∏ªË™û + ÂãïË©û„ÅÆingÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªËÇØÂÆöÊñá',
                    japanese: 'ÂΩºÂ•≥„ÅØ‰ªäÊñôÁêÜ„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                    answer: ['She', 'is', 'cooking', 'now', '.'],
                    hint: 'cook„ÅÆÈÄ≤Ë°åÂΩ¢„ÅØcooking„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªÂê¶ÂÆöÊñá',
                    japanese: 'ÁßÅ„Åü„Å°„ÅØ‰ªäÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
                    answer: ['We', 'are', 'not', 'working', 'now', '.'],
                    hint: 'We„ÅÆÂ†¥Âêà„ÅØare„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'ÁèæÂú®ÈÄ≤Ë°åÂΩ¢„ÉªÁñëÂïèÊñá',
                    japanese: 'ÂΩº„ÅØ‰ªäËµ∞„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü',
                    answer: ['Is', 'he', 'running', 'now', '?'],
                    hint: 'run„ÅÆÈÄ≤Ë°åÂΩ¢„ÅØrunning„Åß„ÅôÔºàn„ÇíÈáç„Å≠„ÇãÔºâ„ÄÇ'
                }
            ],
            question: [
                {
                    type: 'ÁñëÂïèË©û„ÉªHow',
                    japanese: '„Å©„ÅÜ„ÇÑ„Å£„Å¶Â≠¶Ê†°„Å´Ë°å„Åç„Åæ„Åô„ÅãÔºü',
                    answer: ['How', 'do', 'you', 'go', 'to', 'school', '?'],
                    hint: 'How„ÅØ„Äå„Å©„ÅÆ„Çà„ÅÜ„Å´„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhy',
                    japanese: '„Å™„ÅúËã±Ë™û„ÇíÂãâÂº∑„Åô„Çã„ÅÆ„Åß„Åô„ÅãÔºü',
                    answer: ['Why', 'do', 'you', 'study', 'English', '?'],
                    hint: 'Why„ÅØ„Äå„Å™„Åú„Äç„ÇíË°®„ÅôÁñëÂïèË©û„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªHow',
                    japanese: 'ÂΩºÂ•≥„ÅØ„Å©„ÅÜ„ÇÑ„Å£„Å¶‰ªï‰∫ã„Å´Ë°å„Åç„Åæ„Åô„ÅãÔºü',
                    answer: ['How', 'does', 'she', 'go', 'to', 'work', '?'],
                    hint: '‰∏â‰∫∫Áß∞ÂçòÊï∞„Åß„ÅØ„ÄåHow does + ‰∏ªË™û + ÂãïË©û„ÅÆÂéüÂΩ¢„Äç„Åß„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhy',
                    japanese: '„Å™„ÅúÂΩº„ÅØÈÅÖÂàª„Åó„Åü„ÅÆ„Åß„Åô„ÅãÔºü',
                    answer: ['Why', 'is', 'he', 'late', '?'],
                    hint: '„ÄåÈÅÖÂàª„Åó„Å¶„ÅÑ„Çã„ÄçÁä∂ÊÖã„Å™„ÅÆ„Åß„ÄÅbeÂãïË©û„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                },
                {
                    type: 'ÁñëÂïèË©û„ÉªWhat',
                    japanese: '‰ªä‰ΩïÊôÇ„Åß„Åô„ÅãÔºü',
                    answer: ['What', 'time', 'is', 'it', 'now', '?'],
                    hint: 'ÊôÇÂàª„ÇíËÅû„Åè„Å®„Åç„ÅØ„ÄåWhat time is it?„Äç„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ'
                }
            ]
        }
    };    // „Çπ„ÉÜ„Éº„Ç∏„Åî„Å®„ÅÆÂçòË™û„Éá„Éº„Çø
    const stageVocabulary = {
        1: [
            { word: 'student', pronunciation: '/Ààstud…ônt/', meaning: 'Â≠¶Áîü', example: 'I am a student.' },
            { word: 'teacher', pronunciation: '/Ààtit É…ôr/', meaning: 'ÂÖàÁîü', example: 'She is a teacher.' },
            { word: 'doctor', pronunciation: '/Ààd…îkt…ôr/', meaning: 'ÂåªËÄÖ', example: 'He is not a doctor.' },
            { word: 'busy', pronunciation: '/Ààb…™zi/', meaning: 'Âøô„Åó„ÅÑ', example: 'Are you busy?' },
            { word: 'happy', pronunciation: '/Ààh√¶pi/', meaning: 'Âπ∏„Åõ„Å™', example: 'I am happy.' },
            { word: 'kind', pronunciation: '/ka…™nd/', meaning: 'Ë¶™Âàá„Å™', example: 'He is kind.' },
            { word: 'young', pronunciation: '/j å≈ã/', meaning: 'Ëã•„ÅÑ', example: 'She is young.' },
            { word: 'old', pronunciation: '/o äld/', meaning: 'Âπ¥ËÄÅ„ÅÑ„Åü', example: 'My grandfather is old.' },
            { word: 'new', pronunciation: '/nu/', meaning: 'Êñ∞„Åó„ÅÑ', example: 'This is a new book.' },
            { word: 'big', pronunciation: '/b…™…°/', meaning: 'Â§ß„Åç„ÅÑ', example: 'The elephant is big.' }
        ],
        2: [
            { word: 'study', pronunciation: '/Ààst ådi/', meaning: 'ÂãâÂº∑„Åô„Çã', example: 'I study English every day.' },
            { word: 'play', pronunciation: '/ple…™/', meaning: 'ÈÅä„Å∂„ÄÅÊºîÂ•è„Åô„Çã', example: 'He plays baseball.' },
            { word: 'like', pronunciation: '/la…™k/', meaning: 'Â•Ω„Åç', example: 'Do you like music?' },
            { word: 'live', pronunciation: '/l…™v/', meaning: '‰Ωè„ÇÄ', example: 'Where do you live?' },
            { word: 'music', pronunciation: '/Ààmjuz…™k/', meaning: 'Èü≥Ê•Ω', example: 'I like music.' },
            { word: 'work', pronunciation: '/w…úrk/', meaning: 'ÂÉç„Åè', example: 'He works in a hospital.' },
            { word: 'eat', pronunciation: '/it/', meaning: 'È£ü„Åπ„Çã', example: 'I eat breakfast every morning.' },
            { word: 'drink', pronunciation: '/dr…™≈ãk/', meaning: 'È£≤„ÇÄ', example: 'She drinks coffee.' },
            { word: 'speak', pronunciation: '/spik/', meaning: 'Ë©±„Åô', example: 'Do you speak Japanese?' },
            { word: 'read', pronunciation: '/rid/', meaning: 'Ë™≠„ÇÄ', example: 'I read books.' }
        ],
        3: [
            { word: 'watching', pronunciation: '/Ààw…ët É…™≈ã/', meaning: 'Ë¶ã„Å¶„ÅÑ„Çã', example: 'He is watching TV.' },
            { word: 'studying', pronunciation: '/Ààst ådi…™≈ã/', meaning: 'ÂãâÂº∑„Åó„Å¶„ÅÑ„Çã', example: 'I am studying now.' },
            { word: 'doing', pronunciation: '/Ààdu…™≈ã/', meaning: '„Åó„Å¶„ÅÑ„Çã', example: 'What are you doing?' },
            { word: 'reading', pronunciation: '/Ààrid…™≈ã/', meaning: 'Ë™≠„Çì„Åß„ÅÑ„Çã', example: 'She is reading a book.' },
            { word: 'writing', pronunciation: '/Ààra…™t…™≈ã/', meaning: 'Êõ∏„ÅÑ„Å¶„ÅÑ„Çã', example: 'I am writing a letter.' },
            { word: 'cooking', pronunciation: '/Ààk äk…™≈ã/', meaning: 'ÊñôÁêÜ„Åó„Å¶„ÅÑ„Çã', example: 'Mom is cooking dinner.' },
            { word: 'running', pronunciation: '/Ààr ån…™≈ã/', meaning: 'Ëµ∞„Å£„Å¶„ÅÑ„Çã', example: 'He is running in the park.' },
            { word: 'sleeping', pronunciation: '/Ààslip…™≈ã/', meaning: 'Áú†„Å£„Å¶„ÅÑ„Çã', example: 'The baby is sleeping.' },
            { word: 'walking', pronunciation: '/Ààw…îk…™≈ã/', meaning: 'Ê≠©„ÅÑ„Å¶„ÅÑ„Çã', example: 'We are walking to school.' },
            { word: 'playing', pronunciation: '/Ààple…™…™≈ã/', meaning: 'ÈÅä„Çì„Åß„ÅÑ„Çã', example: 'Children are playing soccer.' }
        ]
    };

    // ÂàùÊúüÂåñÂá¶ÁêÜ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü - ÂàùÊúüÂåñÈñãÂßã');
        initializeAudio();
        selectStage(1);
        updateUserInfo();
        switchTab('basic');
    });

    // Èü≥Â£∞„ÅÆÂàùÊúüÂåñ
    function initializeAudio() {
        if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.addEventListener('voiceschanged', function() {
                englishVoice = getEnglishVoice();
            });
        } else {
            englishVoice = getEnglishVoice();
        }
    }

    // Ëã±Ë™ûÈü≥Â£∞„ÅÆÂèñÂæó
    function getEnglishVoice() {
        const voices = speechSynthesis.getVoices();
        return voices.find(voice => voice.lang === 'en-US') || 
               voices.find(voice => voice.lang.startsWith('en-')) || 
               voices[0];
    }

    // Èü≥Â£∞Ë™≠„Åø‰∏ä„ÅíÊ©üËÉΩ
    function speakText(text, lang = 'en-US', rate = 0.8) {
        if (!speechSynthesis || !text) return;
        
        try {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = rate;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            if (lang.startsWith('en') && englishVoice) {
                utterance.voice = englishVoice;
            }
            
            speechSynthesis.speak(utterance);
        } catch (error) {
            console.error('Èü≥Â£∞ÂêàÊàê„Ç®„É©„Éº:', error);
        }
    }    // „ÇÜ„Å£„Åè„ÇäÈü≥Â£∞ÂÜçÁîü
    function speakTextSlow(text, lang = 'en-US') {
        speakText(text, lang, 0.6);
    }

    // Èü≥Â£∞Èñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÊòéÁ§∫ÁöÑ„Å´ËøΩÂä†
    window.speakText = speakText;
    window.speakTextSlow = speakTextSlow;// „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
    function updateUserInfo() {
        const userNameElement = document.getElementById('student-name-display');
        const userPointsElement = document.getElementById('current-points');
        
        if (userNameElement) {
            userNameElement.textContent = currentUser;
        }
        if (userPointsElement) {
            userPointsElement.textContent = currentPoints;
        }
    }

    // ÂïèÈ°åÂàùÊúüÂåñ
    function initializeProblems() {
        userAnswers = { basic: {}, question: {} };
        handwritingData = {};
        
        const currentProblems = stageProblems[currentStage] || { basic: [], question: [] };
        renderProblems('basic', currentProblems.basic);
        renderProblems('question', currentProblems.question);
        initializeVocabulary();
    }

    // ÂçòË™ûÂ≠¶Áøí„ÅÆÂàùÊúüÂåñ
    function initializeVocabulary() {
        document.getElementById('vocab-stage-number').textContent = currentStage;
        const vocabularyList = document.getElementById('vocabulary-list');
        vocabularyList.innerHTML = '';
        
        const words = stageVocabulary[currentStage] || [];
        words.forEach((wordData, index) => {
            const wordCard = document.createElement('div');
            wordCard.className = 'vocabulary-card';
            wordCard.innerHTML = `
                <div class="vocab-word">${wordData.word}</div>
                <div class="vocab-pronunciation">${wordData.pronunciation}</div>
                <div class="vocab-meaning">${wordData.meaning}</div>
                <div class="vocab-example">${wordData.example}</div>
                <button class="vocab-audio-btn" onclick="speakText('${wordData.word}')">
                    <i class="fas fa-volume-up"></i> ÈÄöÂ∏∏ÈÄüÂ∫¶
                </button>
                <button class="vocab-audio-btn" onclick="speakTextSlow('${wordData.word}')" style="background: #007bff; margin-left: 5px;">
                    <i class="fas fa-volume-down"></i> „ÇÜ„Å£„Åè„Çä
                </button>
            `;
            vocabularyList.appendChild(wordCard);
        });
    }

    // ÂïèÈ°åË°®Á§∫
    function renderProblems(type, problems) {
        const container = document.getElementById(`${type}-problems`);
        container.innerHTML = '';
        
        problems.forEach((problem, index) => {
            const problemDiv = document.createElement('div');
            problemDiv.className = 'problem-container';
            problemDiv.innerHTML = `
                <div class="problem-header">
                    <span class="problem-number">ÂïèÈ°å ${index + 1}</span>
                    <span class="problem-type">${problem.type}</span>
                </div>
                <div class="japanese-sentence">${problem.japanese}</div>
                <div class="hint">${problem.hint}</div>
                <div class="handwriting-area">
                    <div class="input-label">Ë®òÂÖ•Ê¨ÑÔºö</div>
                    <div class="canvas-container" id="${type}-canvas-${index}"></div>
                </div>
                <div class="buttons-container">
                    <button class="submit-button" onclick="submitAnswer('${type}', ${index})">ÈÄÅ‰ø°</button>
                </div>
                <div id="${type}-answer-${index}" class="answer-display" style="display: none;"></div>
            `;
            container.appendChild(problemDiv);
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩúÊàê
            const canvasContainer = document.getElementById(`${type}-canvas-${index}`);
            problem.answer.forEach((word, wordIndex) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `ÂçòË™û ${wordIndex + 1}`;
                input.id = `${type}-input-${index}-${wordIndex}`;
                canvasContainer.appendChild(input);
            });
        });
    }    // ÂõûÁ≠îÈÄÅ‰ø°ÔºàÂÄãÂà•ÂïèÈ°åÁî®Ôºâ
    async function submitAnswer(type, problemIndex) {
        const problems = stageProblems[currentStage][type];
        if (!problems || !problems[problemIndex]) {
            showError('ÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        const problem = problems[problemIndex];
        const userAnswer = getUserAnswer(type, problemIndex);
        const correctAnswer = problem.answer.join(' ');
        const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();
        
        // ÁµêÊûú„ÇíË°®Á§∫
        const answerDisplay = document.getElementById(`${type}-answer-${problemIndex}`);
        if (answerDisplay) {
            answerDisplay.innerHTML = `
                <div class="answer-result ${isCorrect ? 'correct' : 'incorrect'}">
                    <div><strong>„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà:</strong> ${userAnswer}</div>
                    <div><strong>Ê≠£Ëß£:</strong> ${correctAnswer}</div>
                    <div class="result-status">${isCorrect ? '‚úÖ Ê≠£Ëß£ÔºÅ' : '‚ùå ‰∏çÊ≠£Ëß£'}</div>
                </div>
            `;
            answerDisplay.style.display = 'block';
        }
        
        // „Éù„Ç§„É≥„ÉàÁç≤Âæó
        if (isCorrect) {
            const earnedPoints = 10;
            currentPoints += earnedPoints;
            updateUserInfo();
            showSuccess(`+${earnedPoints}„Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºÅ`);
        }
          // ÂõûÁ≠î„ÇíË®òÈå≤
        if (!userAnswers[type]) {
            userAnswers[type] = {};
        }
        userAnswers[type][problemIndex] = userAnswer.split(' ');
    }
    window.submitAnswer = submitAnswer;

    // „É¶„Éº„Ç∂„Éº„ÅÆÂõûÁ≠î„ÇíÂèñÂæó
    function getUserAnswer(type, problemIndex) {
        const problem = stageProblems[currentStage][type][problemIndex];
        if (!problem) return '';
        
        const words = [];
        problem.answer.forEach((_, wordIndex) => {
            const input = document.getElementById(`${type}-input-${problemIndex}-${wordIndex}`);
            if (input) {
                words.push(input.value.trim());
            }
        });
        
        return words.join(' ');
    }    // Êé°ÁÇπÊ©üËÉΩÔºàAPIÁµ±ÂêàÁâàÔºâ
    function calculateScore(type) {
        calculateScoreWithApi(type);    }

    // „Ç®„É©„ÉºË°®Á§∫Ê©üËÉΩ
    function showError(message) {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div class="error-alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                    <button onclick="hideError()" style="background: none; border: none; color: white; font-size: 18px; margin-left: 10px; cursor: pointer;">√ó</button>
                </div>
            `;
            errorContainer.style.display = 'block';
            
            setTimeout(hideError, 5000);
        }
    }
      function hideError() {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
            errorContainer.style.display = 'none';
        }
    }
    window.hideError = hideError;
    
    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ê©üËÉΩ
    function showSuccess(message) {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div class="success-alert">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                    <button onclick="hideError()" style="background: none; border: none; color: white; font-size: 18px; margin-left: 10px; cursor: pointer;">√ó</button>
                </div>
            `;
            errorContainer.style.display = 'block';
            
            setTimeout(hideError, 3000);
        }    }    // Áµ±Ë®à„ÉªË®≠ÂÆöÈñ¢ÈÄ£    function showStatistics() {
        showError('Áµ±Ë®àÊ©üËÉΩ„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ');
    }
    window.showStatistics = showStatistics;
</script>
{% endblock %}