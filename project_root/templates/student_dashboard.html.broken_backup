{% extends "base.html" %}

{% block head_extra %}
<style>
  /* ãƒ¢ãƒ€ãƒ³ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
  .login-bonus-notification {
    background: linear-gradient(135deg, #d7f0fd, #e8f5fd);
    border-left: 4px solid var(--primary);
    animation: pulse-light 2s infinite;
  }
  
  @keyframes pulse-light {
    0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
    100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
  }
  
  /* ã‚¹ãƒãƒ›å¯¾å¿œã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
  #calendar {
    max-width: 900px;
    margin: 0 auto;
    background-color: white;
    padding: 10px;
    min-height: 480px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®èª¿æ•´ */
  @media screen and (max-width: 768px) {
    #calendar {
      padding: 5px;
      min-height: 400px;
      margin: 0 -10px; /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ */
      width: calc(100% + 20px); /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ */
      border-radius: 8px;
    }
    
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®èª¿æ•´ */
    .fc .fc-toolbar.fc-header-toolbar {
      flex-direction: column;
      gap: 8px;
      margin-bottom: 0.8em;
    }
    
    .fc .fc-toolbar-title {
      font-size: 1.2em;
      text-align: center;
      width: 100%;
      margin-bottom: 5px;
    }
    
    .fc-header-toolbar .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
      margin-bottom: 5px;
    }
    
    /* æ—¥ä»˜ã‚»ãƒ«ã®èª¿æ•´ */
    .fc .fc-daygrid-day {
      height: auto !important;
      min-height: 2em;
    }
    
    /* ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
    .fc-event-title {
      font-size: 0.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* æ—¥ä»˜ã®è¡¨ç¤ºã‚’å°ã•ã */
    .fc-daygrid-day-number {
      font-size: 0.9em;
      padding: 2px !important;
    }
    
    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¿æ•´ */
    .fc .fc-button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .fc-direction-ltr .fc-button-group > .fc-button {
      padding: 0.25em 0.55em;
      font-size: 0.9em;
    }
    
    /* ãŠçŸ¥ã‚‰ã›ã‚«ãƒ¼ãƒ‰ã®èª¿æ•´ */
    .notification-item {
      padding: 15px;
      margin-bottom: 12px;
    }
    
    /* å¿—æœ›æ ¡è¡¨ç¤ºã®æœ€é©åŒ– */
    .school-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .school-details {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    /* ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã®å¼·åŒ– */
    .bonus-content {
      flex-direction: column;
      text-align: center;
    }
    
    .bonus-icon {
      margin-right: 0;
      margin-bottom: 15px;
      font-size: 42px;
    }
    
    .bonus-link {
      width: 100%;
      text-align: center;
      padding: 10px;
    }
  }
  
  @media screen and (max-width: 480px) {
    /* å°å‹ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®è¿½åŠ èª¿æ•´ */
    #calendar {
      min-height: 350px;
    }
    
    .fc-toolbar-title {
      font-size: 1em !important;
    }
    
    .fc .fc-button {
      padding: 0.2em 0.5em;
      font-size: 0.85em;
    }
    
    .school-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .school-course {
      margin-left: 0;
      margin-top: 5px;
    }
    
    .school-name {
      font-size: 1em;
    }
  }
  
  /* å¿—æœ›æ ¡ã‚¹ã‚¿ã‚¤ãƒ« */
  .preference-list {
    margin-top: 10px;
  }
  
  .school-item {
    border-left: 4px solid #4285f4;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }
  
  .school-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }
  
  .school-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  
  .preference-order {
    background-color: #4285f4;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    margin-right: 8px;
    font-weight: bold;
  }
  
  .school-name {
    font-weight: bold;
    font-size: 1.1em;
  }
  
  .school-course {
    font-size: 0.9em;
    color: #666;
    margin-left: 5px;
  }
  
  .school-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
    margin-top: 8px;
    font-size: 0.9em;
  }
  
  .detail-label {
    color: #555;
  }
  
  .detail-value {
    font-weight: bold;
  }
  
  .point-difference {
    margin-top: 8px;
    padding: 5px;
    border-radius: 4px;
    font-weight: bold;
  }
  
  .point-difference.positive {
    background-color: #d4edda;
    color: #155724;
  }
  
  .point-difference.negative {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .login-bonus-notification {
    background-color: #e3f2fd;
    border-left: 5px solid #4285f4;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite alternate;
  }
  
  .bonus-content {
    display: flex;
    align-items: center;
  }
  
  .bonus-icon {
    font-size: 48px;
    margin-right: 20px;
    color: #4285f4;
  }
  
  .bonus-text h3 {
    color: #4285f4;
    margin-top: 0;
  }
  
  .bonus-points {
    font-size: 1.2em;
    font-weight: bold;
    color: #34a853;
  }
  
  .bonus-link {
    display: inline-block;
    background-color: #4285f4;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 5px;
  }
  
  .bonus-link:hover {
    background-color: #3367d6;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4); }
    100% { box-shadow: 0 0 0 10px rgba(66, 133, 244, 0); }
  }
</style>
{% endblock %}

{% block content %}
{% if login_bonus %}
<div class="card login-bonus-notification">
  <div class="bonus-content">
    <div class="bonus-icon">ğŸ‰</div>
    <div class="bonus-text">
      <h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ç²å¾—ï¼</h3>
      <p>æœ¬æ—¥ã®ãƒ­ã‚°ã‚¤ãƒ³ã§ <span class="bonus-points">{{ login_bonus }}</span> ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ãŸï¼</p>
      <p><a href="/myapp/index.cgi/student/points" class="bonus-link">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’ç¢ºèªã™ã‚‹</a></p>
    </div>
  </div>
</div>
{% endif %}

<div class="card">
  {% if is_teacher_login or teacher_view %}
<div class="alert alert-info">
  <p>ã‚ãªãŸã¯ç¾åœ¨ã€è¬›å¸«ã¨ã—ã¦ç”Ÿå¾’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚</p>
  {% if is_teacher_login %}
  <a href="/myapp/index.cgi/student/return-to-teacher" class="btn btn-primary">è¬›å¸«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æˆ»ã‚‹</a>
  {% else %}
  <a href="/myapp/index.cgi/teacher/dashboard" class="btn btn-primary">è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  {% endif %}
</div>
{% endif %}
  <h3><i class="fas fa-bell"></i> ãŠçŸ¥ã‚‰ã›</h3>
  {% if notifications %}
    <ul class="notification-list">
      {% for note in notifications %}
        <li class="notification-item">
          <div class="notification-date">{{ note.created_at }}</div>
          <div class="notification-content">
            <div class="notification-message">{{ note.message }}</div>
            <div class="notification-author">{{ note.teacher_name }}</div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
  {% endif %}
</div>

<div class="card">
  <h3>å¡¾ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.js"></script>
  <div id="calendar"></div>
  <script>
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã‚’å–å¾—
    var calendarEl = document.getElementById('calendar');
    
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    var checkFullCalendarInterval = setInterval(function() {
      if (typeof FullCalendar !== 'undefined') {
        clearInterval(checkFullCalendarInterval);
        console.log('FullCalendarãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        
        // ãƒ¢ãƒã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        var isMobile = window.innerWidth < 768;
        
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: isMobile ? 'listMonth' : 'dayGridMonth', // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
          locale: 'ja',
          firstDay: 1,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
          },
          buttonText: {
            today: 'ä»Šæ—¥',
            month: 'æœˆ',
            list: 'ãƒªã‚¹ãƒˆ'
          },
          height: isMobile ? 'auto' : 'auto',
          contentHeight: isMobile ? 'auto' : 'auto',
          aspectRatio: isMobile ? 1.2 : 1.35, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®èª¿æ•´
          fixedWeekCount: false,
          events: '/myapp/index.cgi/api/calendar-events',
          // ã‚¹ãƒãƒ›å‘ã‘ã«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
          eventDisplay: isMobile ? 'block' : 'auto',
          eventTimeFormat: {
            hour: 'numeric',
            minute: '2-digit',
            meridiem: false
          },
          // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®æœ€é©åŒ–
          eventMaxStack: isMobile ? 2 : 6,
          dayMaxEvents: isMobile ? 2 : true,
          // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚µã‚¤ã‚ºã«å¿œã˜ãŸãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚µã‚¤ã‚º
          windowResize: function(view) {
            var newIsMobile = window.innerWidth < 768;
            if (newIsMobile !== isMobile) {
              isMobile = newIsMobile;
              calendar.changeView(isMobile ? 'listMonth' : 'dayGridMonth');
              calendar.setOption('eventMaxStack', isMobile ? 2 : 6);
              calendar.setOption('dayMaxEvents', isMobile ? 2 : true);
            }
          },
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°æƒ…å ±
            var details = '';
            
            // æ—¥æ™‚è¡¨ç¤º
            if (info.event.allDay) {
              // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ
              var start = new Date(info.event.start);
              var options = { year: 'numeric', month: 'long', day: 'numeric' };
              var dateStr = start.toLocaleDateString('ja-JP', options);
              
              if (info.event.end) {
                var end = new Date(info.event.end);
                end.setDate(end.getDate() - 1);
                if (start.getTime() !== end.getTime()) {
                  dateStr += ' ã€œ ' + end.toLocaleDateString('ja-JP', options);
                }
              }
              
              details += 'æ—¥ä»˜: ' + dateStr;
            } else {
              // æ™‚é–“æŒ‡å®šã‚¤ãƒ™ãƒ³ãƒˆ
              var start = new Date(info.event.start);
              var dateTimeStr = start.toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric'
              });
              dateTimeStr += ' ' + start.toLocaleTimeString('ja-JP', {
                hour: '2-digit', minute: '2-digit'
              });
              
              if (info.event.end) {
                var end = new Date(info.event.end);
                if (start.toDateString() === end.toDateString()) {
                  // åŒã˜æ—¥ã®å ´åˆã¯æ™‚é–“ã ã‘è¡¨ç¤º
                  dateTimeStr += ' ã€œ ' + end.toLocaleTimeString('ja-JP', {
                    hour: '2-digit', minute: '2-digit'
                  });
                } else {
                  // ç•°ãªã‚‹æ—¥ã®å ´åˆã¯æ—¥ä»˜ã¨æ™‚é–“ã‚’è¡¨ç¤º
                  dateTimeStr += ' ã€œ ' + end.toLocaleDateString('ja-JP', {
                    year: 'numeric', month: 'long', day: 'numeric'
                  });
                  dateTimeStr += ' ' + end.toLocaleTimeString('ja-JP', {
                    hour: '2-digit', minute: '2-digit'
                  });
                }
              }
              
              details += 'æ—¥æ™‚: ' + dateTimeStr;
            }
            
            // å ´æ‰€æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
            if (info.event.extendedProps && info.event.extendedProps.location) {
              details += '\n\nå ´æ‰€: ' + info.event.extendedProps.location;
            }
            
            // èª¬æ˜æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
            if (info.event.extendedProps && info.event.extendedProps.description) {
              details += '\n\n' + info.event.extendedProps.description;
            }
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            alert(info.event.title + '\n\n' + details);
          }
        });
        
        calendar.render();
        console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
      }
    }, 100);
    
    // 10ç§’å¾Œã«ã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    setTimeout(function() {
      if (typeof FullCalendar === 'undefined') {
        clearInterval(checkFullCalendarInterval);
        console.error('FullCalendarãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        calendarEl.innerHTML = '<p style="color:red; padding:20px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
      }
    }, 10000);
  </script>
</div>

<div class="card">
  <h3>è‹±æ¤œ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>å›æ•°</th>
          <th>ç”³ã—è¾¼ã¿æœŸé–“</th>
          <th>ä¸€æ¬¡è©¦é¨“æ—¥ç¨‹</th>
          <th>äºŒæ¬¡è©¦é¨“æ—¥ç¨‹</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>ç¬¬1å›</td><td>2025å¹´3/24ï½5/7</td><td>2025å¹´6/1(æ—¥)</td><td>2025å¹´7/6(æ—¥)</td></tr>
        <tr><td>ç¬¬2å›</td><td>2025å¹´7/1ï½9/8</td><td>2025å¹´10/5(æ—¥)</td><td>2025å¹´11/9(æ—¥)</td></tr>
        <tr><td>ç¬¬3å›</td><td>2025å¹´10/31ï½12/15</td><td>2026å¹´1/25(æ—¥)</td><td>2026å¹´3/1(æ—¥)</td></tr>
      </tbody>
    </table>
  </div>
  <p><small>æœ€æ–°ã®è©³ç´°æƒ…å ±ã¯<a href="https://www.eiken.or.jp/eiken/schedule/" target="_blank">è‹±æ¤œå…¬å¼ã‚µã‚¤ãƒˆ</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</small></p>
</div>
{% endblock %}

{% block scripts %}
<!-- ãƒ¢ãƒ€ãƒ³ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
// å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
function loadPreferenceData() {
  // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  fetch('/myapp/index.cgi/api/student/preferences')
    .then(response => {
      if (!response.ok) {
        throw new Error('API response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.preferences && data.preferences.length > 0) {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è¡¨ç¤ºç”¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        addPreferenceSection(data.preferences);
      }
    })
    .catch(error => {
      console.error('Error loading preferences:', error);
    });
}

// å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addPreferenceSection(preferences) {
  try {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¾Œã«å¿—æœ›æ ¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    const calendarCard = document.querySelector('#calendar').closest('.card');
    if (!calendarCard) return;
    
    // æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
    const existingSection = document.getElementById('preference-section');
    if (existingSection) {
      existingSection.remove();
    }
    
    // æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    const preferencesSection = document.createElement('div');
    preferencesSection.id = 'preference-section';
    preferencesSection.className = 'card';
    preferencesSection.style.marginTop = '20px';
    
    // ã‚¿ã‚¤ãƒˆãƒ«
    const titleElement = document.createElement('h3');
    titleElement.textContent = 'å¿—æœ›æ ¡æƒ…å ±';
    preferencesSection.appendChild(titleElement);
    
    // å¿—æœ›æ ¡ãƒªã‚¹ãƒˆ
    const schoolList = document.createElement('div');
    schoolList.className = 'preference-list';
    
    // å„å¿—æœ›æ ¡ã®æƒ…å ±ã‚’è¡¨ç¤º
    preferences.forEach(school => {
      const schoolItem = document.createElement('div');
      schoolItem.className = 'school-item';
      schoolItem.style.padding = '10px';
      schoolItem.style.marginBottom = '10px';
      schoolItem.style.backgroundColor = '#f8f9fa';
      schoolItem.style.borderRadius = '5px';
      schoolItem.style.borderLeft = '4px solid #4285f4';
      
      // å­¦æ ¡åã¨é †ä½
      const schoolHeader = document.createElement('div');
      schoolHeader.style.fontWeight = 'bold';
      schoolHeader.style.fontSize = '1.1rem';
      schoolHeader.style.marginBottom = '5px';
      
      const orderSpan = document.createElement('span');
      orderSpan.style.backgroundColor = '#4285f4';
      orderSpan.style.color = 'white';
      orderSpan.style.borderRadius = '50%';
      orderSpan.style.width = '24px';
      orderSpan.style.height = '24px';
      orderSpan.style.display = 'inline-block';
      orderSpan.style.textAlign = 'center';
      orderSpan.style.lineHeight = '24px';
      orderSpan.style.marginRight = '8px';
      orderSpan.textContent = school.preference_order;
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = school.name;
      
      schoolHeader.appendChild(orderSpan);
      schoolHeader.appendChild(nameSpan);
      
      if (school.course_type) {
        const courseSpan = document.createElement('span');
        courseSpan.style.marginLeft = '5px';
        courseSpan.style.fontSize = '0.9rem';
        courseSpan.style.color = '#666';
        courseSpan.textContent = `(${school.course_type})`;
        schoolHeader.appendChild(courseSpan);
      }
      
      schoolItem.appendChild(schoolHeader);
      
      // å­¦æ ¡ã®è©³ç´°æƒ…å ±
      const detailsTable = document.createElement('table');
      detailsTable.style.width = '100%';
      detailsTable.style.marginTop = '5px';
      detailsTable.style.fontSize = '0.9rem';
      
      // å†…ç”³ç‚¹æƒ…å ±
      const pointRow = document.createElement('tr');
      
      const pointLabelCell = document.createElement('td');
      pointLabelCell.style.padding = '3px';
      pointLabelCell.style.width = '50%';
      pointLabelCell.textContent = 'æœ€ä½å¿…è¦å†…ç”³ç‚¹:';
      
      const pointValueCell = document.createElement('td');
      pointValueCell.style.padding = '3px';
      pointValueCell.style.fontWeight = 'bold';
      pointValueCell.textContent = school.min_required_points;
      
      pointRow.appendChild(pointLabelCell);
      pointRow.appendChild(pointValueCell);
      detailsTable.appendChild(pointRow);
      
      // å¹³å‡åˆæ ¼å†…ç”³ç‚¹æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.avg_accepted_points) {
        const avgRow = document.createElement('tr');
        
        const avgLabelCell = document.createElement('td');
        avgLabelCell.style.padding = '3px';
        avgLabelCell.textContent = 'å¹³å‡åˆæ ¼å†…ç”³ç‚¹:';
        
        const avgValueCell = document.createElement('td');
        avgValueCell.style.padding = '3px';
        avgValueCell.style.fontWeight = 'bold';
        avgValueCell.textContent = school.avg_accepted_points;
        
        avgRow.appendChild(avgLabelCell);
        avgRow.appendChild(avgValueCell);
        detailsTable.appendChild(avgRow);
      }
      
      // å€ç‡æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.competition_rate) {
        const rateRow = document.createElement('tr');
        
        const rateLabelCell = document.createElement('td');
        rateLabelCell.style.padding = '3px';
        rateLabelCell.textContent = 'å€ç‡:';
        
        const rateValueCell = document.createElement('td');
        rateValueCell.style.padding = '3px';
        rateValueCell.style.fontWeight = 'bold';
        rateValueCell.textContent = `${school.competition_rate}å€`;
        
        rateRow.appendChild(rateLabelCell);
        rateRow.appendChild(rateValueCell);
        detailsTable.appendChild(rateRow);
      }
      
      // åå·®å€¤æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.deviation_score) {
        const devRow = document.createElement('tr');
        
        const devLabelCell = document.createElement('td');
        devLabelCell.style.padding = '3px';
        devLabelCell.textContent = 'åå·®å€¤:';
        
        const devValueCell = document.createElement('td');
        devValueCell.style.padding = '3px';
        devValueCell.style.fontWeight = 'bold';
        devValueCell.textContent = school.deviation_score;
        
        devRow.appendChild(devLabelCell);
        devRow.appendChild(devValueCell);
        detailsTable.appendChild(devRow);
      }
      
      // éƒ¨æ´»å‹•æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (school.strong_club_activities) {
        const clubRow = document.createElement('tr');
        
        const clubLabelCell = document.createElement('td');
        clubLabelCell.style.padding = '3px';
        clubLabelCell.textContent = 'å¼·ã„éƒ¨æ´»:';
        
        const clubValueCell = document.createElement('td');
        clubValueCell.style.padding = '3px';
        clubValueCell.textContent = school.strong_club_activities;
        
        clubRow.appendChild(clubLabelCell);
        clubRow.appendChild(clubValueCell);
        detailsTable.appendChild(clubRow);
      }
      
      schoolItem.appendChild(detailsTable);
      
      // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
      const buttonDiv = document.createElement('div');
      buttonDiv.style.marginTop = '10px';
      buttonDiv.style.textAlign = 'right';
      
      const detailButton = document.createElement('a');
      detailButton.href = `/myapp/index.cgi/student/performance`;
      detailButton.className = 'btn btn-primary';
      detailButton.style.fontSize = '0.9rem';
      detailButton.style.padding = '4px 8px';
      detailButton.textContent = 'å†…ç”³ç‚¹ã¨æ¯”è¼ƒ';
      
      buttonDiv.appendChild(detailButton);
      schoolItem.appendChild(buttonDiv);
      
      schoolList.appendChild(schoolItem);
    });
    
    preferencesSection.appendChild(schoolList);
    
    // ãƒªãƒ³ã‚¯ã‚¨ãƒªã‚¢
    const linkDiv = document.createElement('div');
    linkDiv.style.marginTop = '10px';
    
    const profileLink = document.createElement('a');
    profileLink.href = '/myapp/index.cgi/student/profile';
    profileLink.style.fontSize = '0.9rem';
    profileLink.textContent = 'å¿—æœ›æ ¡ã®è¨­å®šãƒ»å¤‰æ›´ã¯ã“ã¡ã‚‰';
    
    linkDiv.appendChild(profileLink);
    preferencesSection.appendChild(linkDiv);
    
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
    calendarCard.parentNode.insertBefore(preferencesSection, calendarCard.nextSibling);
  } catch (error) {
    console.error('Error displaying preferences:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  loadPreferenceData();
  
  // ãƒ‡ãƒã‚¤ã‚¹æ€§èƒ½ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
  const isMobile = window.innerWidth <= 768;
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  function setupAnimations() {
    // è»½é‡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®è¨­å®š
    const lightAnimationDuration = isMobile ? '0.3s' : '0.5s';
    const staggerDelay = isMobile ? 50 : 100;
    const reducedAnimations = isMobile || prefersReducedMotion;
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      if (reducedAnimations && index > 3) {
        // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸Šéƒ¨ã®é‡è¦ãªè¦ç´ ã®ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        card.style.opacity = '1';
        return;
      }
      
      card.style.opacity = '0';
      card.style.transform = 'translateY(10px)';
      card.style.transition = `opacity ${lightAnimationDuration} ease, transform ${lightAnimationDuration} ease`;
      
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, staggerDelay * index);
    });
    
    // ãŠçŸ¥ã‚‰ã›é …ç›®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const notificationItems = document.querySelectorAll('.notification-item');
    notificationItems.forEach((item, index) => {
      if (reducedAnimations && index > 2) {
        item.style.opacity = '1';
        return;
      }
      
      item.style.opacity = '0';
      item.style.transform = isMobile ? 'translateY(5px)' : 'translateX(-10px)';
      item.style.transition = `all ${lightAnimationDuration} ease`;
      
      setTimeout(() => {
        item.style.opacity = '1';
        item.style.transform = 'translateY(0)';
      }, 200 + (staggerDelay * index));
    });
  }
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  setupAnimations();
});
</script>

<!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ -->
<style>
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  .table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* ã‚¹ãƒãƒ›å‘ã‘ã®ãƒ†ãƒ¼ãƒ–ãƒ«èª¿æ•´ */
  @media screen and (max-width: 768px) {
    .data-table {
      min-width: 500px; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ãªã»ã©ååˆ†ãªå¹…ã‚’ç¢ºä¿ */
    }
    
    .data-table th,
    .data-table td {
      padding: 5px;
      font-size: 0.9em;
    }
  }
</style>
{% endblock %}