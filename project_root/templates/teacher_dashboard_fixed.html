{% extends "base.html" %}
{% block title %}è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | å¡¾è¬›å¸«ã‚µã‚¤ãƒˆ{% endblock %}

{% block head %}
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
  
  <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
    <h2 style="color: #333; margin-bottom: 10px; font-size: 24px;">è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <p>ã“ã‚“ã«ã¡ã¯ã€{{ name }}å…ˆç”Ÿã€‚ä»Šæ—¥ã‚‚ç”Ÿå¾’ãŸã¡ã®æˆé•·ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã—ã‚‡ã†ã€‚</p>
  </div>

  <!-- çµ±è¨ˆæ¦‚è¦ -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ç™»éŒ²ç”Ÿå¾’æ•°</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">{{ student_count or 0 }}</div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ä»Šæœˆã®æ¨¡è©¦</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">2</div>
      <small>æ¬¡å›ï¼š5/20</small>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">å‡ºå¸­ç‡</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">94%</div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">æ–°è¦ç™»éŒ²</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">3</div>
      <small>ä»Šæœˆ</small>
    </div>
  </div>

  <!-- ä¸»ãªæ©Ÿèƒ½ -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
    <a href="/myapp/index.cgi/teacher/points" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-coins"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">ãƒã‚¤ãƒ³ãƒˆç®¡ç†</div>
      <div style="font-size: 12px; color: #666;">ç”Ÿå¾’ã®ãƒã‚¤ãƒ³ãƒˆã‚’ç®¡ç†</div>
    </a>

    <a href="/myapp/index.cgi/admin/fetch-high-schools" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-school"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">é«˜æ ¡æƒ…å ±</div>
      <div style="font-size: 12px; color: #666;">é«˜æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</div>
    </a>

    <a href="/myapp/index.cgi/student/eiken-words" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-language"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">è‹±æ¤œå˜èª</div>
      <div style="font-size: 12px; color: #666;">è‹±æ¤œå˜èªå­¦ç¿’</div>
    </a>

    <a href="/myapp/index.cgi/admin/import-eiken-words" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-file-import"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">è‹±æ¤œå˜èªã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      <div style="font-size: 12px; color: #666;">å˜èªãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    </a>

    <a href="/myapp/index.cgi/hope-room" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-chalkboard-teacher"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">HOPE ROOM</div>
      <div style="font-size: 12px; color: #666;">æˆæ¥­ç®¡ç†</div>
    </a>

    <a href="/myapp/index.cgi/myetr" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-laptop"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">eãƒˆãƒ¬</div>
      <div style="font-size: 12px; color: #666;">å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </div>
    </a>
  </div>

  <!-- ç”Ÿå¾’ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6;">
      <h3 style="font-size: 20px; color: #333; margin: 0;">ç”Ÿå¾’ä¸€è¦§ãƒ»å‡ºå¸­ç®¡ç†</h3>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button onclick="refreshStudentData()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
          <span>ğŸ”„</span>
          <span>æ›´æ–°</span>
        </button>
        <input type="text" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px;" placeholder="ç”Ÿå¾’åã§æ¤œç´¢" id="student-search">
      </div>
    </div>

    <!-- å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="grade-filter active" data-grade="all" style="padding: 8px 16px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å…¨å­¦å¹´</button>
        <button class="grade-filter" data-grade="elementary" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">å°å­¦ç”Ÿ</button>
        <button class="grade-filter" data-grade="middle" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">ä¸­å­¦ç”Ÿ</button>
        <button class="grade-filter" data-grade="high" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">é«˜æ ¡ç”Ÿ</button>
      </div>
      
      <!-- å‡ºå¸­ç®¡ç†ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="markAllPresent()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å…¨å“¡å‡ºå¸­</button>
        <button onclick="markAllAbsent()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å…¨å“¡æ¬ å¸­</button>
        <button onclick="saveAttendance()" style="padding: 8px 16px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å‡ºå¸­ã‚’ä¿å­˜</button>
      </div>
    </div>

    <!-- ç”Ÿå¾’ã‚«ãƒ¼ãƒ‰ -->
    <div id="student-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loading-indicator" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 18px; margin-bottom: 10px; animation: spin 1s linear infinite;">âŒ›</div>
        <div>ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let attendanceData = {};
let allStudents = [];
let currentFilter = 'all';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  loadStudentsFromDatabase();
  
  // åˆæœŸåŒ–
  initGradeFilter();
  initSearch();
  
  // ã™ã¹ã¦ã®ãƒªãƒ³ã‚¯ã«ãƒ›ãƒãƒ¼åŠ¹æœã‚’è¿½åŠ 
  const links = document.querySelectorAll('a[href]');
  links.forEach(link => {
    link.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
    });
    
    link.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'none';
    });
  });
});

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadStudentsFromDatabase() {
  try {
    console.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    const response = await fetch('/myapp/index.cgi/api/teacher/students', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
    
    if (data.success && data.students) {
      allStudents = data.students;
      renderStudentCards(allStudents);
      console.log(`${allStudents.length}äººã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
    } else {
      throw new Error(data.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    showErrorMessage(error.message);
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé™çš„ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
    initializeStaticStudentData();
    renderStudentCards(allStudents);
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼šé™çš„ãªç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
function initializeStaticStudentData() {
  console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé™çš„ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
  allStudents = [
    { id: 1001, name: 'ç”°ä¸­ å¤ªéƒ', school_type: 'elementary', grade_level: 6 },
    { id: 2001, name: 'ä½è—¤ èŠ±å­', school_type: 'middle', grade_level: 3 },
    { id: 2002, name: 'éˆ´æœ¨ æ¬¡éƒ', school_type: 'middle', grade_level: 2 },
    { id: 3001, name: 'é«˜æ©‹ ç¾å’²', school_type: 'high', grade_level: 1 },
    { id: 3002, name: 'å±±ç”° å¤§è¼', school_type: 'high', grade_level: 3 },
    { id: 1002, name: 'åŠ è—¤ çµæ„›', school_type: 'elementary', grade_level: 4 }
  ];
  
  console.log(`${allStudents.length}äººã®é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ`);
}

// ç”Ÿå¾’ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
function renderStudentCards(students) {
  const studentList = document.getElementById('student-list');
  
  if (!students || students.length === 0) {
    studentList.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 18px; margin-bottom: 10px;">ğŸ‘¥</div>
        <div>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç”Ÿå¾’ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    `;
    return;
  }
  
  const cardsHtml = students.map(student => {
    const gradeDisplayMap = {
      'elementary': 'å°å­¦',
      'middle': 'ä¸­å­¦',
      'high': 'é«˜æ ¡'
    };
    
    const gradeDisplay = gradeDisplayMap[student.school_type] || student.school_type;
    const attendanceStatus = student.attendanceToday || 'æœªç¢ºèª';
    const loginStatus = student.hasLoggedInToday ? 'æœ¬æ—¥ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
    
    return `
      <div class="student-card" data-grade="${student.school_type}" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; transition: all 0.3s ease;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <div>
            <div style="font-weight: 600; margin-bottom: 5px; color: #333;">${student.name}</div>
            <div style="color: #666; font-size: 14px;">${gradeDisplay}${student.grade_level}å¹´</div>
            <div style="color: #999; font-size: 12px; margin-top: 2px;">ID: ${student.id}</div>
            <div style="color: #999; font-size: 11px; margin-top: 2px;">${loginStatus}</div>
          </div>
          <div class="attendance-status" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #e9ecef; color: #666;">${attendanceStatus}</div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px;">
          <button onclick="markAttendance(${student.id}, 'present', this)" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #28a745; color: white; border: none; cursor: pointer;">å‡ºå¸­</button>
          <button onclick="markAttendance(${student.id}, 'absent', this)" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #dc3545; color: white; border: none; cursor: pointer;">æ¬ å¸­</button>
          <button onclick="showStudentDetail(${student.id})" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #6c757d; color: white; border: none; cursor: pointer;">è©³ç´°</button>
        </div>
      </div>
    `;
  }).join('');
  
  studentList.innerHTML = cardsHtml;
}

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showErrorMessage(message) {
  const studentList = document.getElementById('student-list');
  studentList.innerHTML = `
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
      <div style="font-size: 18px; margin-bottom: 10px;">âš ï¸</div>
      <div style="font-weight: 600; margin-bottom: 10px;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
      <div style="font-size: 14px; margin-bottom: 15px; color: #721c24;">${message}</div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="loadStudentsFromDatabase()" style="padding: 8px 16px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer;">å†è©¦è¡Œ</button>
        <button onclick="initializeStaticStudentData(); renderStudentCards(allStudents);" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨</button>
      </div>
    </div>
  `;
}

// å€‹åˆ¥ã®å‡ºå¸­ãƒãƒ¼ã‚¯
function markAttendance(studentId, status, button) {
  attendanceData[studentId] = status;
  
  // ãƒœã‚¿ãƒ³ã®ã‚ã‚‹ç”Ÿå¾’ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
  const studentCard = button.closest('.student-card');
  const statusDisplay = studentCard.querySelector('.attendance-status');
  
  // çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
  if (status === 'present') {
    statusDisplay.textContent = 'å‡ºå¸­';
    statusDisplay.style.background = '#d4edda';
    statusDisplay.style.color = '#155724';
    studentCard.style.borderColor = '#28a745';
  } else {
    statusDisplay.textContent = 'æ¬ å¸­';
    statusDisplay.style.background = '#f8d7da';
    statusDisplay.style.color = '#721c24';
    studentCard.style.borderColor = '#dc3545';
  }
  
  console.log(`ç”Ÿå¾’ID ${studentId} ã®å‡ºå¸­çŠ¶æ³: ${status}`);
}

// å…¨å“¡å‡ºå¸­
function markAllPresent() {
  // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”Ÿå¾’ã®ä¸­ã‹ã‚‰IDã‚’å–å¾—
  const filteredStudents = getCurrentlyDisplayedStudents();
  
  filteredStudents.forEach(student => {
    markAttendanceById(student.id, 'present');
  });
  
  alert(`è¡¨ç¤ºä¸­ã®ç”Ÿå¾’${filteredStudents.length}äººã‚’å‡ºå¸­ã«ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ`);
}

// å…¨å“¡æ¬ å¸­
function markAllAbsent() {
  // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”Ÿå¾’ã®ä¸­ã‹ã‚‰IDã‚’å–å¾—
  const filteredStudents = getCurrentlyDisplayedStudents();
  
  filteredStudents.forEach(student => {
    markAttendanceById(student.id, 'absent');
  });
  
  alert(`è¡¨ç¤ºä¸­ã®ç”Ÿå¾’${filteredStudents.length}äººã‚’æ¬ å¸­ã«ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ`);
}

// ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”Ÿå¾’ã‚’å–å¾—
function getCurrentlyDisplayedStudents() {
  const searchInput = document.getElementById('student-search');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  return allStudents.filter(student => {
    const matchesSearch = !searchTerm || student.name.toLowerCase().includes(searchTerm);
    const matchesGrade = currentFilter === 'all' || student.school_type === currentFilter;
    
    return matchesSearch && matchesGrade;
  });
}

// IDã§å‡ºå¸­ã‚’ãƒãƒ¼ã‚¯ï¼ˆUIæ›´æ–°ã‚‚å«ã‚€ï¼‰
function markAttendanceById(studentId, status) {
  attendanceData[studentId] = status;
  
  // å¯¾å¿œã™ã‚‹ç”Ÿå¾’ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦UIæ›´æ–°
  const studentCards = document.querySelectorAll('.student-card');
  studentCards.forEach(card => {
    const button = card.querySelector(`button[onclick*="markAttendance(${studentId}"]`);
    if (button) {
      const statusDisplay = card.querySelector('.attendance-status');
      
      if (status === 'present') {
        statusDisplay.textContent = 'å‡ºå¸­';
        statusDisplay.style.background = '#d4edda';
        statusDisplay.style.color = '#155724';
        card.style.borderColor = '#28a745';
      } else {
        statusDisplay.textContent = 'æ¬ å¸­';
        statusDisplay.style.background = '#f8d7da';
        statusDisplay.style.color = '#721c24';
        card.style.borderColor = '#dc3545';
      }
    }
  });
}

// å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
async function saveAttendance() {
  console.log('ä¿å­˜ã™ã‚‹å‡ºå¸­ãƒ‡ãƒ¼ã‚¿:', attendanceData);
  
  if (Object.keys(attendanceData).length === 0) {
    alert('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«å‡ºå¸­çŠ¶æ³ã‚’ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  try {
    const response = await fetch('/myapp/index.cgi/api/teacher/attendance', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        attendance: attendanceData,
        date: new Date().toISOString().split('T')[0]
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(`å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${Object.keys(attendanceData).length}äººåˆ†`);
      attendanceData = {}; // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    } else {
      alert(`ã‚¨ãƒ©ãƒ¼: ${result.message}`);
    }
    
  } catch (error) {
    console.error('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    alert('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ç”Ÿå¾’è©³ç´°è¡¨ç¤º
function showStudentDetail(studentId) {
  window.location.href = `/myapp/index.cgi/teacher/student/${studentId}`;
}

// å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
function initGradeFilter() {
  const filterButtons = document.querySelectorAll('.grade-filter');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#333';
        btn.style.border = '1px solid #dee2e6';
      });
      
      this.classList.add('active');
      this.style.background = '#4361ee';
      this.style.color = 'white';
      this.style.border = 'none';
      
      currentFilter = this.getAttribute('data-grade');
      applyFilters();
      
      console.log('ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨:', currentFilter);
    });
  });
}

// æ¤œç´¢æ©Ÿèƒ½
function initSearch() {
  const searchInput = document.getElementById('student-search');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      applyFilters();
    });
  }
}

// ãƒ•ã‚£ãƒ«ã‚¿ã¨æ¤œç´¢ã‚’é©ç”¨
function applyFilters() {
  const searchInput = document.getElementById('student-search');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  // å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filteredStudents = allStudents.filter(student => {
    const matchesSearch = !searchTerm || student.name.toLowerCase().includes(searchTerm);
    const matchesGrade = currentFilter === 'all' || student.school_type === currentFilter;
    
    return matchesSearch && matchesGrade;
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸç”Ÿå¾’ã§ã‚«ãƒ¼ãƒ‰ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  renderStudentCards(filteredStudents);
  
  console.log(`ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨: ${filteredStudents.length}äººã®ç”Ÿå¾’ã‚’è¡¨ç¤º`);
}

// ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿æ©Ÿèƒ½
async function refreshStudentData() {
  const studentList = document.getElementById('student-list');
  studentList.innerHTML = `
    <div id="loading-indicator" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
      <div style="font-size: 18px; margin-bottom: 10px; animation: spin 1s linear infinite;">ğŸ”„</div>
      <div>ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...</div>
    </div>
  `;
  
  await loadStudentsFromDatabase();
}
</script>
{% endblock %}
