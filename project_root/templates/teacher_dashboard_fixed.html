{% extends "base.html" %}
{% block title %}講師ダッシュボード | 塾講師サイト{% endblock %}

{% block head %}
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
  
  <!-- ダッシュボードヘッダー -->
  <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
    <h2 style="color: #333; margin-bottom: 10px; font-size: 24px;">講師ダッシュボード</h2>
    <p>こんにちは、{{ name }}先生。今日も生徒たちの成長をサポートしましょう。</p>
  </div>

  <!-- 統計概要 -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">登録生徒数</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">{{ student_count or 0 }}</div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">今月の模試</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">2</div>
      <small>次回：5/20</small>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">出席率</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">94%</div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="color: #666; font-size: 14px; margin-bottom: 5px;">新規登録</div>
      <div style="font-size: 32px; font-weight: bold; color: #333;">3</div>
      <small>今月</small>
    </div>
  </div>

  <!-- 主な機能 -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
    <a href="/myapp/index.cgi/teacher/points" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-coins"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">ポイント管理</div>
      <div style="font-size: 12px; color: #666;">生徒のポイントを管理</div>
    </a>

    <a href="/myapp/index.cgi/admin/fetch-high-schools" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-school"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">高校情報</div>
      <div style="font-size: 12px; color: #666;">高校データを取得</div>
    </a>

    <a href="/myapp/index.cgi/student/eiken-words" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-language"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">英検単語</div>
      <div style="font-size: 12px; color: #666;">英検単語学習</div>
    </a>

    <a href="/myapp/index.cgi/admin/import-eiken-words" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-file-import"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">英検単語インポート</div>
      <div style="font-size: 12px; color: #666;">単語データ管理</div>
    </a>

    <a href="/myapp/index.cgi/hope-room" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-chalkboard-teacher"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">HOPE ROOM</div>
      <div style="font-size: 12px; color: #666;">授業管理</div>
    </a>

    <a href="/myapp/index.cgi/myetr" style="display: block; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-decoration: none; color: #333; text-align: center; transition: all 0.3s ease;">
      <div style="font-size: 32px; color: #4361ee; margin-bottom: 10px;">
        <i class="fas fa-laptop"></i>
      </div>
      <div style="font-weight: 600; margin-bottom: 5px;">eトレ</div>
      <div style="font-size: 12px; color: #666;">学習システム</div>
    </a>
  </div>

  <!-- 生徒一覧セクション -->
  <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6;">
      <h3 style="font-size: 20px; color: #333; margin: 0;">生徒一覧・出席管理</h3>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button onclick="refreshStudentData()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
          <span>🔄</span>
          <span>更新</span>
        </button>
        <input type="text" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px;" placeholder="生徒名で検索" id="student-search">
      </div>
    </div>

    <!-- 学年フィルタ -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="grade-filter active" data-grade="all" style="padding: 8px 16px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">全学年</button>
        <button class="grade-filter" data-grade="elementary" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">小学生</button>
        <button class="grade-filter" data-grade="middle" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">中学生</button>
        <button class="grade-filter" data-grade="high" style="padding: 8px 16px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px;">高校生</button>
      </div>
      
      <!-- 出席管理ボタン -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="markAllPresent()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">全員出席</button>
        <button onclick="markAllAbsent()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">全員欠席</button>
        <button onclick="saveAttendance()" style="padding: 8px 16px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">出席を保存</button>
      </div>
    </div>

    <!-- 生徒カード -->
    <div id="student-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
      <!-- ローディング表示 -->
      <div id="loading-indicator" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 18px; margin-bottom: 10px; animation: spin 1s linear infinite;">⌛</div>
        <div>生徒データを読み込み中...</div>
      </div>
    </div>
  </div>
</div>

<script>
// グローバル変数
let attendanceData = {};
let allStudents = [];
let currentFilter = 'all';

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
  console.log('講師ダッシュボードが読み込まれました');
  
  // データベースから生徒データを読み込み
  loadStudentsFromDatabase();
  
  // 初期化
  initGradeFilter();
  initSearch();
  
  // すべてのリンクにホバー効果を追加
  const links = document.querySelectorAll('a[href]');
  links.forEach(link => {
    link.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
    });
    
    link.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'none';
    });
  });
});

// データベースから生徒データを読み込む関数
async function loadStudentsFromDatabase() {
  try {
    console.log('データベースから生徒データを読み込み中...');
    
    const response = await fetch('/myapp/index.cgi/api/teacher/students', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('取得したデータ:', data);
    
    if (data.success && data.students) {
      allStudents = data.students;
      renderStudentCards(allStudents);
      console.log(`${allStudents.length}人の生徒データを読み込みました`);
      
      // ローディング表示を削除
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
    } else {
      throw new Error(data.message || 'データの取得に失敗しました');
    }
    
  } catch (error) {
    console.error('生徒データの読み込みエラー:', error);
    showErrorMessage(error.message);
    
    // フォールバック：静的データを使用
    console.log('フォールバックとして静的データを使用します');
    initializeStaticStudentData();
    renderStudentCards(allStudents);
  }
}

// フォールバック用：静的な生徒データを初期化する関数
function initializeStaticStudentData() {
  console.log('フォールバック：静的データを使用します');
  allStudents = [
    { id: 1001, name: '田中 太郎', school_type: 'elementary', grade_level: 6 },
    { id: 2001, name: '佐藤 花子', school_type: 'middle', grade_level: 3 },
    { id: 2002, name: '鈴木 次郎', school_type: 'middle', grade_level: 2 },
    { id: 3001, name: '高橋 美咲', school_type: 'high', grade_level: 1 },
    { id: 3002, name: '山田 大輝', school_type: 'high', grade_level: 3 },
    { id: 1002, name: '加藤 結愛', school_type: 'elementary', grade_level: 4 }
  ];
  
  console.log(`${allStudents.length}人の静的データを初期化しました`);
}

// 生徒カードをレンダリングする関数
function renderStudentCards(students) {
  const studentList = document.getElementById('student-list');
  
  if (!students || students.length === 0) {
    studentList.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 18px; margin-bottom: 10px;">👥</div>
        <div>登録されている生徒がありません</div>
      </div>
    `;
    return;
  }
  
  const cardsHtml = students.map(student => {
    const gradeDisplayMap = {
      'elementary': '小学',
      'middle': '中学',
      'high': '高校'
    };
    
    const gradeDisplay = gradeDisplayMap[student.school_type] || student.school_type;
    const attendanceStatus = student.attendanceToday || '未確認';
    const loginStatus = student.hasLoggedInToday ? '本日ログイン済み' : '未ログイン';
    
    return `
      <div class="student-card" data-grade="${student.school_type}" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; transition: all 0.3s ease;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <div>
            <div style="font-weight: 600; margin-bottom: 5px; color: #333;">${student.name}</div>
            <div style="color: #666; font-size: 14px;">${gradeDisplay}${student.grade_level}年</div>
            <div style="color: #999; font-size: 12px; margin-top: 2px;">ID: ${student.id}</div>
            <div style="color: #999; font-size: 11px; margin-top: 2px;">${loginStatus}</div>
          </div>
          <div class="attendance-status" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #e9ecef; color: #666;">${attendanceStatus}</div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px;">
          <button onclick="markAttendance(${student.id}, 'present', this)" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #28a745; color: white; border: none; cursor: pointer;">出席</button>
          <button onclick="markAttendance(${student.id}, 'absent', this)" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #dc3545; color: white; border: none; cursor: pointer;">欠席</button>
          <button onclick="showStudentDetail(${student.id})" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #6c757d; color: white; border: none; cursor: pointer;">詳細</button>
        </div>
      </div>
    `;
  }).join('');
  
  studentList.innerHTML = cardsHtml;
}

// エラーメッセージを表示する関数
function showErrorMessage(message) {
  const studentList = document.getElementById('student-list');
  studentList.innerHTML = `
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
      <div style="font-size: 18px; margin-bottom: 10px;">⚠️</div>
      <div style="font-weight: 600; margin-bottom: 10px;">データの読み込みに失敗しました</div>
      <div style="font-size: 14px; margin-bottom: 15px; color: #721c24;">${message}</div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="loadStudentsFromDatabase()" style="padding: 8px 16px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer;">再試行</button>
        <button onclick="initializeStaticStudentData(); renderStudentCards(allStudents);" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">デモデータを使用</button>
      </div>
    </div>
  `;
}

// 個別の出席マーク
function markAttendance(studentId, status, button) {
  attendanceData[studentId] = status;
  
  // ボタンのある生徒カードを取得
  const studentCard = button.closest('.student-card');
  const statusDisplay = studentCard.querySelector('.attendance-status');
  
  // 状態表示を更新
  if (status === 'present') {
    statusDisplay.textContent = '出席';
    statusDisplay.style.background = '#d4edda';
    statusDisplay.style.color = '#155724';
    studentCard.style.borderColor = '#28a745';
  } else {
    statusDisplay.textContent = '欠席';
    statusDisplay.style.background = '#f8d7da';
    statusDisplay.style.color = '#721c24';
    studentCard.style.borderColor = '#dc3545';
  }
  
  console.log(`生徒ID ${studentId} の出席状況: ${status}`);
}

// 全員出席
function markAllPresent() {
  // 現在表示されている生徒の中からIDを取得
  const filteredStudents = getCurrentlyDisplayedStudents();
  
  filteredStudents.forEach(student => {
    markAttendanceById(student.id, 'present');
  });
  
  alert(`表示中の生徒${filteredStudents.length}人を出席にマークしました`);
}

// 全員欠席
function markAllAbsent() {
  // 現在表示されている生徒の中からIDを取得
  const filteredStudents = getCurrentlyDisplayedStudents();
  
  filteredStudents.forEach(student => {
    markAttendanceById(student.id, 'absent');
  });
  
  alert(`表示中の生徒${filteredStudents.length}人を欠席にマークしました`);
}

// 現在表示されている生徒を取得
function getCurrentlyDisplayedStudents() {
  const searchInput = document.getElementById('student-search');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  return allStudents.filter(student => {
    const matchesSearch = !searchTerm || student.name.toLowerCase().includes(searchTerm);
    const matchesGrade = currentFilter === 'all' || student.school_type === currentFilter;
    
    return matchesSearch && matchesGrade;
  });
}

// IDで出席をマーク（UI更新も含む）
function markAttendanceById(studentId, status) {
  attendanceData[studentId] = status;
  
  // 対応する生徒カードを見つけてUI更新
  const studentCards = document.querySelectorAll('.student-card');
  studentCards.forEach(card => {
    const button = card.querySelector(`button[onclick*="markAttendance(${studentId}"]`);
    if (button) {
      const statusDisplay = card.querySelector('.attendance-status');
      
      if (status === 'present') {
        statusDisplay.textContent = '出席';
        statusDisplay.style.background = '#d4edda';
        statusDisplay.style.color = '#155724';
        card.style.borderColor = '#28a745';
      } else {
        statusDisplay.textContent = '欠席';
        statusDisplay.style.background = '#f8d7da';
        statusDisplay.style.color = '#721c24';
        card.style.borderColor = '#dc3545';
      }
    }
  });
}

// 出席データを保存
async function saveAttendance() {
  console.log('保存する出席データ:', attendanceData);
  
  if (Object.keys(attendanceData).length === 0) {
    alert('出席データがありません。先に出席状況をマークしてください。');
    return;
  }
  
  try {
    const response = await fetch('/myapp/index.cgi/api/teacher/attendance', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        attendance: attendanceData,
        date: new Date().toISOString().split('T')[0]
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(`出席データを保存しました: ${Object.keys(attendanceData).length}人分`);
      attendanceData = {}; // データをクリア
    } else {
      alert(`エラー: ${result.message}`);
    }
    
  } catch (error) {
    console.error('出席データ保存エラー:', error);
    alert('出席データの保存に失敗しました');
  }
}

// 生徒詳細表示
function showStudentDetail(studentId) {
  window.location.href = `/myapp/index.cgi/teacher/student/${studentId}`;
}

// 学年フィルタ機能
function initGradeFilter() {
  const filterButtons = document.querySelectorAll('.grade-filter');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      // アクティブ状態の切り替え
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#333';
        btn.style.border = '1px solid #dee2e6';
      });
      
      this.classList.add('active');
      this.style.background = '#4361ee';
      this.style.color = 'white';
      this.style.border = 'none';
      
      currentFilter = this.getAttribute('data-grade');
      applyFilters();
      
      console.log('フィルタ適用:', currentFilter);
    });
  });
}

// 検索機能
function initSearch() {
  const searchInput = document.getElementById('student-search');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      applyFilters();
    });
  }
}

// フィルタと検索を適用
function applyFilters() {
  const searchInput = document.getElementById('student-search');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  // 動的に読み込まれたデータに基づいてフィルタリング
  let filteredStudents = allStudents.filter(student => {
    const matchesSearch = !searchTerm || student.name.toLowerCase().includes(searchTerm);
    const matchesGrade = currentFilter === 'all' || student.school_type === currentFilter;
    
    return matchesSearch && matchesGrade;
  });
  
  // フィルタリングされた生徒でカードを再レンダリング
  renderStudentCards(filteredStudents);
  
  console.log(`フィルタ適用: ${filteredStudents.length}人の生徒を表示`);
}

// データ再読み込み機能
async function refreshStudentData() {
  const studentList = document.getElementById('student-list');
  studentList.innerHTML = `
    <div id="loading-indicator" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
      <div style="font-size: 18px; margin-bottom: 10px; animation: spin 1s linear infinite;">🔄</div>
      <div>データを更新中...</div>
    </div>
  `;
  
  await loadStudentsFromDatabase();
}
</script>
{% endblock %}
