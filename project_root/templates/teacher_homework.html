{% extends "base.html" %}
{% block title %}å®¿é¡Œç®¡ç†ï¼ˆå°5ãƒ»å°6ï¼‰ | å¡¾è¬›å¸«ã‚µã‚¤ãƒˆ{% endblock %}

{% block content %}
<div class="homework-dashboard-wrapper">
  <div class="dashboard-header">
    <h2 class="gradient-title">
      <i class="fas fa-tasks gradient-icon"></i>
      å°å­¦5ãƒ»6å¹´ç”Ÿ å®¿é¡Œç®¡ç†
    </h2>
    <div class="header-subtitle">ç”Ÿå¾’ã®å­¦ç¿’é€²æ—ã‚’åŠ¹ç‡çš„ã«ç®¡ç†</div>
  </div>
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="modern-homework-tabs">
    <button class="modern-tab-btn active" data-tab="calendar">
      <i class="fas fa-calendar-alt"></i>
      <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
    </button>
    <button class="modern-tab-btn" data-tab="assign">
      <i class="fas fa-plus-circle"></i>
      <span>å®¿é¡Œç™»éŒ²</span>
    </button>
    <button class="modern-tab-btn" data-tab="check">
      <i class="fas fa-list-check"></i>
      <span>ãƒªã‚¹ãƒˆè¡¨ç¤º</span>
    </button>
    <button class="modern-tab-btn" data-tab="history">
      <i class="fas fa-chart-line"></i>
      <span>å±¥æ­´ç¢ºèª</span>
    </button>
  </div>
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ– -->
  <div id="calendar-tab" class="modern-tab-content active">
    <div class="content-card">
      <h4 class="section-title">
        <i class="fas fa-calendar-week"></i>
        å®¿é¡Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
      </h4>      <!-- ç”Ÿå¾’é¸æŠ -->
      <div class="modern-calendar-controls">
        <div class="control-group">
          <div class="modern-student-selector">
            <label class="control-label">
              <i class="fas fa-user-graduate"></i>
              ç”Ÿå¾’é¸æŠ
            </label>
            <select id="calendar-student-select" class="modern-form-control">
              <option value="">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <!-- å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
            </select>
          </div>
          
          <!-- æœˆåˆ‡ã‚Šæ›¿ãˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <div class="modern-month-navigation">
            <button id="prev-month-btn" class="nav-btn prev-btn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="current-month-display" class="current-month-display"></span>
            <button id="next-month-btn" class="nav-btn next-btn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="teacher-homework-calendar" class="modern-homework-calendar"></div>
    
    <!-- å®¿é¡Œè©³ç´°ãƒ»ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="homework-check-modal" class="modern-homework-modal" style="display: none;">
      <div class="modern-modal-content">
        <div class="modal-header">
          <h4 id="modal-student-date"></h4>
          <span class="close-modal">&times;</span>
        </div>
        <div id="homework-check-list" class="modal-body"></div>
      </div>
    </div>
    </div>
  </div>
    <!-- å®¿é¡Œç™»éŒ²ã‚¿ãƒ– -->
  <div id="assign-tab" class="modern-tab-content">
    <div class="content-card">
      <h4 class="section-title">
        <i class="fas fa-plus-circle"></i>
        æ–°è¦å®¿é¡Œç™»éŒ²
      </h4>
    
      <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
      <div class="modern-template-section">
        <h5 class="subsection-title">
          <i class="fas fa-history"></i>
          å±¥æ­´ã‹ã‚‰é¸æŠï¼ˆã‚ˆãä½¿ã†å®¿é¡Œï¼‰
        </h5>
        <div id="homework-templates" class="modern-template-grid">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
      <form id="homework-assign-form" class="modern-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="modern-form-row">        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-user-graduate"></i>
            ç”Ÿå¾’é¸æŠ (è¤‡æ•°é¸æŠå¯)
          </label>          <div class="modern-checkbox-container">
            <div class="select-all-container">
              <label class="modern-checkbox-label">
                <input type="checkbox" id="select-all-students" class="modern-checkbox">
                <span class="checkmark"></span>
                ã™ã¹ã¦é¸æŠ
              </label>
            </div>
            <div id="student-checkbox-container" class="students-checkbox-list">
              <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ç”Ÿå¾’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            </div>
          </div>
        </div>
        
        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-calendar"></i>
            æ—¥ä»˜
          </label>
          <input type="date" id="assignment-date" class="modern-form-control" required>
        </div>
      </div>      
      <div class="modern-form-row">
        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-book"></i>
            ç§‘ç›®
          </label>
          <select id="subject-select" class="modern-form-control" required>
            <option value="">ç§‘ç›®ã‚’é¸æŠ</option>
            <option value="å›½èª">å›½èª</option>
            <option value="ç®—æ•°">ç®—æ•°</option>
            <option value="è‹±èª">è‹±èª</option>
            <option value="ç†ç§‘">ç†ç§‘</option>
            <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
          </select>
        </div>
        
        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-book-open"></i>
            ãƒ†ã‚­ã‚¹ãƒˆå
          </label>
          <input type="text" id="textbook-input" class="modern-form-control" placeholder="ä¾‹: ç®—æ•°ãƒ‰ãƒªãƒ«5å¹´" required list="textbook-list">
          <datalist id="textbook-list">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </datalist>
        </div>
      </div>
      
      <div class="modern-form-row">
        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-list-ul"></i>
            é …ç›®ãƒ»å˜å…ƒ
          </label>
          <input type="text" id="topic-input" class="modern-form-control" placeholder="ä¾‹: åˆ†æ•°ã®è¨ˆç®—" required list="topic-list">
          <datalist id="topic-list">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </datalist>
        </div>
        
        <div class="modern-form-group">
          <label class="modern-form-label">
            <i class="fas fa-file-alt"></i>
            ãƒšãƒ¼ã‚¸æ•°
          </label>
          <input type="text" id="pages-input" class="modern-form-control" placeholder="ä¾‹: 10-15" required>
        </div>
      </div>
      
      <div class="modern-form-actions">
        <button type="submit" class="modern-btn primary">
          <i class="fas fa-plus-circle"></i> å®¿é¡Œã‚’ç™»éŒ²
        </button>
        <button type="button" id="save-template-btn" class="modern-btn secondary">
          <i class="fas fa-star"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜
        </button>
      </div>
    </form>
    </div>
  </div>
    <!-- ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¿ãƒ– -->
  <div id="check-tab" class="modern-tab-content">
    <div class="content-card">
      <h4 class="section-title">
        <i class="fas fa-list-check"></i>
        å®¿é¡Œãƒªã‚¹ãƒˆ
      </h4>
      
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div class="modern-filter-section">
        <div class="modern-form-row">
          <div class="modern-form-group">
            <label class="modern-form-label">
              <i class="fas fa-user-graduate"></i>
              ç”Ÿå¾’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            </label>
            <select id="check-student-filter" class="modern-form-control">
              <option value="">å…¨ç”Ÿå¾’</option>
              <!-- å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
            </select>
          </div>
          
          <div class="modern-form-group">
            <label class="modern-form-label">
              <i class="fas fa-calendar-alt"></i>
              æ—¥ä»˜ç¯„å›²
            </label>
            <input type="date" id="check-date-from" class="modern-form-control">
          </div>
          
          <div class="modern-form-group">
            <label class="modern-form-label">ï½</label>
            <input type="date" id="check-date-to" class="modern-form-control">
          </div>
          
          <div class="modern-form-group">
            <button id="filter-btn" class="modern-btn secondary">
              <i class="fas fa-filter"></i> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            </button>
          </div>
        </div>
      </div>
        <!-- å®¿é¡Œãƒªã‚¹ãƒˆ -->
      <div id="homework-list-container" class="modern-list-container">
        <div id="homework-check-list" class="homework-check-list">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>
    <!-- å±¥æ­´ç¢ºèªã‚¿ãƒ– -->
  <div id="history-tab" class="modern-tab-content">
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-history"></i>
        å®¿é¡Œå±¥æ­´
      </h2>
      
      <!-- çµ±è¨ˆæƒ…å ± -->
      <div class="modern-stats-grid">
        <div class="modern-stat-card">
          <div class="stat-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">ä»Šæœˆã®å®¿é¡Œç™»éŒ²æ•°</div>
            <div class="stat-value" id="monthly-assignments">0</div>
          </div>
        </div>
        <div class="modern-stat-card">
          <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">ä»Šæœˆã®å®Œäº†ç‡</div>
            <div class="stat-value" id="completion-rate">0%</div>
          </div>
        </div>
        <div class="modern-stat-card">
          <div class="stat-icon">
            <i class="fas fa-trophy"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆåˆè¨ˆ</div>
            <div class="stat-value" id="total-points">0</div>
          </div>
        </div>
      </div>
      
      <!-- å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="modern-history-section">
        <h3 class="subsection-title">
          <i class="fas fa-table"></i>
          è©³ç´°å±¥æ­´
        </h3>
        <div class="modern-table-container">
          <table class="modern-data-table">            <thead>
              <tr>
                <th><i class="fas fa-calendar-alt"></i> æ—¥ä»˜</th>
                <th><i class="fas fa-user-graduate"></i> ç”Ÿå¾’å</th>
                <th><i class="fas fa-book"></i> ç§‘ç›®</th>
                <th><i class="fas fa-book-open"></i> ãƒ†ã‚­ã‚¹ãƒˆ</th>
                <th><i class="fas fa-list"></i> é …ç›®</th>
                <th><i class="fas fa-file-alt"></i> ãƒšãƒ¼ã‚¸</th>
                <th><i class="fas fa-check-circle"></i> çŠ¶æ…‹</th>
                <th><i class="fas fa-star"></i> ãƒã‚¤ãƒ³ãƒˆ</th>
                <th><i class="fas fa-cogs"></i> æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="history-tbody">
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>

<style>
  /* CSS Variables for Modern Design */
  :root {
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    --gradient-info: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 15px 40px rgba(0, 0, 0, 0.15);
    --shadow-strong: 0 20px 50px rgba(0, 0, 0, 0.2);
    --border-radius: 20px;
    --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --backdrop-blur: blur(10px);
  }

  /* Modern Homework Dashboard Wrapper */
  .homework-dashboard-wrapper {
    background: var(--gradient-primary);
    min-height: calc(100vh - 120px);
    padding: 30px;
    border-radius: var(--border-radius);
    margin: 20px;
    position: relative;
    overflow: hidden;
  }

  .homework-dashboard-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
  }

  /* Dashboard Header */
  .dashboard-header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
    z-index: 2;
  }

  .gradient-title {
    background: linear-gradient(45deg, #fff, #f0f8ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .gradient-icon {
    margin-right: 15px;
    font-size: 2.2rem;
  }

  .header-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.1rem;
    font-weight: 300;
    margin-top: 10px;
  }

  /* Modern Tab Navigation */
  .modern-homework-tabs {
    display: flex;
    gap: 15px;
    margin-bottom: 40px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    z-index: 2;
  }

  .modern-tab-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 15px 25px;
    border: none;
    background: transparent;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-smooth);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
    font-size: 0.95rem;
  }

  .modern-tab-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: var(--transition-smooth);
  }

  .modern-tab-btn:hover::before {
    opacity: 1;
  }

  .modern-tab-btn:hover {
    color: #fff;
    transform: translateY(-2px);
  }

  .modern-tab-btn.active {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
  }

  .modern-tab-btn.active::before {
    opacity: 1;
  }

  .modern-tab-btn i {
    font-size: 1.1rem;
  }

  /* Modern Tab Content */
  .modern-tab-content {
    display: none;
    position: relative;
    z-index: 2;
  }

  .modern-tab-content.active {
    display: block;
    animation: fadeInUp 0.5s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Content Cards */
  .content-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    padding: 30px;
    box-shadow: var(--shadow-medium);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid rgba(255, 255, 255, 0.3);
    margin-bottom: 30px;
  }

  .section-title {
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .subsection-title {
    color: #555;
    font-size: 1.2rem;
    font-weight: 500;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Modern Calendar Controls */
  .modern-calendar-controls {
    margin-bottom: 30px;
  }

  .control-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .modern-student-selector {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .control-label {
    color: #555;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
  }

  .modern-form-control {
    padding: 12px 16px;
    border: 2px solid #e0e6ed;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: var(--transition-smooth);
    background: #fff;
    min-width: 200px;
  }

  .modern-form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  /* Modern Month Navigation */
  .modern-month-navigation {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .nav-btn {
    width: 45px;
    height: 45px;
    border: none;
    border-radius: 50%;
    background: var(--gradient-primary);
    color: #fff;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    box-shadow: var(--shadow-soft);
  }

  .nav-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-medium);
  }
  .current-month-display {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
    min-width: 150px;
    text-align: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding: 5px 10px;
    border-radius: 8px;
  }
  /* Modern Calendar */
  .modern-homework-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-soft);
    overflow: hidden;
  }

  .calendar-header {
    font-weight: 600;
    text-align: center;
    padding: 12px 8px;
    background: var(--gradient-primary);
    color: #fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 40px;
  }

  .calendar-day {
    border: 1px solid #e8eaed;
    min-height: 100px;
    padding: 8px 6px;
    background: #fff;
    cursor: pointer;
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .calendar-day:hover {
    border-color: #667eea;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    z-index: 1;
  }

  .calendar-day.today {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
    font-weight: 600;
  }

  .calendar-day.empty {
    background: transparent;
    cursor: default;
    border: none;
  }

  .calendar-day.empty:hover {
    transform: none;
    box-shadow: none;
  }

  .date-number {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: #374151;
  }

  .homework-indicators {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .homework-indicator {
    background: #f3f4f6;
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 0.7rem;
    border-left: 3px solid #9ca3af;
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .homework-indicator.completed {
    background: #d1fae5;
    border-left-color: #10b981;
    color: #065f46;
  }

  .homework-indicator.pending {
    background: #fef3c7;
    border-left-color: #f59e0b;
    color: #92400e;
  }

  .homework-indicator i {
    font-size: 0.6rem;
  }

  .homework-indicator span {
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Modern Template Section */
  .modern-template-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid #e0e6ed;
  }

  .modern-template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    max-height: 250px;
    overflow-y: auto;
  }

  .template-item {
    background: #fff;
    border: 2px solid #e0e6ed;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
  }

  .template-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: var(--transition-smooth);
  }

  .template-item:hover {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
  }

  .template-item:hover::before {
    transform: scaleX(1);
  }

  /* Modern Form */
  .modern-form {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: var(--shadow-soft);
  }

  .modern-form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    flex-wrap: wrap;
  }

  .modern-form-group {
    flex: 1;
    min-width: 250px;
  }
  .modern-form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    color: #555;
    font-weight: 500;
    font-size: 0.95rem;
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .modern-checkbox-container {
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    background: #fff;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
  }

  .select-all-container {
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
    margin-bottom: 10px;
  }

  .students-checkbox-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .modern-checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    font-size: 0.9rem;
  }

  .modern-checkbox-label:hover {
    background: rgba(64, 123, 255, 0.05);
  }

  .modern-checkbox {
    width: 18px;
    height: 18px;
    border: 2px solid #ddd;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    position: relative;
    appearance: none;
    -webkit-appearance: none;
    transition: all 0.2s ease;
  }

  .modern-checkbox:checked {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }

  .modern-checkbox:checked::after {
    content: 'âœ“';
    position: absolute;
    color: white;
    font-size: 12px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .checkmark {
    display: none;
  }

  /* Modern Modal */
  .modern-homework-modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: var(--backdrop-blur);
  }

  .modern-modal-content {
    background: #fff;
    border-radius: var(--border-radius);
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: var(--shadow-strong);
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .modal-header {
    background: var(--gradient-primary);
    color: #fff;
    padding: 25px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h4 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
  }

  .close-modal {
    font-size: 24px;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.8);
    transition: var(--transition-smooth);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  .close-modal:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }

  .modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
  }
  /* Legacy styles for compatibility */
  .homework-tabs {
    display: none; /* Hide old tabs */
  }
  
  .tab-btn {
    display: none; /* Hide old tab buttons */
  }
  
  .tab-content {
    display: none;
    padding: 20px 0;
  }
  
  .tab-content.active {
    display: block;
  }

  /* Modern Button Styles */
  .modern-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }

  .modern-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
  }

  .modern-btn:hover::before {
    left: 100%;
  }

  .modern-btn-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-soft);
  }

  .modern-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  .modern-btn-success {
    background: var(--gradient-success);
    color: white;
  }

  .modern-btn-warning {
    background: var(--gradient-warning);
    color: #333;
  }

  .modern-btn-danger {
    background: var(--gradient-secondary);
    color: white;
  }

  .modern-btn-outline {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
  }

  .modern-btn-outline:hover {
    background: #667eea;
    color: white;
  }

  /* Modern Stats Grid */
  .modern-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
  }

  .modern-stat-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: var(--shadow-soft);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: var(--transition-smooth);
  }

  .modern-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-medium);
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    background: var(--gradient-primary);
    flex-shrink: 0;
  }

  .stat-content {
    flex: 1;
  }

  .stat-content .stat-label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .stat-content .stat-value {
    font-size: 2rem;
    font-weight: 700;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Modern History Section */
  .modern-history-section {
    margin-top: 40px;
  }

  /* Modern Table Container */
  .modern-table-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .modern-data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
  }

  .modern-data-table th {
    background: var(--gradient-primary);
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .modern-data-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }

  .modern-data-table tr:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .modern-data-table tr.completed-row {
    background: rgba(76, 175, 80, 0.05);
  }

  .modern-data-table tr.pending-row {
    background: rgba(255, 152, 0, 0.05);
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .status-badge.completed {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .status-badge.pending {
    background: #fff3e0;
    color: #ef6c00;
  }

  /* å±¥æ­´è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .modern-data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
  }

  .modern-data-table th {
    background: var(--gradient-primary);
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .modern-data-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }

  .modern-data-table tr:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .modern-data-table tr.completed-row {
    background: rgba(76, 175, 80, 0.05);
  }

  .modern-data-table tr.pending-row {
    background: rgba(255, 152, 0, 0.05);
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .status-badge.completed {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .status-badge.pending {
    background: #fff3e0;
    color: #ef6c00;
  }

  .modern-table-container {
    border-radius: var(--border-radius);
    overflow: hidden;
    max-height: 500px;
    overflow-y: auto;
  }
</style>

<script>
// ã‚»ã‚­ãƒ¥ã‚¢ãªfetché–¢æ•°
async function secureFetch(url, options = {}) {
  const defaultOptions = {
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    }
  };
  
  return fetch(url, { ...defaultOptions, ...options });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedStudentId = null;

// API URL ã‚’ç’°å¢ƒã«å¿œã˜ã¦åˆ¤å®šã™ã‚‹é–¢æ•°
function getApiUrl(endpoint) {
  // CGIç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
  const isCGI = window.location.pathname.includes('index.cgi') || 
                window.location.href.includes('/myapp/');
  
  return isCGI ? `/myapp/index.cgi${endpoint}` : endpoint;
}

// å°å­¦5å¹´ç”Ÿã¨6å¹´ç”Ÿã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadElementaryStudents() {
  try {
    console.log('å°å­¦5ãƒ»6å¹´ç”Ÿã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    const response = await fetch(getApiUrl('/api/teacher/students'), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('å–å¾—ã—ãŸç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿:', data);
    
    if (data.success && data.students) {
      // å°å­¦5å¹´ç”Ÿã¨6å¹´ç”Ÿã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const elementaryStudents = data.students.filter(student => 
        student.grade && (student.grade === 'å°å­¦5å¹´' || student.grade === 'å°å­¦6å¹´')
      );
      
      console.log(`å°å­¦5ãƒ»6å¹´ç”Ÿ: ${elementaryStudents.length}äºº`);
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ç”Ÿå¾’é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      const calendarStudentSelect = document.getElementById('calendar-student-select');
      if (calendarStudentSelect) {
        calendarStudentSelect.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠ</option>';
        elementaryStudents.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.grade} ${student.last_name} ${student.first_name}`;
          calendarStudentSelect.appendChild(option);
        });
      }      // å®¿é¡Œå‡ºé¡Œç”¨ã®ç”Ÿå¾’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
      const studentCheckboxContainer = document.getElementById('student-checkbox-container');
      if (studentCheckboxContainer) {
        studentCheckboxContainer.innerHTML = '';
        
        elementaryStudents.forEach(student => {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.className = 'modern-checkbox-label';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `student-${student.id}`;
          checkbox.value = student.id;
          checkbox.className = 'student-checkbox';
          
          const label = document.createElement('label');
          label.htmlFor = `student-${student.id}`;
          label.textContent = `${student.grade} ${student.last_name} ${student.first_name}`;
          
          checkboxDiv.appendChild(checkbox);
          checkboxDiv.appendChild(label);
          studentCheckboxContainer.appendChild(checkboxDiv);
        });
        
        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        const selectAllCheckbox = document.getElementById('select-all-students');
        if (selectAllCheckbox) {
          selectAllCheckbox.removeEventListener('change', handleSelectAll);
          selectAllCheckbox.addEventListener('change', handleSelectAll);
        }
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ç”Ÿå¾’é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
      const filterStudentSelect = document.getElementById('filter-student-select');
      if (filterStudentSelect) {
        filterStudentSelect.innerHTML = '<option value="">å…¨ã¦ã®ç”Ÿå¾’</option>';
        elementaryStudents.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.grade} ${student.last_name} ${student.first_name}`;
          filterStudentSelect.appendChild(option);
        });
      }
      
      console.log('âœ… å°å­¦5ãƒ»6å¹´ç”Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
      return elementaryStudents;
      
    } else {
      throw new Error(data.message || 'ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    const errorElements = [
      document.getElementById('calendar-student-select'),
      document.getElementById('student-checkbox-container'),
      document.getElementById('filter-student-select')
    ];
    
    errorElements.forEach(element => {
      if (element) {
        if (element.tagName === 'SELECT') {
          element.innerHTML = '<option value="">èª­ã¿è¾¼ã¿å¤±æ•—</option>';
        } else {
          element.innerHTML = '<div style="color: #dc3545; padding: 10px;">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
      }
    });
    
    throw error; // å‘¼ã³å‡ºã—å…ƒã«ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
  }
}

// å®¿é¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadHomeworkTemplates() {
  try {
    console.log('å®¿é¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    const response = await fetch(getApiUrl('/api/teacher/homework/templates'), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('å–å¾—ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿:', data);
    
    const templatesContainer = document.getElementById('homework-templates');
    if (templatesContainer) {
      templatesContainer.innerHTML = '';
      
      if (data.success && data.templates && data.templates.length > 0) {
        data.templates.forEach(template => {
          const templateDiv = document.createElement('div');
          templateDiv.className = 'template-item';
          templateDiv.innerHTML = `
            <h6>${template.subject} - ${template.textbook}</h6>
            <p>${template.topic} (${template.pages})</p>
            <small>æœ€è¿‘ä½¿ç”¨: ${template.last_used || 'ä¸æ˜'}</small>
          `;
          
          templateDiv.addEventListener('click', () => {
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('subject-select').value = template.subject;
            document.getElementById('textbook-input').value = template.textbook;
            document.getElementById('topic-input').value = template.topic;
            document.getElementById('pages-input').value = template.pages;
          });
          
          templatesContainer.appendChild(templateDiv);
        });
      } else {
        templatesContainer.innerHTML = '<p style="text-align: center; color: #999;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
      }
    }
    
  } catch (error) {
    console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    const templatesContainer = document.getElementById('homework-templates');
    if (templatesContainer) {
      templatesContainer.innerHTML = '<p style="text-align: center; color: #dc3545;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
    }
  }
}

// ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç”¨ã®å€™è£œã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadAutocompleteSuggestions() {
  try {
    const response = await fetch(getApiUrl('/api/teacher/homework/suggestions'), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.success) {
        // ãƒ†ã‚­ã‚¹ãƒˆåã®å€™è£œ
        const textbookList = document.getElementById('textbook-list');
        if (textbookList && data.textbooks) {
          textbookList.innerHTML = '';
          data.textbooks.forEach(textbook => {
            const option = document.createElement('option');
            option.value = textbook;
            textbookList.appendChild(option);
          });
        }
        
        // é …ç›®ãƒ»å˜å…ƒã®å€™è£œ
        const topicList = document.getElementById('topic-list');
        if (topicList && data.topics) {
          topicList.innerHTML = '';
          data.topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            topicList.appendChild(option);
          });
        }
      }
    }
  } catch (error) {
    console.error('ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå€™è£œã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// å®¿é¡Œãƒã‚§ãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadHomeworkForCheck() {
  try {
    const studentFilter = document.getElementById('check-student-filter').value;
    const dateFrom = document.getElementById('check-date-from').value;
    const dateTo = document.getElementById('check-date-to').value;
    
    const params = new URLSearchParams();
    if (studentFilter) params.append('student_id', studentFilter);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    
    const response = await fetch(getApiUrl(`/api/teacher/homework/list?${params}`), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      displayHomeworkList(data.homework);
    } else {
      throw new Error(data.message || 'å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å®¿é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    const container = document.getElementById('homework-check-list');
    if (container) {
      container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }
}

// å®¿é¡Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayHomeworkList(homeworkList) {
  const container = document.getElementById('homework-check-list');
  if (!container) return;
  
  if (!homeworkList || homeworkList.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">è©²å½“ã™ã‚‹å®¿é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  let html = '<div class="homework-list">';
  
  homeworkList.forEach(homework => {
    const isCompleted = homework.completed;
    const statusClass = isCompleted ? 'completed' : 'pending';
    const actionButton = isCompleted 
      ? '<button class="homework-action-btn undo modern-btn-outline" data-assignment-id="' + homework.id + '" data-student-id="' + homework.student_id + '" onclick="handleHomeworkCheck(event)">' +
           '<i class="fas fa-undo"></i> å®Œäº†å–æ¶ˆ' +
         '</button>'
      : '<button class="homework-action-btn complete modern-btn-primary" data-assignment-id="' + homework.id + '" data-student-id="' + homework.student_id + '" onclick="handleHomeworkCheck(event)">' +
           '<i class="fas fa-check"></i> å®Œäº†' +
         '</button>';
    
    html += 
      '<div class="homework-item ' + statusClass + '">' +
        '<div class="homework-info">' +
          '<h6>' + (homework.student_name || 'ä¸æ˜') + '</h6>' +
          '<p><strong>' + homework.subject + '</strong> - ' + homework.textbook + '</p>' +
          '<p>' + homework.topic + ' (' + homework.pages + ')</p>' +
          '<small>æ—¥ä»˜: ' + homework.assigned_date + '</small>' +
        '</div>' +
        '<div class="homework-actions">' +
          actionButton +
        '</div>' +
      '</div>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadStudentsForFilter() {
  try {
    const response = await fetch(getApiUrl('/api/teacher/students?grade_level=5,6&school_type=elementary'), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success && data.students) {
      const filterSelect = document.getElementById('check-student-filter');
      if (filterSelect) {
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã€Œå…¨ç”Ÿå¾’ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒ)
        filterSelect.innerHTML = '<option value="">å…¨ç”Ÿå¾’</option>';
        
        data.students.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.grade} ${student.last_name} ${student.first_name}`;
          filterSelect.appendChild(option);
        });
      }
    }
    
  } catch (error) {
    console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¨­å®š
  const today = new Date();
  currentYear = today.getFullYear();
  currentMonth = today.getMonth();
  
  document.getElementById('assignment-date').value = today.toISOString().split('T')[0];
  document.getElementById('check-date-from').value = today.toISOString().split('T')[0];
  document.getElementById('check-date-to').value = today.toISOString().split('T')[0];
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  const filterBtn = document.getElementById('filter-btn');
  if (filterBtn) {
    filterBtn.addEventListener('click', loadHomeworkForCheck);
  }
  
  // å°å­¦5å¹´ç”Ÿã¨6å¹´ç”Ÿã®ç”Ÿå¾’ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå®Œäº†å¾Œã«åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºï¼‰
  loadElementaryStudents().then(() => {
    console.log('âœ… ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–');
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã¿
    loadStudentsForFilter();
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯å³åº§ã«æ›´æ–°ã‚’è©¦è¡Œ
    const activeTab = document.querySelector('.modern-tab-btn.active');
    if (activeTab && activeTab.dataset.tab === 'calendar') {
      setTimeout(() => {
        const studentSelect = document.getElementById('calendar-student-select');
        if (studentSelect.value && studentSelect.value !== '') {
          console.log('ğŸ”„ è‡ªå‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°é–‹å§‹');
          selectedStudentId = studentSelect.value;
          renderTeacherCalendar(currentYear, currentMonth);
        }
      }, 100); // çŸ­ã„é…å»¶ã§ç¢ºå®Ÿã«DOMæ›´æ–°å¾Œã«å®Ÿè¡Œ
    }
  });
    // åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const calendar = document.getElementById('teacher-homework-calendar');
  calendar.innerHTML = '<p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';

  // ãƒšãƒ¼ã‚¸ã®å¯è¦–æ€§å¤‰æ›´æ™‚ã®è‡ªå‹•æ›´æ–°ï¼ˆè¬›å¸«ãŒãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ããŸæ™‚ãªã©ï¼‰
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      console.log('ğŸ“„ ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºçŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸ - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ãƒã‚§ãƒƒã‚¯');
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ç”Ÿå¾’ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
      const activeTab = document.querySelector('.modern-tab-btn.active');
      if (activeTab && activeTab.dataset.tab === 'calendar' && selectedStudentId) {
        console.log('ğŸ”„ å¯è¦–æ€§å¤‰æ›´ã«ã‚ˆã‚‹è‡ªå‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°');
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å¼·åˆ¶æ›´æ–°
        homeworkData = {};
        
        const calendar = document.getElementById('teacher-homework-calendar');
        calendar.innerHTML = '<div style="text-align: center; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...</div>';
        
        renderTeacherCalendar(currentYear, currentMonth)
          .catch(error => {
            console.error('å¯è¦–æ€§å¤‰æ›´æ™‚ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          });
      }
    }
  });

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.modern-tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.modern-tab-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.modern-tab-content, .tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');      // ã‚¿ãƒ–ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      if (tabName === 'calendar') {
        console.log('ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–:', selectedStudentId);
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–ã®å ´åˆã¯å³åº§ã«çŠ¶æ…‹ç¢ºèª
        const studentSelect = document.getElementById('calendar-student-select');
        const currentStudentId = studentSelect.value;
        
        if (!currentStudentId || currentStudentId === '') {
          const calendar = document.getElementById('teacher-homework-calendar');
          calendar.innerHTML = '<p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
          console.log('ğŸ“… ç”Ÿå¾’æœªé¸æŠã®ãŸã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º');
        } else {
          // ç”Ÿå¾’ãŒé¸æŠæ¸ˆã¿ã®å ´åˆã¯å³åº§ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°
          selectedStudentId = currentStudentId;
          console.log('ğŸ”„ æ—¢é¸æŠç”Ÿå¾’ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å³æ™‚æ›´æ–°:', selectedStudentId);
          
          const calendar = document.getElementById('teacher-homework-calendar');
          calendar.innerHTML = '<div style="text-align: center; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';
            renderTeacherCalendar(currentYear, currentMonth)
            .catch(error => {
              console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ã‚¨ãƒ©ãƒ¼:', error);
              calendar.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
        }
      } else if (tabName === 'assign') {
        loadHomeworkTemplates();
        loadAutocompleteSuggestions();      } else if (tabName === 'check') {
        loadHomeworkForCheck();
        loadStudentsForFilter(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚‚èª­ã¿è¾¼ã¿
      } else if (tabName === 'history') {
        loadHomeworkHistory();
      }
    });
  });
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç”Ÿå¾’é¸æŠ
  document.getElementById('calendar-student-select').addEventListener('change', function() {
    const newStudentId = this.value;
    const selectedStudentName = this.options[this.selectedIndex]?.text || 'æœªé¸æŠ';
    console.log('ğŸ¯ ç”Ÿå¾’é¸æŠå¤‰æ›´:', newStudentId, selectedStudentName);
    
    selectedStudentId = newStudentId;
    
    if (selectedStudentId) {
      console.log('ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–‹å§‹:', currentYear, currentMonth);
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆå³åº§ã«ï¼‰
      const calendar = document.getElementById('teacher-homework-calendar');
      calendar.innerHTML = '<div style="text-align: center; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      // å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
      homeworkData = {};
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆå¼·åˆ¶å®Ÿè¡Œï¼‰
      renderTeacherCalendar(currentYear, currentMonth)
        .catch(error => {
          console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ã‚¨ãƒ©ãƒ¼:', error);
          calendar.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    } else {
      console.log('ğŸ“… ç”Ÿå¾’æœªé¸æŠã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¯ãƒªã‚¢');
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const calendar = document.getElementById('teacher-homework-calendar');
      calendar.innerHTML = '<p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
      // å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
      homeworkData = {};
    }
  });
    // æœˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
  document.getElementById('prev-month-btn').addEventListener('click', function() {
    if (!selectedStudentId) {
      alert('å…ˆã«ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    const calendar = document.getElementById('teacher-homework-calendar');
    calendar.innerHTML = '<div style="text-align: center; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    renderTeacherCalendar(currentYear, currentMonth)
      .catch(error => {
        console.error('æœˆåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
        calendar.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
  });
  
  document.getElementById('next-month-btn').addEventListener('click', function() {
    if (!selectedStudentId) {
      alert('å…ˆã«ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    if (selectedStudentId) {
      renderTeacherCalendar(currentYear, currentMonth);
    }
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  document.querySelector('.close-modal').addEventListener('click', function() {
    document.getElementById('homework-check-modal').style.display = 'none';
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('homework-check-modal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }  });
    // å®¿é¡Œç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
  document.getElementById('homework-assign-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // é¸æŠã•ã‚ŒãŸç”Ÿå¾’IDsã‚’å–å¾—
    const selectedStudents = [];
    document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
      selectedStudents.push(checkbox.value);
    });

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    const formData = {
      student_ids: selectedStudents, // é…åˆ—ã§é€ä¿¡
      assigned_date: document.getElementById('assignment-date').value,
      subject: document.getElementById('subject-select').value,
      textbook: document.getElementById('textbook-input').value,
      topic: document.getElementById('topic-input').value,
      pages: document.getElementById('pages-input').value
    };
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.student_ids || formData.student_ids.length === 0) {
      alert('ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!formData.assigned_date) {
      alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
      document.getElementById('assignment-date').focus();
      return;
    }
    
    if (!formData.subject) {
      alert('æ•™ç§‘ã‚’é¸æŠã—ã¦ãã ã•ã„');
      document.getElementById('subject-select').focus();
      return;
    }
    
    if (!formData.textbook || formData.textbook.trim() === '') {
      alert('ãƒ†ã‚­ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      document.getElementById('textbook-input').focus();
      return;
    }
    
    if (!formData.topic || formData.topic.trim() === '') {
      alert('é …ç›®ãƒ»å˜å…ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      document.getElementById('topic-input').focus();
      return;
    }
      // æ—¥ä»˜ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    const assignedDate = new Date(formData.assigned_date);
    const currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);
    
    if (assignedDate < currentDate) {
      const confirm_past = confirm('éå»ã®æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ');
      if (!confirm_past) {
        document.getElementById('assignment-date').focus();
        return;
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒˆãƒªãƒ 
    formData.textbook = formData.textbook.trim();
    formData.topic = formData.topic.trim();
    formData.pages = formData.pages.trim();
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»éŒ²ä¸­...';
    
    // APIå‘¼ã³å‡ºã—
    secureFetch(getApiUrl('/api/teacher/homework/assign'), {
      method: 'POST',
      body: JSON.stringify(formData)
    })    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const studentCount = formData.student_ids.length;
        alert(`${studentCount}äººã®ç”Ÿå¾’ã«å®¿é¡Œã‚’ä¸€æ‹¬ç™»éŒ²ã—ã¾ã—ãŸï¼`);
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        this.reset();
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        document.querySelectorAll('.student-checkbox').forEach(checkbox => {
          checkbox.checked = false;
        });
        document.getElementById('select-all-students').checked = false;
        
        // æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
        const nowDate = new Date();
        document.getElementById('assignment-date').value = nowDate.toISOString().split('T')[0];
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°
        loadHomeworkTemplates();
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¼·åˆ¶æ›´æ–°
        if (selectedStudentId && formData.student_ids.includes(selectedStudentId)) {
          console.log('ğŸ”„ å®¿é¡Œç™»éŒ²å¾Œã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¼·åˆ¶æ›´æ–°é–‹å§‹');
          homeworkData = {}; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          fetchTeacherHomeworkData(currentYear, currentMonth);
        }
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('å®¿é¡Œã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .finally(() => {
      // ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  });
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ãƒœã‚¿ãƒ³
  document.getElementById('save-template-btn').addEventListener('click', function() {
    // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ');
  });
});

// å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
function handleSelectAll(event) {
  const isChecked = event.target.checked;
  const studentCheckboxes = document.querySelectorAll('.student-checkbox');
  
  studentCheckboxes.forEach(checkbox => {
    checkbox.checked = isChecked;
  });
  
  console.log(`${isChecked ? 'å…¨é¸æŠ' : 'å…¨è§£é™¤'}ã—ã¾ã—ãŸ`);
}

// å®¿é¡Œå®Œäº†/å–ã‚Šæ¶ˆã—å‡¦ç†
async function handleHomeworkCheck(event) {
  const button = event.target.closest('.homework-action-btn');
  const assignmentId = button.dataset.assignmentId;
  const studentId = button.dataset.studentId;
  const isCompleting = button.classList.contains('complete');
  
  const action = isCompleting ? 'å®Œäº†' : 'å®Œäº†å–æ¶ˆ';
  if (!confirm(`ã“ã®å®¿é¡Œã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }
  
  try {
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡¦ç†ä¸­...';
    
    let response;
    
    if (isCompleting) {
      // å®Œäº†å‡¦ç†
      response = await fetch(getApiUrl(`/api/teacher/homework/complete`), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          assignment_id: assignmentId,
          student_id: studentId,
          points: 10
        })
      });
    } else {
      // å®Œäº†å–ã‚Šæ¶ˆã—å‡¦ç†
      response = await fetch(getApiUrl(`/api/teacher/homework/undo-complete/${assignmentId}`), {
        method: 'DELETE',
        credentials: 'same-origin'
      });
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert(`å®¿é¡Œã‚’${action}ã—ã¾ã—ãŸï¼`);
      // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      loadHomeworkForCheck();
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚æ›´æ–°ï¼ˆè©²å½“ç”Ÿå¾’ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      if (selectedStudentId && selectedStudentId == studentId) {
        homeworkData = {}; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        renderTeacherCalendar(currentYear, currentMonth);
      }
    } else {
      throw new Error(data.message || `${action}ã«å¤±æ•—ã—ã¾ã—ãŸ`);
    }  } catch (error) {
    console.error(`å®¿é¡Œ${action}ã‚¨ãƒ©ãƒ¼:`, error);
    alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    // ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
    button.disabled = false;    if (isCompleting) {
      button.innerHTML = '<i class="fas fa-check"></i> å®Œäº†';
    } else {
      button.innerHTML = '<i class="fas fa-undo"></i> å®Œäº†å–æ¶ˆ';
    }
  }
}

// å®¿é¡Œã®å®Œäº†ã‚’å–ã‚Šæ¶ˆã™é–¢æ•°
async function undoHomeworkCompletion(assignmentId, studentId) {
  if (!confirm('ã“ã®å®¿é¡Œã®å®Œäº†çŠ¶æ…‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nä»˜ä¸ã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆã‚‚å–ã‚Šæ¶ˆã•ã‚Œã¾ã™ã€‚')) {
    return;
  }
  
  try {
    const response = await fetch(getApiUrl(`/api/teacher/homework/undo-complete/${assignmentId}`), {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert('å®¿é¡Œã®å®Œäº†çŠ¶æ…‹ã‚’å–ã‚Šæ¶ˆã—ã€ãƒã‚¤ãƒ³ãƒˆã‚’èª¿æ•´ã—ã¾ã—ãŸ');
      // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
      loadHomeworkHistory();
      // ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
      loadHomeworkForCheck();
    } else {
      throw new Error(data.message || 'å®Œäº†å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å®Œäº†å–ã‚Šæ¶ˆã—ã‚¨ãƒ©ãƒ¼:', error);
    alert('å®Œäº†å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// å®¿é¡Œã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
async function deleteHomeworkAssignment(assignmentId, studentName) {
  if (!confirm(`${studentName}ã®å®¿é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
    return;
  }
  
  try {
    const response = await fetch(getApiUrl(`/api/teacher/homework/delete/${assignmentId}`), {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert('å®¿é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
      loadHomeworkHistory();
      // ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
      loadHomeworkForCheck();
    } else {
      throw new Error(data.message || 'å®¿é¡Œå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å®¿é¡Œå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    alert('å®¿é¡Œå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// å®¿é¡Œå±¥æ­´ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadHomeworkHistory() {
  try {
    const response = await fetch(getApiUrl('/api/teacher/homework/history'), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      displayHomeworkHistory(data);
    } else {
      throw new Error(data.message || 'å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å±¥æ­´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    const tbody = document.getElementById('history-tbody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
    }
  }
}

// å®¿é¡Œå±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayHomeworkHistory(data) {
  // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
  const stats = data.statistics || {};
  document.getElementById('monthly-assignments').textContent = stats.total_assigned || 0;
  document.getElementById('completion-rate').textContent = `${stats.completion_rate || 0}%`;
  document.getElementById('total-points').textContent = stats.total_completed || 0;
  
  // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
  const tbody = document.getElementById('history-tbody');
  if (!tbody) return;
  
  if (!data.history || data.history.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
    let html = '';
  data.history.forEach(item => {
    const statusBadge = item.completed 
      ? '<span class="status-badge completed"><i class="fas fa-check"></i> å®Œäº†</span>'
      : '<span class="status-badge pending"><i class="fas fa-clock"></i> æœªå®Œäº†</span>';
    
    const rowClass = item.completed ? 'completed-row' : 'pending-row';
    
    // æ“ä½œãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const actionButtons = `
      <div class="history-actions">
        ${item.completed 
          ? `<button class="btn btn-sm btn-warning" onclick="undoHomeworkCompletion(${item.id}, ${item.student_id})" title="å®Œäº†å–æ¶ˆ">
               <i class="fas fa-undo"></i>
             </button>` 
          : ''}

        <button class="btn btn-sm btn-danger" onclick="deleteHomeworkAssignment(${item.id}, '${item.student_name}')" title="å®¿é¡Œå‰Šé™¤">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    
    html += `

      <tr class="${rowClass}">
        <td>${item.assigned_date}</td>
        <td>${item.student_name || 'ä¸æ˜'}</td>
        <td>${item.subject}</td>
        <td>${item.textbook}</td>
        <td>${item.topic}</td>
        <td>${item.pages}</td>
        <td>${statusBadge}</td>
        <td>${item.points_awarded || 0}</td>
        <td>${actionButtons}</td>
      </tr>
    `;
  });
    tbody.innerHTML = html;
}

// å®¿é¡Œã®å®Œäº†ã‚’å–ã‚Šæ¶ˆã™é–¢æ•°
async function undoHomeworkCompletion(assignmentId, studentId) {
  if (!confirm('ã“ã®å®¿é¡Œã®å®Œäº†çŠ¶æ…‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nä»˜ä¸ã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆã‚‚å–ã‚Šæ¶ˆã•ã‚Œã¾ã™ã€‚')) {
    return;
  }
  
  try {
    const response = await fetch(getApiUrl(`/api/teacher/homework/undo-complete/${assignmentId}`), {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
      if (data.success) {
      alert('å®¿é¡Œã®å®Œäº†çŠ¶æ…‹ã‚’å–ã‚Šæ¶ˆã—ã€ãƒã‚¤ãƒ³ãƒˆã‚’èª¿æ•´ã—ã¾ã—ãŸ');
      // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
      loadHomeworkHistory();
      // ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
      loadHomeworkForCheck();
    } else {
      throw new Error(data.message || 'å®Œäº†å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å®Œäº†å–ã‚Šæ¶ˆã—ã‚¨ãƒ©ãƒ¼:', error);
    alert('å®Œäº†å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®å¤‰æ•°ã¨ãƒ‡ãƒ¼ã‚¿ */
let homeworkData = {};

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹é–¢æ•° */
async function renderTeacherCalendar(year, month) {
  try {
    console.log(`ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–‹å§‹: ${year}å¹´${month + 1}æœˆ, ç”Ÿå¾’ID: ${selectedStudentId}`);
    
    if (!selectedStudentId) {
      console.log('âŒ ç”Ÿå¾’ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    // æœˆè¡¨ç¤ºã‚’æ›´æ–°
    const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    document.getElementById('current-month-display').textContent = `${year}å¹´ ${monthNames[month]}`;
    
    // å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    await fetchTeacherHomeworkData(year, month);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
    const calendar = document.getElementById('teacher-homework-calendar');
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '';
    
        // ãƒ˜ãƒƒãƒ€ãƒ¼
    const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    dayNames.forEach(day => {
      html += '<div class="calendar-header">' + day + '</div>';
    });
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < 42; i++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + i);
      
      const dateStr = currentDate.toISOString().split('T')[0];
      const isCurrentMonth = currentDate.getMonth() === month;
      const isToday = currentDate.getTime() === today.getTime();
      
      let dayClass = 'calendar-day';
      if (!isCurrentMonth) dayClass += ' empty';
      if (isToday) dayClass += ' today';
      
      let homeworkHtml = '';
      const homeworkForDate = homeworkData[dateStr];
      
      if (isCurrentMonth && homeworkForDate && homeworkForDate.length > 0) {
        homeworkForDate.forEach(homework => {
          const statusClass = homework.completed ? 'completed' : 'pending';
          const icon = homework.completed ? 'fa-check-circle' : 'fa-clock';
          
          homeworkHtml += 
            '<div class="homework-indicator ' + statusClass + '">' +
              '<i class="fas ' + icon + '"></i>' +
              '<span>' + homework.subject + '</span>' +
            '</div>';
        });
      }
      
      html += 
        '<div class="' + dayClass + '" data-date="' + dateStr + '" onclick="openHomeworkModal(\'' + dateStr + '\')">' +
          '<div class="date-number">' + currentDate.getDate() + '</div>' +
          '<div class="homework-indicators">' + homeworkHtml + '</div>' +        '</div>';
    }
    
    calendar.innerHTML = html;
    console.log('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»å®Œäº†');
    
  } catch (error) {
    console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ã‚¨ãƒ©ãƒ¼:', error);
    const calendar = document.getElementById('teacher-homework-calendar');
    calendar.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 50px; grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
async function fetchTeacherHomeworkData(year, month) {
  try {
    if (!selectedStudentId) {
      console.log('âŒ ç”Ÿå¾’IDãŒæœªé¸æŠ');
      return;
    }
    
    const params = new URLSearchParams({
      year: year,
      month: month + 1,
      student_id: selectedStudentId
    });
    
    const response = await fetch(getApiUrl(`/api/teacher/homework/calendar?${params}`), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
    
    const data = await response.json();
    if (data.success) {
      homeworkData = data.homework || {};
      console.log('ğŸ“Š å®¿é¡Œãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', Object.keys(homeworkData).length, 'æ—¥åˆ†');
    } else {
      throw new Error(data.message || 'å®¿é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('å®¿é¡Œãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    homeworkData = {};
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
function openHomeworkModal(dateStr) {
  const homeworkForDate = homeworkData[dateStr];
  if (!homeworkForDate || homeworkForDate.length === 0) {
    return;
  }
  
  const modal = document.getElementById('homework-check-modal');
  const date = new Date(dateStr);
  const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
  
  document.getElementById('modal-student-date').textContent = 
    `${date.getFullYear()}å¹´${monthNames[date.getMonth()]}${date.getDate()}æ—¥ã®å®¿é¡Œ`;
  
  let html = '';
  homeworkForDate.forEach(homework => {
    const isCompleted = homework.completed;
    const statusClass = isCompleted ? 'completed' : 'pending';
    const actionButton = isCompleted 
      ? '<button class="homework-action-btn undo modern-btn-outline" data-assignment-id="' + homework.id + '" data-student-id="' + homework.student_id + '" onclick="handleHomeworkCheck(event)">' +
           '<i class="fas fa-undo"></i> å®Œäº†å–æ¶ˆ' +
         '</button>'
      : '<button class="homework-action-btn complete modern-btn-primary" data-assignment-id="' + homework.id + '" data-student-id="' + homework.student_id + '" onclick="handleHomeworkCheck(event)">' +
           '<i class="fas fa-check"></i> å®Œäº†' +
         '</button>';
    
    html += 
      '<div class="homework-detail-item ' + statusClass + '">' +
        '<div class="homework-info">' +
          '<h6>' + homework.subject + ' - ' + homework.textbook + '</h6>' +
          '<p>' + homework.topic + ' (' + homework.pages + ')</p>' +
        '</div>' +
        '<div class="homework-actions">' +
          actionButton +
        '</div>' +
      '</div>';
  });
  
  document.getElementById('homework-check-list').innerHTML = html;
  modal.style.display = 'flex';
}
</script>

{% endblock %}
