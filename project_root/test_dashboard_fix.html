<!DOCTYPE html>
<html>
<head>
    <title>Dashboard API Test</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Dashboard API Test</h1>
    <button onclick="testAPI()">Test API</button>
    <pre id="result"></pre>
    
    <script>
    async function testAPI() {
        const resultDiv = document.getElementById('result');
        resultDiv.textContent = 'Testing...';
        
        try {
            // Test 1: Direct API call
            console.log('Test 1: Direct API call');
            const response1 = await fetch('/myapp/index.cgi/api/teacher/students', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            const contentType1 = response1.headers.get('content-type');
            const text1 = await response1.text();
            
            console.log('Response headers:', contentType1);
            console.log('Response text length:', text1.length);
            console.log('First 200 chars:', text1.substring(0, 200));
            
            // Try to parse JSON
            try {
                const json1 = JSON.parse(text1);
                console.log('JSON parsed successfully:', json1);
                resultDiv.textContent += '\nTest 1: SUCCESS - JSON parsed\n' + JSON.stringify(json1, null, 2);
            } catch (e) {
                console.error('JSON parse error:', e);
                console.error('Error position:', e.message);
                
                // Find where JSON starts
                const jsonStart = text1.indexOf('{');
                if (jsonStart > 0) {
                    console.error('Text before JSON:', text1.substring(0, jsonStart));
                    resultDiv.textContent += '\nTest 1: FAILED - Extra content before JSON:\n' + text1.substring(0, jsonStart);
                } else {
                    resultDiv.textContent += '\nTest 1: FAILED - ' + e.message;
                }
            }
            
            // Test 2: Static file access
            console.log('\nTest 2: Static file access');
            const response2 = await fetch('/myapp/index.cgi/static/js/csrf_utils_safe.js');
            console.log('Static file response:', response2.status, response2.statusText);
            resultDiv.textContent += '\n\nTest 2: Static file status: ' + response2.status;
            
        } catch (error) {
            console.error('Test error:', error);
            resultDiv.textContent = 'Error: ' + error.message;
        }
    }
    </script>
</body>
</html>